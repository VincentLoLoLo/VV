<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神秘客預約系統</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* 自訂 Škoda 品牌顏色 */
        :root {
            --skoda-green: #4F9D3C;
            --skoda-dark-green: #0E3B33;
            --skoda-text: #2E2E2E;
            --skoda-light-gray: #F5F5F5;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--skoda-light-gray);
            color: var(--skoda-text);
        }
        
        .skoda-button {
            background-color: var(--skoda-green);
            color: white;
            transition: background-color 0.3s ease;
        }
        .skoda-button:hover {
            background-color: #3e8e2c;
        }
        
        .skoda-button-outline {
            border: 1px solid #D1D5DB; /* gray-300 */
            color: var(--skoda-text);
            transition: background-color 0.3s ease;
        }
        .skoda-button-outline:hover {
            background-color: #F9FAFB; /* gray-50 */
        }
        
        .skoda-link {
            color: var(--skoda-green);
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .skoda-link:hover {
            color: var(--skoda-dark-green);
        }

        /* 隱藏滾動條但仍可滾動 */
        .modal-body::-webkit-scrollbar,
        .page-scroll::-webkit-scrollbar {
            display: none;
        }
        .modal-body,
        .page-scroll {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* 簡易載入動畫 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--skoda-green);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        /* 頁面切換導航樣式 */
        .nav-link {
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s ease, color 0.3s ease;
            padding-bottom: 4px;
        }
        .nav-link.active {
            border-bottom-color: var(--skoda-green);
            color: var(--skoda-green);
        }
        .nav-link:hover:not(.active) {
            color: #000;
        }

        .brand-directory-group {
            border: 1px solid #E5E7EB;
            border-radius: 1rem;
            padding: 0.85rem 1rem;
            background-color: #FFFFFF;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .brand-directory-group[open] {
            border-color: #A7F3D0;
            box-shadow: 0 18px 36px -28px rgba(16, 185, 129, 0.55);
        }

        .brand-directory-group + .brand-directory-group {
            margin-top: 1rem;
        }

        .brand-directory-group > summary::-webkit-details-marker {
            display: none;
        }

        .brand-directory-toggle {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.75rem;
            cursor: pointer;
            list-style: none;
            width: 100%;
        }

        .brand-directory-toggle:focus {
            outline: none;
        }

        .brand-directory-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .brand-directory-toggle .collapse-icon {
            transition: transform 0.2s ease;
        }

        .brand-directory-group:not([open]) .collapse-icon {
            transform: rotate(-90deg);
        }

        .brand-directory-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .brand-directory-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid transparent;
            background-color: #F9FAFB;
            transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
        }

        .brand-directory-item button {
            color: var(--skoda-green);
            font-weight: 600;
        }

        .brand-directory-item:hover {
            background-color: #ECFDF5;
            border-color: #A7F3D0;
            transform: translateX(2px);
        }

        .brand-directory-item[data-active="true"] {
            border-color: var(--skoda-green);
            background-color: #D1FAE5;
        }

        .accent-button {
            color: #ffffff;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }

        .accent-button:hover {
            transform: translateY(-1px);
        }

        .accent-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .accent-badge {
            color: #ffffff;
            transition: transform 0.2s ease;
        }

        .brand-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            color: #ffffff;
            box-shadow: 0 12px 24px -16px rgba(0, 0, 0, 0.25);
        }

        .brand-availability {
            font-size: 0.8125rem;
            font-weight: 600;
        }

        .month-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .month-selector button {
            border-radius: 9999px;
            border: 1px solid #E5E7EB;
            padding: 0.5rem 1rem;
            font-weight: 600;
            font-size: 0.875rem;
            background-color: #F9FAFB;
            transition: all 0.2s ease;
        }

        .month-selector button:hover {
            background-color: #ECFDF5;
            border-color: #A7F3D0;
            color: var(--skoda-dark-green);
        }

        .month-selector button[aria-pressed="true"] {
            background-color: var(--skoda-green);
            border-color: var(--skoda-dark-green);
            color: #ffffff;
            box-shadow: 0 12px 24px -18px rgba(15, 118, 110, 0.4);
        }

        .monthly-brand-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .monthly-brand-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            border: 1px solid #E5E7EB;
            border-radius: 1rem;
            padding: 0.85rem 1rem;
            background-color: #F9FAFB;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .monthly-brand-item:hover {
            border-color: #A7F3D0;
            background-color: #ECFDF5;
            transform: translateY(-1px);
        }

        .monthly-brand-item[aria-pressed="true"] {
            border-color: var(--skoda-green);
            background-color: #D1FAE5;
            box-shadow: 0 16px 30px -18px rgba(79, 157, 60, 0.35);
        }

        .brand-session-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
        }

        .brand-session-card {
            border: 1px solid #E5E7EB;
            border-radius: 1rem;
            padding: 1rem;
            background-color: #F9FAFB;
            transition: all 0.2s ease;
        }

        .brand-session-card:hover {
            border-color: #A7F3D0;
            background-color: #ffffff;
            box-shadow: 0 10px 24px -20px rgba(15, 118, 110, 0.35);
        }
    </style>
</head>
<body class="antialiased">

    <!-- 頂部導航欄 -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <nav class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex-shrink-0 flex items-center">
                    <span class="text-2xl font-bold" style="color: var(--skoda-dark-green);">Mystery Shopper</span>
                    <span class="ml-2 text-xl font-semibold text-gray-700">預約系統</span>
                </div>
                
                <!-- 導航連結 (登入前) -->
                <div id="nav-logged-out" class="flex items-center space-x-6">
                    <a id="nav-link-login-page" class="nav-link active font-medium text-gray-700">
                        登入
                    </a>
                    <a id="nav-link-register-page" class="nav-link font-medium text-gray-700">
                        新成員註冊
                    </a>
                </div>
                
                <!-- 導航連結 (登入後) -->
                <div id="nav-logged-in" class="hidden items-center space-x-6">
                    <span id="welcome-message" class="text-gray-700"></span>
                    <a id="nav-link-brand-home" class="nav-link font-medium text-gray-700">
                        品牌首頁
                    </a>
                    <a id="logout-button" class="skoda-link">
                        登出
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- =================================================== -->
    <!-- 頁面 1: 登入 (預設顯示) -->
    <!-- =================================================== -->
    <main id="page-login" class="max-w-md mx-auto p-4 sm:p-6 lg:p-8 mt-10">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900 mb-6 text-center">神秘客登入</h1>
        <p class="text-gray-600 mb-8 text-center">請使用您註冊並通過審核的 Email 及密碼登入，並完成雙重驗證。</p>

        <form id="login-form" onsubmit="handleLoginSubmit(event)" class="bg-white p-8 rounded-2xl shadow-lg space-y-6">

            <!-- 登入錯誤訊息 -->
            <div id="login-error-container" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <p id="login-error-message"></p>
            </div>

            <!-- 步驟一：帳號密碼驗證 -->
            <div id="login-step-one" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="login-email" name="login-email" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="example@email.com">
                </div>

                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">密碼</label>
                    <input type="password" id="login-password" name="login-password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="請輸入密碼">
                </div>

                <p class="text-xs text-gray-500">若忘記密碼，請聯繫管理員協助重設。</p>
            </div>

            <!-- 步驟二：雙重驗證碼 -->
            <div id="login-step-two" class="hidden space-y-4">
                <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
                    <p id="login-step-two-message" class="text-sm"></p>
                </div>
                <div>
                    <label for="login-otp" class="block text-sm font-medium text-gray-700 mb-2">驗證碼</label>
                    <input type="text" id="login-otp" name="login-otp" inputmode="numeric" pattern="[0-9]*" maxlength="6" minlength="6" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="請輸入 6 位數驗證碼">
                    <p id="two-factor-hint" class="text-xs text-gray-500 mt-2"></p>
                </div>
            </div>

            <!-- 提交按鈕 -->
            <div class="pt-4 space-y-3">
                <button type="submit" id="login-submit-button" class="w-full skoda-button font-bold py-3 px-5 rounded-lg flex items-center justify-center text-lg">
                    <svg id="login-submit-loader" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="login-submit-text">下一步</span>
                </button>

                <button type="button" id="login-back-button" class="hidden w-full skoda-button-outline font-medium py-3 px-5 rounded-lg">
                    返回重新輸入帳號密碼
                </button>
            </div>

            <p class="text-sm text-center text-gray-600">
                還沒有帳號？
                <a onclick="showPage('register')" class="skoda-link">
                    點此立即註冊
                </a>
            </p>
        </form>
    </main>

    <!-- =================================================== -->
    <!-- 頁面 2: 品牌首頁 (登入後預設顯示) -->
    <!-- =================================================== -->
    <main id="page-brand-home" class="hidden max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
        <header class="space-y-3">
            <h1 class="text-3xl font-bold tracking-tight text-gray-900">選擇您要執行的品牌</h1>
            <p class="text-gray-600">左側支援搜尋與折疊列表，中央依月份展示品牌與場次，右側則提供品牌任務儀表板。</p>
        </header>

        <div class="grid lg:grid-cols-12 gap-6 lg:gap-8">
            <aside class="lg:col-span-3 space-y-6">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 space-y-4">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">搜尋品牌</h2>
                        <p class="text-sm text-gray-500 mt-2">輸入品牌或原產地關鍵字，快速縮小可執行任務範圍。</p>
                    </div>
                    <div class="relative">
                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1010.5 18a7.5 7.5 0 006.15-3.35z" />
                        </svg>
                        <input id="brand-search" type="search" placeholder="搜尋品牌、原產地或任務描述" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent shadow-sm" />
                    </div>
                    <p class="text-xs text-gray-500">支援即時篩選，與左側品牌折疊列表即時同步更新。</p>
                    <button type="button" id="reset-search-button" class="hidden skoda-button-outline font-medium w-full py-2.5 px-4 rounded-lg">清除搜尋條件</button>
                </div>

                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">品牌列表</h2>
                            <p class="text-sm text-gray-500 mt-1">依執行月份分組，可展開或收合列表並快速切換品牌。</p>
                        </div>
                    </div>
                    <div id="brand-directory" class="mt-4 space-y-5"></div>
                    <p id="brand-directory-empty" class="hidden text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-2xl p-4 text-center">找不到符合搜尋條件的品牌，請調整關鍵字或清除篩選。</p>
                </div>
            </aside>

            <section class="lg:col-span-5 space-y-6">
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                    <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide">執行月份</p>
                            <h2 id="month-card-title" class="text-2xl font-bold text-gray-900 mt-1">2025 年 11 月可執行品牌</h2>
                            <p id="month-card-summary" class="text-sm text-gray-500 mt-3">此區域會列出最近月份可執行的品牌，方便快速挑選任務。</p>
                        </div>
                        <div id="month-selector" class="month-selector"></div>
                    </div>
                    <div class="mt-6">
                        <div id="monthly-brand-list" class="monthly-brand-list"></div>
                        <p id="monthly-brand-empty" class="hidden text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-xl p-4 text-center">此月份暫無符合搜尋條件的品牌，請切換月份或調整關鍵字。</p>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                    <div class="flex flex-col gap-4">
                        <div>
                            <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide">品牌場次</p>
                            <h2 id="session-card-title" class="text-2xl font-bold text-gray-900 mt-1">請先選擇品牌</h2>
                            <p id="session-card-summary" class="text-sm text-gray-500 mt-3">選取上方品牌後，會依月份顯示可執行場次與地點。</p>
                        </div>
                        <div id="session-brand-months" class="month-selector hidden"></div>
                    </div>
                    <div id="brand-session-list" class="brand-session-list mt-6"></div>
                    <p id="brand-session-empty" class="hidden text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-xl p-4 text-center">此品牌在選定月份暫無安排，可切換其他月份或挑選不同品牌。</p>
                </div>
            </section>

            <section class="lg:col-span-4">
                <div id="brand-dashboard" class="bg-white rounded-2xl shadow-lg border border-gray-100">
                    <div class="p-6 pb-4 flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-500" id="brand-dashboard-breadcrumb">品牌首頁</p>
                            <h2 id="brand-dashboard-title" class="text-3xl font-bold tracking-tight text-gray-900">尚未選擇品牌</h2>
                            <p id="brand-dashboard-description" class="text-gray-600 mt-2">請先從中央的月份清單選擇品牌，這裡會顯示品牌任務重點與建議行程。</p>
                            <p id="brand-dashboard-meta" class="text-sm text-gray-500 mt-2"></p>
                        </div>
                        <button type="button" id="brand-dashboard-reset" class="hidden skoda-button-outline font-medium py-2.5 px-5 rounded-lg">
                            清除選擇
                        </button>
                    </div>
                    <div id="brand-dashboard-projects" class="p-6 pt-4 grid grid-cols-1 gap-6 border-t border-gray-100">
                        <p class="text-sm text-gray-500">尚未載入品牌任務，請先挑選品牌。</p>
                    </div>
                </div>
            </section>
        </div>

        <template id="project-card-template">
            <div class="project-card bg-white rounded-2xl shadow-lg p-6 flex flex-col justify-between border-t-4">
                <div>
                    <p class="text-sm font-semibold text-gray-500 mb-2 project-category"></p>
                    <h3 class="text-2xl font-bold text-gray-900 project-title"></h3>
                    <p class="text-gray-600 mt-3 project-summary"></p>
                    <div class="mt-4 bg-gray-50 border border-gray-100 rounded-lg p-4">
                        <p class="text-sm font-semibold text-gray-700">任務目標</p>
                        <p class="text-sm text-gray-600 mt-1 project-goal"></p>
                    </div>
                </div>
                <button type="button" class="mt-6 accent-button font-semibold py-2.5 px-4 rounded-lg flex items-center justify-center">
                    查看可預約時段
                </button>
            </div>
        </template>
    </main>

    <!-- =================================================== -->
    <!-- 頁面 4: 預約時段 (預設隱藏) -->
    <!-- =================================================== -->
    <main id="page-booking" class="hidden max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- 頁面標題 -->
        <p class="text-sm text-gray-500 mb-2" id="booking-breadcrumb"></p>
        <h1 id="booking-title" class="text-3xl font-bold tracking-tight text-gray-900 mb-2">可預約的時段</h1>
        <p id="booking-intro" class="text-gray-600 mb-4 hidden"></p>
        <div id="booking-context" class="hidden flex flex-wrap items-center gap-2 mb-4">
            <span id="booking-brand-chip" class="text-xs font-semibold tracking-wide px-3 py-1 rounded-full text-white uppercase"></span>
            <span id="booking-month-summary" class="text-xs text-gray-500"></span>
        </div>
        <div id="booking-goal" class="mb-6 bg-white border border-gray-100 rounded-2xl p-5 shadow-sm hidden">
            <p class="text-sm font-semibold text-gray-700">任務重點</p>
            <p id="booking-goal-text" class="text-sm text-gray-600 mt-2"></p>
        </div>
        
        <!-- 全螢幕載入指示 -->
        <div id="loading-container" class="flex flex-col items-center justify-center py-20">
            <div class="loader"></div>
            <p class="mt-4 text-gray-600">正在載入可預約時段...</p>
        </div>

        <!-- 錯誤訊息顯示區 -->
        <div id="error-container" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
            <strong class="font-bold">載入失敗！</strong>
            <span class="block sm:inline" id="error-message">無法從伺服器獲取資料，請稍後再試。</span>
        </div>

        <!-- 時段卡片容器 -->
        <div id="slots-container" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            
            <!-- JavaScript 渲染範本 (這是一個隱藏的範本) -->
            <template id="slot-card-template">
                <div class="slot-card bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-3">
                            <span class="data-project text-xl font-bold"></span>
                            <span class="data-month text-sm font-semibold px-3 py-1 rounded-full accent-badge"></span>
                        </div>
                        <p class="data-dealer text-base font-semibold text-gray-700"></p>
                        <p class="data-location text-sm text-gray-500 mb-4"></p>

                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <p class="text-sm font-semibold text-gray-800">任務重點：</p>
                            <p class="data-details text-sm text-gray-600"></p>
                        </div>

                        <button class="book-button w-full accent-button font-bold py-3 px-4 rounded-lg focus:outline-none">
                            立即預約
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <!-- =================================================== -->
    <!-- 頁面 3: 新成員註冊 (預設隱藏) -->
    <!-- =================================================== -->
    <main id="page-register" class="hidden max-w-2xl mx-auto p-4 sm:p-6 lg:p-8">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900 mb-6">神秘客新成員註冊</h1>
        <p class="text-gray-600 mb-8">感謝您加入我們的行列。請填寫以下詳細資料，我們將會進行審核，並在通過後與您聯繫。</p>

        <form id="registration-form" onsubmit="handleRegistrationSubmit(event)" class="bg-white p-8 rounded-2xl shadow-lg space-y-6">
            
            <!-- 姓名 -->
            <div>
                <label for="reg-name" class="block text-sm font-medium text-gray-700 mb-2">真實姓名</label>
                <input type="text" id="reg-name" name="reg-name" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="王大明">
                <p class="text-xs text-gray-500 mt-2">請填寫與身分證件相符的姓名，以便核對酬勞發放。</p>
            </div>
            
            <!-- Email -->
            <div>
                <label for="reg-email" class="block text-sm font-medium text-gray-700 mb-2">Email (登入帳號)</label>
                <input type="email" id="reg-email" name="reg-email" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="example@email.com">
            </div>

            <!-- 密碼 -->
            <div>
                <label for="reg-password" class="block text-sm font-medium text-gray-700 mb-2">設定登入密碼</label>
                <input type="password" id="reg-password" name="reg-password" required minlength="6"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="請輸入至少 6 碼密碼">
                <p class="text-xs text-gray-500 mt-2">建議使用英數混合密碼，後續登入需配合雙重驗證。</p>
            </div>

            <!-- 確認密碼 -->
            <div>
                <label for="reg-password-confirm" class="block text-sm font-medium text-gray-700 mb-2">確認密碼</label>
                <input type="password" id="reg-password-confirm" name="reg-password-confirm" required minlength="6"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="請再輸入一次密碼">
            </div>

            <!-- 電話 -->
            <div>
                <label for="reg-phone" class="block text-sm font-medium text-gray-700 mb-2">聯絡電話</label>
                <input type="tel" id="reg-phone" name="reg-phone" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="0912-345-678">
            </div>

            <!-- 銀行帳號 -->
            <div>
                <label for="reg-bank" class="block text-sm font-medium text-gray-700 mb-2">銀行帳號 (酬勞發放)</label>
                <input type="text" id="reg-bank" name="reg-bank" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="銀行代碼 (000) 帳號 (123456789)">
                <p class="text-xs text-gray-500 mt-2">我們承諾將妥善保管您的個資，僅用於酬勞發放。</p>
            </div>

            <!-- 提交按鈕 -->
            <div class="pt-4">
                <button type="submit" id="register-submit-button" class="w-full skoda-button font-bold py-3 px-5 rounded-lg flex items-center justify-center text-lg">
                    <svg id="register-submit-loader" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="register-submit-text">送出註冊申請</span>
                </button>
            </div>
            
            <p class="text-sm text-center text-gray-600">
                已經有帳號了？ 
                <a onclick="showPage('login')" class="skoda-link">
                    返回登入
                </a>
            </p>
        </form>
    </main>


    <!-- 
      預約彈出式表單 (Modal)
      - 預設為隱藏
    -->
    <div id="booking-modal" class="hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center p-4">
        
        <!-- Modal 內容卡片 -->
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-auto transition-all duration-300 transform scale-95" id="modal-card">
            
            <!-- Modal 標題 -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 id="modal-title" class="text-2xl font-bold">確認預約</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Modal 表單內容 -->
            <form id="booking-form" onsubmit="handleBookingSubmit(event)">
                <div class="p-6 space-y-5 modal-body max-h-[60vh] overflow-y-auto">
                    
                    <p class="text-gray-600">您即將預約的時段資訊如下，請確認無誤。</p>
                    
                    <!-- 預約資訊 -->
                    <div class="bg-gray-50 p-5 rounded-lg space-y-3">
                        <div>
                            <span class="text-sm font-medium text-gray-500">專案</span>
                            <p id="modal-project" class="text-lg font-semibold text-gray-900"></p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">經銷商</span>
                            <p id="modal-dealer" class="text-base text-gray-700"></p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">據點位置</span>
                            <p id="modal-location" class="text-base text-gray-700"></p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">執行月份</span>
                            <p id="modal-month" class="text-base text-gray-700"></p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">任務重點</span>
                            <p id="modal-details" class="text-base text-gray-700"></p>
                        </div>
                    </div>

                    <!-- Email (登入後自動帶入) -->
                    <div>
                        <label for="shopper-email" class="block text-sm font-medium text-gray-700 mb-2">預約 Email</label>
                        <input type="email" id="shopper-email" name="shopper-email" required readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none bg-gray-100 text-gray-500"
                               placeholder="example@email.com">
                        <p class="text-xs text-gray-500 mt-2">此為您登入的 Email，將用於寄送確認信。</p>
                    </div>

                    <!-- 隱藏的 slotID 欄位 -->
                    <input type="hidden" id="modal-slotID" name="slotID">
                </div>

                <!-- Modal 底部按鈕 -->
                <div class="p-6 bg-gray-50 rounded-b-2xl flex items-center justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="skoda-button-outline font-medium py-2.5 px-5 rounded-lg">
                        取消
                    </button>
                    <button type="submit" id="submit-button" class="skoda-button font-bold py-2.5 px-5 rounded-lg flex items-center justify-center">
                        <svg id="submit-loader" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="submit-text">確認送出預約</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      訊息提示框 (Message Box / Toast)
    -->
    <div id="message-box" class="hidden fixed top-20 right-5 z-50 max-w-sm w-full transition-all duration-300 opacity-0">
        <div id="message-content" class="p-4 rounded-lg shadow-lg text-white flex items-center">
            <svg id="message-icon-success" class="hidden w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <svg id="message-icon-error" class="hidden w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span id="message-text"></span>
        </div>
    </div>


    <!-- ============================================= -->
    <!-- JAVASCRIPT 程式碼 -->
    <!-- ============================================= -->
    <script>
        // =============================================
        // 設定
        // =============================================
        
        const GAS_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE_BUT_WE_ARE_NOT_USING_IT_YET";

        function formatMonthLabel(monthKey) {
            if (!monthKey) return '';
            const parts = monthKey.split('-');
            if (parts.length !== 2) return monthKey;
            const month = parts[1].startsWith('0') ? parts[1].slice(1) : parts[1];
            return `${month} 月`;
        }

        const MONTH_META = {
            '2025-11': {
                label: '2025 年 11 月',
                summary: 'Q4 推廣檔期，聚焦年終前的主力車款與核心展示據點。'
            },
            '2025-12': {
                label: '2025 年 12 月',
                summary: '年底衝刺檔期，擴充更多經銷商場次供神秘客安排。'
            }
        };

        const MONTHLY_BRAND_ROSTER = {
            '2025-11': ['Škoda', 'Toyota', 'MAZDA', 'Volkswagen', 'Honda'],
            '2025-12': ['Volvo', 'Audi', 'Ford', 'Hyundai', 'MAZDA']
        };

        const MONTH_ORDER = Object.keys(MONTH_META).sort();
        if (!SELECTED_MONTH) {
            SELECTED_MONTH = MONTH_ORDER[0] || null;
        }

        const BRAND_DATA = [
            { name: 'MAZDA', origin: '日本 / 台灣馬自達', description: '聚焦在以人為本的經典駕馭體驗與客製化賞車流程。', accent: '#BF1E2E', regions: ['central', 'south'] },
            { name: 'Škoda', origin: '捷克 / 歐洲進口', description: '強調 Simply Clever 的驚喜細節與全方位的家庭用車情境。', accent: '#0E3B33', regions: ['north', 'central'] },
            { name: 'Toyota', origin: '日本 / 和泰汽車', description: '檢視高銷量車款的交車節奏與展間待客標準化。', accent: '#EB0A1E', regions: ['north', 'central'] },
            { name: 'Volvo', origin: '瑞典 / 裕隆通用', description: '聚焦北歐豪華氛圍營造與安全科技完整介紹。', accent: '#003057', regions: ['central', 'east'] },
            { name: 'Audi', origin: '德國 / 奧迪台灣', description: '測試 premium 展間的迎賓禮儀、科技座艙演示與試駕流程。', accent: '#000000', regions: ['north', 'east'] },
            { name: 'Honda', origin: '日本 / 台灣本田', description: '確認熱銷車款排隊試乘安排與售後維護諮詢的一致性。', accent: '#DA251D', regions: ['south'] },
            { name: 'Ford', origin: '美國 / 福特六和', description: '重點檢視 Ford 純油與油電產品的體驗一致性與數位化介紹。', accent: '#003399', regions: ['south'] },
            { name: 'Volkswagen', origin: '德國 / 台灣福斯', description: '追蹤歐系主流車款的智慧互聯示範與售後承諾。', accent: '#0A3A5A', regions: ['north', 'east'] },
            { name: 'Hyundai', origin: '韓國 / 南陽實業', description: '評估現代汽車新能源與家庭休旅的展間服務節奏。', accent: '#002A5C', regions: ['south', 'east'] }
        ];

        const BRAND_PROJECTS = {
            'MAZDA': [
                { id: 'mazda-cx5', title: 'CX-5 暖心家庭體驗', category: '家庭賞車', summary: '針對家庭客層進行 CX-5 空間與安全配備說明觀察。', goal: '評估展間人員是否主動協助安裝兒童座椅、介紹 i-ACTIVSENSE 配備與後續保修服務。' }
            ],
            'Škoda': [
                { id: 'skoda-kodiaq', title: 'Kodiaq 旗艦七人座任務', category: '旗艦 SUV', summary: '模擬高階主管考察 Kodiaq 4x4 的全方位接待流程。', goal: '觀察銷售顧問是否提出七人座家庭情境建議並完整示範 Simply Clever 配備。' }
            ],
            'Toyota': [
                { id: 'toyota-corolla-cross', title: 'Corolla Cross 熱銷流程', category: '高銷量 SUV', summary: '體驗熱門車款的排隊賞車及試乘節奏。', goal: '確認現場動線安排、候車動態更新與追加配件溝通是否透明。' }
            ],
            'Volvo': [
                { id: 'volvo-xc40', title: 'XC40 Recharge 都會純電', category: '豪華純電', summary: '針對都會通勤設定評估純電 SUV 的介紹深度。', goal: '檢核安全科技解說、Digital Services 示範與充電資源介紹。' }
            ],
            'Audi': [
                { id: 'audi-q4', title: 'Q4 e-tron 科技體驗', category: '豪華純電', summary: '測試 Audi 智慧座艙的沉浸式導覽。', goal: '確認銷售顧問是否完成 MMI 功能示範與試駕安全提醒。' }
            ],
            'Honda': [
                { id: 'honda-crv', title: 'CR-V 家庭試駕', category: '家庭賞車', summary: '體驗全新世代 CR-V 試駕流程與候車體驗。', goal: '觀察人員對 Honda Sensing、安全配備與保固方案的介紹完整度。' }
            ],
            'Ford': [
                { id: 'ford-kuga', title: 'Kuga 智能駕馭任務', category: '油電 SUV', summary: '以都會家庭視角評估 Kuga 油電休旅的體驗流程。', goal: '確認顧問是否主動介紹 Co-Pilot360 與 FordPass 互聯服務。' }
            ],
            'Volkswagen': [
                { id: 'vw-tiguan', title: 'Tiguan Life 智慧互聯', category: '德系休旅', summary: '聚焦 Tiguan Life 互聯科技與家庭實用配備的導覽。', goal: '觀察顧問對 IQ.Drive 功能與保固維修方案的溝通完整度。' }
            ],
            'Hyundai': [
                { id: 'hyundai-ioniq5', title: 'IONIQ 5 科技生活體驗', category: '純電跨界', summary: '以科技家庭為設定，檢視 IONIQ 5 的展示與交付流程。', goal: '評估顧問如何說明 V2L、充電資源與智慧安全科技。' }
            ]
        };

        const BRAND_MONTH_LOOKUP = {};
        MONTH_ORDER.forEach(monthKey => {
            const roster = MONTHLY_BRAND_ROSTER[monthKey] || [];
            roster.forEach(brandName => {
                if (!BRAND_MONTH_LOOKUP[brandName]) {
                    BRAND_MONTH_LOOKUP[brandName] = [];
                }
                if (!BRAND_MONTH_LOOKUP[brandName].includes(monthKey)) {
                    BRAND_MONTH_LOOKUP[brandName].push(monthKey);
                }
            });
        });

        Object.values(BRAND_MONTH_LOOKUP).forEach(months => months.sort());

        const SEASONAL_LOCATIONS = {
            '2025-11': ['台北內湖', '新竹東區', '台中公益', '台南永康', '高雄鳳山', '花蓮吉安'],
            '2025-12': ['台北士林', '台北敦化', '桃園藝文', '新莊輔大', '板橋文化', '台中中清', '彰化中山', '嘉義民族', '台南安平', '高雄博愛', '屏東建國', '宜蘭羅東', '新北林口']
        };

        const LOCATION_DIRECTORY = {
            '台北內湖': '台北市內湖區瑞光路 168 號',
            '新竹東區': '新竹市東區光復路二段 386 號',
            '台中公益': '台中市南屯區公益路二段 600 號',
            '台南永康': '台南市永康區中正路 599 號',
            '高雄鳳山': '高雄市鳳山區青年路二段 238 號',
            '花蓮吉安': '花蓮縣吉安鄉中山路三段 88 號',
            '台北士林': '台北市士林區承德路四段 200 號',
            '台北敦化': '台北市大安區敦化南路一段 166 號',
            '桃園藝文': '桃園市桃園區藝文一街 88 號',
            '新莊輔大': '新北市新莊區中正路 510 號',
            '板橋文化': '新北市板橋區文化路一段 280 號',
            '台中中清': '台中市北屯區中清路二段 888 號',
            '彰化中山': '彰化市中山路一段 390 號',
            '嘉義民族': '嘉義市民族路 455 號',
            '台南安平': '台南市安平區府前路二段 300 號',
            '高雄博愛': '高雄市左營區博愛二路 366 號',
            '屏東建國': '屏東市建國路 120 號',
            '宜蘭羅東': '宜蘭縣羅東鎮中山路三段 250 號',
            '新北林口': '新北市林口區文化三路一段 356 號'
        };

        const PROJECT_AVAILABILITY = {
            'mazda-cx5': {
                brand: 'MAZDA',
                dealerPrefix: 'MAZDA',
                dealerSuffix: ' 展示中心',
                details: '體驗 CX-5 的人因工學座椅調整、i-ACTIVSENSE 示範與售後保修諮詢。'
            },
            'skoda-kodiaq': {
                brand: 'Škoda',
                dealerPrefix: 'Škoda 太古',
                dealerSuffix: ' 體驗中心',
                details: '確認七人座彈性座椅展示、Simply Clever 配件操作與交車保固說明。'
            },
            'toyota-corolla-cross': {
                brand: 'Toyota',
                dealerPrefix: 'Toyota 和泰',
                dealerSuffix: ' 展示據點',
                details: '觀察熱門車款排隊流程、配件解說與候車通知是否到位。'
            },
            'volvo-xc40': {
                brand: 'Volvo',
                dealerPrefix: 'Volvo 北歐',
                dealerSuffix: ' 品牌中心',
                details: '檢視 XC40 Recharge 的安全科技、Google 互聯功能與充電規劃建議。'
            },
            'audi-q4': {
                brand: 'Audi',
                dealerPrefix: 'Audi Premium',
                dealerSuffix: ' 體驗館',
                details: '體驗 Audi 智慧座艙、MMI 導覽與 e-tron 專屬交車說明。'
            },
            'honda-crv': {
                brand: 'Honda',
                dealerPrefix: 'Honda 直營',
                dealerSuffix: ' 展示中心',
                details: '確認 CR-V 家庭配備介紹、Honda Sensing 示範與保固維修安排。'
            },
            'ford-kuga': {
                brand: 'Ford',
                dealerPrefix: 'Ford 六和',
                dealerSuffix: ' 體驗中心',
                details: '檢查 Kuga Co-Pilot360 說明、FordPass App 示範與油電差異溝通。'
            },
            'vw-tiguan': {
                brand: 'Volkswagen',
                dealerPrefix: 'VW 授權',
                dealerSuffix: ' 展示空間',
                details: '了解 Tiguan Life IQ.Drive 功能、車聯網操作與保修方案。'
            },
            'hyundai-ioniq5': {
                brand: 'Hyundai',
                dealerPrefix: 'Hyundai 現代',
                dealerSuffix: ' 體驗館',
                details: '體驗 IONIQ 5 V2L 應用、Bluelink 連線與充電資源導覽。'
            }
        };

        const MONTHLY_SUMMARY_TEXT = Object.entries(SEASONAL_LOCATIONS)
            .map(([monthKey, dealers]) => `${formatMonthLabel(monthKey)} ${dealers.length} 家據點`)
            .join(' / ');

        const PROJECT_MAP = BRAND_DATA.reduce((acc, brand) => {
            const projects = BRAND_PROJECTS[brand.name] || [];
            projects.forEach(project => {
                acc[project.id] = { ...project, brandName: brand.name, brandAccent: brand.accent };
            });
            return acc;
        }, {});

        function getMonthlyAvailabilitySummary() {
            return MONTHLY_SUMMARY_TEXT;
        }

        function buildSlotsFromAvailability(availability) {
            const slots = [];
            Object.entries(availability).forEach(([projectId, config]) => {
                Object.entries(SEASONAL_LOCATIONS).forEach(([monthKey, placeList]) => {
                    placeList.forEach((place, index) => {
                        const dealerName = `${config.dealerPrefix || config.brand} ${place}${config.dealerSuffix || ''}`
                            .replace(/\s{2,}/g, ' ')
                            .trim();
                        const address = LOCATION_DIRECTORY[place] || `${place}展示中心`;
                        slots.push({
                            slotID: `${projectId}-${monthKey.replace('-', '')}-${String(index + 1).padStart(2, '0')}`,
                            brand: config.brand,
                            projectId,
                            month: monthKey,
                            monthLabel: formatMonthLabel(monthKey),
                            dealer: dealerName,
                            location: `${place}展示中心｜${address}`,
                            details: config.details
                        });
                    });
                });
            });
            return slots;
        }

        // [開發者註記] 模擬資料庫
        let MOCK_SLOTS_DATA = {
            "slots": buildSlotsFromAvailability(PROJECT_AVAILABILITY)
        };
        
        // [開發者註記] 模擬使用者登入狀態
        let CURRENT_USER = {
            email: null,
            name: null,
            role: null
        };

        let SELECTED_BRAND = null;
        let SELECTED_PROJECT = null;
        let SELECTED_MONTH = null;
        let BRAND_SEARCH_QUERY = '';
        const DIRECTORY_COLLAPSE_STATE = {};

        // [開發者註記] 模擬已核准的使用者（含雙重驗證碼）
        const MOCK_APPROVED_USERS = [
            {
                email: "tust@gmail.com",
                name: "測試帳號",
                password: "123456",
                twoFactorCode: "123456",
                role: "member"
            },
            {
                email: "tust2@gmail.com",
                name: "神秘客測試",
                password: "123456",
                twoFactorCode: "123456",
                role: "admin"
            }
        ];


        // =============================================
        // DOM 元素選取
        // =============================================
        // 頁面
        const pageLogin = document.getElementById('page-login');
        const pageBrandHome = document.getElementById('page-brand-home');
        const pageBooking = document.getElementById('page-booking');
        const pageRegister = document.getElementById('page-register');
        
        // 導航
        const navLoggedIn = document.getElementById('nav-logged-in');
        const navLoggedOut = document.getElementById('nav-logged-out');
        const navLinkLoginPage = document.getElementById('nav-link-login-page');
        const navLinkRegisterPage = document.getElementById('nav-link-register-page');
        const navLinkBrandHome = document.getElementById('nav-link-brand-home');
        const logoutButton = document.getElementById('logout-button');
        const welcomeMessage = document.getElementById('welcome-message');

        // 品牌首頁
        const brandDashboardContainer = document.getElementById('brand-dashboard');
        const brandDashboardBreadcrumb = document.getElementById('brand-dashboard-breadcrumb');
        const brandDashboardTitle = document.getElementById('brand-dashboard-title');
        const brandDashboardDescription = document.getElementById('brand-dashboard-description');
        const brandDashboardMeta = document.getElementById('brand-dashboard-meta');
        const brandDashboardProjects = document.getElementById('brand-dashboard-projects');
        const brandDashboardResetButton = document.getElementById('brand-dashboard-reset');
        const projectCardTemplate = document.getElementById('project-card-template');
        const brandSearchInput = document.getElementById('brand-search');
        const resetSearchButton = document.getElementById('reset-search-button');
        const brandDirectoryContainer = document.getElementById('brand-directory');
        const brandDirectoryEmpty = document.getElementById('brand-directory-empty');
        const monthSelector = document.getElementById('month-selector');
        const monthCardTitle = document.getElementById('month-card-title');
        const monthCardSummary = document.getElementById('month-card-summary');
        const monthlyBrandList = document.getElementById('monthly-brand-list');
        const monthlyBrandEmpty = document.getElementById('monthly-brand-empty');
        const sessionCardTitle = document.getElementById('session-card-title');
        const sessionCardSummary = document.getElementById('session-card-summary');
        const sessionBrandMonths = document.getElementById('session-brand-months');
        const brandSessionList = document.getElementById('brand-session-list');
        const brandSessionEmpty = document.getElementById('brand-session-empty');

        // 預約頁面標頭
        const bookingBreadcrumb = document.getElementById('booking-breadcrumb');
        const bookingTitle = document.getElementById('booking-title');
        const bookingIntro = document.getElementById('booking-intro');
        const bookingContext = document.getElementById('booking-context');
        const bookingBrandChip = document.getElementById('booking-brand-chip');
        const bookingMonthSummary = document.getElementById('booking-month-summary');
        const bookingGoal = document.getElementById('booking-goal');
        const bookingGoalText = document.getElementById('booking-goal-text');

        // 登入頁面
        const loginForm = document.getElementById('login-form');
        const loginErrorContainer = document.getElementById('login-error-container');
        const loginErrorMessage = document.getElementById('login-error-message');
        const loginSubmitButton = document.getElementById('login-submit-button');
        const loginSubmitLoader = document.getElementById('login-submit-loader');
        const loginSubmitText = document.getElementById('login-submit-text');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginOtpInput = document.getElementById('login-otp');
        const loginStepOneContainer = document.getElementById('login-step-one');
        const loginStepTwoContainer = document.getElementById('login-step-two');
        const loginStepTwoMessage = document.getElementById('login-step-two-message');
        const twoFactorHint = document.getElementById('two-factor-hint');
        const loginBackButton = document.getElementById('login-back-button');

        // 預約頁面
        const loadingContainer = document.getElementById('loading-container');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const slotsContainer = document.getElementById('slots-container');
        const slotCardTemplate = document.getElementById('slot-card-template');
        
        // Modal
        const bookingModal = document.getElementById('booking-modal');
        const modalCard = document.getElementById('modal-card');
        const modalTitle = document.getElementById('modal-title');
        const bookingForm = document.getElementById('booking-form');
        const submitButton = document.getElementById('submit-button');
        const submitLoader = document.getElementById('submit-loader');
        const submitText = document.getElementById('submit-text');
        
        // 註冊頁面
        const registrationForm = document.getElementById('registration-form');
        const regSubmitButton = document.getElementById('register-submit-button');
        const regSubmitLoader = document.getElementById('register-submit-loader');
        const regSubmitText = document.getElementById('register-submit-text');
        const regNameInput = document.getElementById('reg-name');
        const regEmailInput = document.getElementById('reg-email');
        const regPasswordInput = document.getElementById('reg-password');
        const regPasswordConfirmInput = document.getElementById('reg-password-confirm');

        // 訊息提示框
        const messageBox = document.getElementById('message-box');
        const messageContent = document.getElementById('message-content');
        const messageText = document.getElementById('message-text');
        const iconSuccess = document.getElementById('message-icon-success');
        const iconError = document.getElementById('message-icon-error');

        let messageTimer;
        let loginStep = 1;
        let pendingUser = null;

        // =============================================
        // 核心流程
        // =============================================

        // 1. 頁面載入時執行
        document.addEventListener('DOMContentLoaded', () => {
            // [開發者註記] 預設顯示登入頁面
            renderMonthSelectors();
            renderMonthlyBrandList();
            renderBrandSessions();
            renderBrandDirectory();
            updateSearchResetButton();
            showPage('login');
            setupNavigation();
            setupBrandFilters();
            setLoginStep(1);
        });

        if (brandDashboardResetButton) {
            brandDashboardResetButton.addEventListener('click', clearBrandSelection);
        }

        // 2. [新] 處理登入 - [模擬模式]
        async function handleLoginSubmit(event) {
            event.preventDefault();

            loginErrorContainer.classList.add('hidden');

            if (loginStep === 1) {
                const email = loginEmailInput.value.trim().toLowerCase();
                const password = loginPasswordInput.value;

                if (!email || !password) {
                    loginErrorMessage.textContent = "請輸入完整的 Email 與密碼。";
                    loginErrorContainer.classList.remove('hidden');
                    return;
                }

                showLoginLoading(true);

                setTimeout(() => {
                    const matchedUser = MOCK_APPROVED_USERS.find(user => user.email.toLowerCase() === email);

                    if (!matchedUser || matchedUser.password !== password) {
                        showLoginLoading(false);
                        loginErrorMessage.textContent = "帳號或密碼錯誤，或尚未通過審核。";
                        loginErrorContainer.classList.remove('hidden');
                        pendingUser = null;
                        return;
                    }

                    pendingUser = matchedUser;
                    setLoginStep(2);
                    loginStepTwoMessage.textContent = `驗證碼已傳送至 ${pendingUser.email}，請於 5 分鐘內輸入 6 位數代碼完成登入。`;
                    twoFactorHint.textContent = `（測試用驗證碼：${pendingUser.twoFactorCode}）`;
                    loginOtpInput.value = '';
                    showLoginLoading(false);
                    showMessage('success', '帳號密碼驗證成功，請輸入驗證碼完成登入。');
                }, 1000);
            } else if (loginStep === 2) {
                const otp = loginOtpInput.value.trim();

                if (!otp || otp.length !== 6) {
                    loginErrorMessage.textContent = "請輸入 6 位數驗證碼。";
                    loginErrorContainer.classList.remove('hidden');
                    return;
                }

                showLoginLoading(true);

                setTimeout(() => {
                    if (pendingUser && otp === pendingUser.twoFactorCode) {
                        CURRENT_USER.email = pendingUser.email;
                        CURRENT_USER.name = pendingUser.name;
                        CURRENT_USER.role = pendingUser.role;

                        showLoginLoading(false);
                        resetLoginForm();
                        updateNavUI(true);
                        showBrandHome();
                        showMessage('success', '登入成功！');
                    } else {
                        showLoginLoading(false);
                        loginErrorMessage.textContent = "驗證碼錯誤，請再試一次。";
                        loginErrorContainer.classList.remove('hidden');
                    }
                }, 1000);
            }
        }
        
        // 3. [新] 處理登出
        function handleLogout() {
            CURRENT_USER.email = null;
            CURRENT_USER.name = null;
            CURRENT_USER.role = null;
            SELECTED_BRAND = null;
            SELECTED_PROJECT = null;
            SELECTED_MONTH = MONTH_ORDER[0] || SELECTED_MONTH;
            BRAND_SEARCH_QUERY = '';
            if (brandSearchInput) {
                brandSearchInput.value = '';
            }
            updateSearchResetButton();
            Object.keys(DIRECTORY_COLLAPSE_STATE).forEach(key => delete DIRECTORY_COLLAPSE_STATE[key]);
            renderMonthSelectors();
            renderMonthlyBrandList();
            renderBrandSessions();
            renderBrandDirectory();
            renderBrandDashboard();
            updateNavUI(false); // 更新導航欄為 "登入前"
            resetLoginForm();
            showPage('login'); // 顯示登入頁面
            slotsContainer.innerHTML = ''; // 清空時段
        }

        function showBrandHome() {
            if (!CURRENT_USER.email) {
                showPage('login');
                return;
            }

            bookingBreadcrumb.textContent = '';
            bookingTitle.textContent = '可預約的時段';
            bookingIntro.textContent = '';
            bookingIntro.classList.add('hidden');
            bookingTitle.style.color = '';
            bookingContext.classList.add('hidden');
            bookingBrandChip.textContent = '';
            bookingBrandChip.style.backgroundColor = '';
            bookingBrandChip.style.boxShadow = '';
            bookingMonthSummary.textContent = '';
            bookingGoal.classList.add('hidden');
            bookingGoalText.textContent = '';
            bookingGoal.style.borderLeft = '';
            bookingGoal.style.boxShadow = '';

            showPage('brand-home');

            const targetBrand = SELECTED_BRAND || null;
            SELECTED_PROJECT = null;

            renderMonthSelectors();
            renderMonthlyBrandList();
            renderBrandSessions();
            renderBrandDirectory();
            renderBrandDashboard(targetBrand);
        }

        function updateSearchResetButton() {
            if (!resetSearchButton) return;
            if (BRAND_SEARCH_QUERY) {
                resetSearchButton.classList.remove('hidden');
            } else {
                resetSearchButton.classList.add('hidden');
            }
        }

        function matchesBrandQuery(brand) {
            if (!BRAND_SEARCH_QUERY) return true;
            const query = BRAND_SEARCH_QUERY.toLowerCase();
            const monthLabels = (BRAND_MONTH_LOOKUP[brand.name] || [])
                .map(monthKey => formatMonthLabel(monthKey))
                .filter(Boolean);
            return [brand.name, brand.origin, brand.description, ...monthLabels]
                .some(value => value && value.toLowerCase().includes(query));
        }

        function getBrandsForMonth(monthKey) {
            const roster = MONTHLY_BRAND_ROSTER[monthKey] || [];
            return roster
                .map(name => BRAND_DATA.find(brand => brand.name === name))
                .filter(Boolean);
        }

        function selectMonth(monthKey, options = {}) {
            if (!monthKey || !MONTH_META[monthKey]) {
                return;
            }

            const previousBrand = SELECTED_BRAND;
            const desiredBrand = options.brandName || previousBrand;
            const preserveBrand = Boolean(options.preserveBrand);

            SELECTED_MONTH = monthKey;

            const monthBrands = MONTHLY_BRAND_ROSTER[monthKey] || [];
            if (desiredBrand && monthBrands.includes(desiredBrand)) {
                SELECTED_BRAND = desiredBrand;
            } else if (!preserveBrand) {
                SELECTED_BRAND = null;
                SELECTED_PROJECT = null;
            } else if (!desiredBrand) {
                SELECTED_BRAND = null;
                SELECTED_PROJECT = null;
            }

            if (previousBrand !== SELECTED_BRAND) {
                SELECTED_PROJECT = null;
            }

            renderMonthSelectors();
            renderMonthlyBrandList();
            renderBrandSessions();
            renderBrandDirectory();
            renderBrandDashboard(SELECTED_BRAND);
        }

        function renderMonthSelectors() {
            if (!monthSelector) return;

            monthSelector.innerHTML = '';

            MONTH_ORDER.forEach(monthKey => {
                const button = document.createElement('button');
                button.type = 'button';
                const label = formatMonthLabel(monthKey) || MONTH_META[monthKey]?.label || monthKey;
                button.textContent = label;
                const isActive = monthKey === SELECTED_MONTH;
                button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                button.addEventListener('click', () => {
                    if (!isActive) {
                        selectMonth(monthKey);
                    }
                });
                monthSelector.appendChild(button);
            });

            if (monthCardTitle) {
                const activeLabel = SELECTED_MONTH
                    ? (MONTH_META[SELECTED_MONTH]?.label || `${formatMonthLabel(SELECTED_MONTH)}排程`)
                    : '執行月份';
                monthCardTitle.textContent = SELECTED_MONTH
                    ? `${activeLabel}可執行品牌`
                    : '近期可執行品牌';
            }

            if (monthCardSummary) {
                if (!SELECTED_MONTH) {
                    monthCardSummary.textContent = '請稍後，將更新可執行品牌月份。';
                    return;
                }
                const summaryText = MONTH_META[SELECTED_MONTH]?.summary || '此月份將於稍後公布詳細說明。';
                const brandsInMonth = getBrandsForMonth(SELECTED_MONTH);
                if (BRAND_SEARCH_QUERY) {
                    const matched = brandsInMonth.filter(matchesBrandQuery).length;
                    monthCardSummary.textContent = `${summaryText}（${matched}/${brandsInMonth.length} 品牌符合搜尋條件）`;
                } else {
                    monthCardSummary.textContent = `${summaryText}（共 ${brandsInMonth.length} 個品牌任務）`;
                }
            }
        }

        function renderMonthlyBrandList() {
            if (!monthlyBrandList) return;

            monthlyBrandList.innerHTML = '';
            if (!SELECTED_MONTH) {
                if (monthlyBrandEmpty) {
                    monthlyBrandEmpty.classList.remove('hidden');
                    monthlyBrandEmpty.textContent = '尚未設定執行月份，請稍後再查看。';
                }
                return;
            }

            const brands = getBrandsForMonth(SELECTED_MONTH);
            const filteredBrands = brands.filter(matchesBrandQuery);

            if (!filteredBrands.length) {
                if (monthlyBrandEmpty) {
                    monthlyBrandEmpty.classList.remove('hidden');
                    monthlyBrandEmpty.textContent = BRAND_SEARCH_QUERY
                        ? '此月份暫無符合搜尋條件的品牌，請調整關鍵字或清除搜尋。'
                        : '此月份暫無品牌安排，請切換其他月份。';
                }
                return;
            }

            if (monthlyBrandEmpty) {
                monthlyBrandEmpty.classList.add('hidden');
            }

            if (SELECTED_BRAND && !filteredBrands.some(brand => brand.name === SELECTED_BRAND)) {
                SELECTED_BRAND = null;
                SELECTED_PROJECT = null;
            }

            filteredBrands.forEach(brand => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'monthly-brand-item';
                const isActive = SELECTED_BRAND === brand.name;
                item.setAttribute('aria-pressed', isActive ? 'true' : 'false');

                const infoWrapper = document.createElement('div');
                const nameEl = document.createElement('p');
                nameEl.className = 'text-base font-semibold text-gray-900';
                nameEl.textContent = brand.name;

                const originEl = document.createElement('p');
                originEl.className = 'text-xs text-gray-500 mt-1';
                originEl.textContent = brand.origin;

                infoWrapper.appendChild(nameEl);
                infoWrapper.appendChild(originEl);

                const monthsWrapper = document.createElement('div');
                monthsWrapper.className = 'flex flex-wrap gap-2 mt-2';
                const brandMonths = (BRAND_MONTH_LOOKUP[brand.name] || []).slice(0, 3);
                brandMonths.forEach(monthKey => {
                    const chip = document.createElement('span');
                    chip.className = 'px-3 py-1 rounded-full text-xs font-semibold';
                    chip.textContent = formatMonthLabel(monthKey) || monthKey;
                    if (brand.accent) {
                        chip.style.backgroundColor = `${brand.accent}12`;
                        chip.style.color = brand.accent;
                    } else {
                        chip.style.backgroundColor = '#E5E7EB';
                        chip.style.color = '#374151';
                    }
                    monthsWrapper.appendChild(chip);
                });
                if (brandMonths.length) {
                    infoWrapper.appendChild(monthsWrapper);
                }

                const actionWrapper = document.createElement('div');
                actionWrapper.className = 'flex flex-col items-end gap-2';

                const projectBadge = document.createElement('span');
                projectBadge.className = 'text-xs font-semibold uppercase tracking-wide px-3 py-1 rounded-full';
                const projectCount = (BRAND_PROJECTS[brand.name] || []).length;
                projectBadge.textContent = `${projectCount} 項任務`;
                if (brand.accent) {
                    projectBadge.style.backgroundColor = `${brand.accent}14`;
                    projectBadge.style.color = brand.accent;
                } else {
                    projectBadge.style.backgroundColor = '#E5E7EB';
                    projectBadge.style.color = '#1F2937';
                }
                actionWrapper.appendChild(projectBadge);

                const nextSlot = getNextSlotForBrand(brand.name, SELECTED_MONTH);
                const availabilityEl = document.createElement('p');
                availabilityEl.className = 'text-xs text-gray-500';
                availabilityEl.textContent = nextSlot ? `最近場次：${nextSlot}` : '最近場次：待公布';
                if (brand.accent) {
                    availabilityEl.style.color = brand.accent;
                }
                actionWrapper.appendChild(availabilityEl);

                item.appendChild(infoWrapper);
                item.appendChild(actionWrapper);

                item.addEventListener('click', () => {
                    openBrandDashboard(brand.name, { month: SELECTED_MONTH });
                });

                monthlyBrandList.appendChild(item);
            });
        }

        function renderBrandSessions() {
            if (!brandSessionList || !sessionCardTitle || !sessionCardSummary) return;

            brandSessionList.innerHTML = '';
            if (sessionBrandMonths) {
                sessionBrandMonths.innerHTML = '';
                sessionBrandMonths.classList.add('hidden');
            }

            if (!SELECTED_BRAND) {
                sessionCardTitle.textContent = '請先選擇品牌';
                sessionCardSummary.textContent = '選取上方品牌後，會依月份顯示可執行場次與地點。';
                if (brandSessionEmpty) {
                    brandSessionEmpty.classList.add('hidden');
                }
                return;
            }

            const brandInfo = BRAND_DATA.find(brand => brand.name === SELECTED_BRAND);
            const accent = brandInfo?.accent || '#0E3B33';
            const monthLabel = formatMonthLabel(SELECTED_MONTH) || MONTH_META[SELECTED_MONTH]?.label || '近期月份';

            sessionCardTitle.textContent = `${SELECTED_BRAND} · ${monthLabel} 場次`;
            sessionCardSummary.textContent = '整理當月可執行的任務場次，點擊任務卡可進一步預約或查看詳情。';

            const brandMonths = BRAND_MONTH_LOOKUP[SELECTED_BRAND] || [];
            if (sessionBrandMonths) {
                if (brandMonths.length) {
                    sessionBrandMonths.classList.remove('hidden');
                }
                brandMonths.forEach(monthKey => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.textContent = formatMonthLabel(monthKey) || monthKey;
                    const isActive = monthKey === SELECTED_MONTH;
                    button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                    button.addEventListener('click', () => {
                        if (!isActive) {
                            selectMonth(monthKey, { preserveBrand: true, brandName: SELECTED_BRAND });
                        }
                    });
                    sessionBrandMonths.appendChild(button);
                });
            }

            if (!SELECTED_MONTH || !brandMonths.includes(SELECTED_MONTH)) {
                if (brandSessionEmpty) {
                    brandSessionEmpty.classList.remove('hidden');
                    brandSessionEmpty.textContent = '此品牌在選定月份暫無安排，可切換其他月份或挑選不同品牌。';
                }
                return;
            }

            const slots = (MOCK_SLOTS_DATA.slots || [])
                .filter(slot => slot.brand === SELECTED_BRAND && slot.month === SELECTED_MONTH);

            if (!slots.length) {
                if (brandSessionEmpty) {
                    brandSessionEmpty.classList.remove('hidden');
                    brandSessionEmpty.textContent = '此品牌在選定月份暫無安排，可切換其他月份或挑選不同品牌。';
                }
                return;
            }

            if (brandSessionEmpty) {
                brandSessionEmpty.classList.add('hidden');
            }

            const groupedByProject = slots.reduce((acc, slot) => {
                if (!acc[slot.projectId]) {
                    acc[slot.projectId] = [];
                }
                acc[slot.projectId].push(slot);
                return acc;
            }, {});

            Object.entries(groupedByProject).forEach(([projectId, projectSlots]) => {
                const projectInfo = PROJECT_MAP[projectId] || {};
                const card = document.createElement('div');
                card.className = 'brand-session-card';

                const titleEl = document.createElement('h3');
                titleEl.className = 'text-lg font-semibold';
                titleEl.textContent = projectInfo.title || projectId;
                titleEl.style.color = accent;

                const countEl = document.createElement('p');
                countEl.className = 'text-xs text-gray-500 mt-1';
                countEl.textContent = `${projectSlots.length} 個場次`;

                const list = document.createElement('ul');
                list.className = 'mt-3 space-y-1 text-sm text-gray-600';
                projectSlots.slice(0, 4).forEach(slot => {
                    const li = document.createElement('li');
                    li.textContent = slot.dealer || slot.location || '待公布經銷商';
                    list.appendChild(li);
                });
                if (projectSlots.length > 4) {
                    const more = document.createElement('li');
                    more.className = 'text-xs text-gray-400';
                    more.textContent = `... 另有 ${projectSlots.length - 4} 個場次`;
                    list.appendChild(more);
                }

                const actionButton = document.createElement('button');
                actionButton.type = 'button';
                actionButton.className = 'mt-4 skoda-button font-semibold py-2.5 px-4 rounded-lg';
                actionButton.textContent = '查看完整預約';
                actionButton.style.backgroundColor = accent;
                actionButton.style.color = '#ffffff';
                actionButton.style.boxShadow = `0 12px 24px -16px ${accent}80`;
                actionButton.addEventListener('click', () => openProjectSchedule(SELECTED_BRAND, projectId));

                card.appendChild(titleEl);
                card.appendChild(countEl);
                if (projectInfo.summary) {
                    const summaryEl = document.createElement('p');
                    summaryEl.className = 'text-xs text-gray-500 mt-2';
                    summaryEl.textContent = projectInfo.summary;
                    card.appendChild(summaryEl);
                }
                card.appendChild(list);
                card.appendChild(actionButton);

                brandSessionList.appendChild(card);
            });
        }


        function renderBrandDirectory() {
            if (!brandDirectoryContainer) return;

            brandDirectoryContainer.innerHTML = '';
            let totalMatches = 0;
            const hasQuery = Boolean(BRAND_SEARCH_QUERY);

            MONTH_ORDER.forEach(monthKey => {
                const brands = getBrandsForMonth(monthKey);
                const filteredBrands = brands.filter(matchesBrandQuery);

                if (!filteredBrands.length && hasQuery) {
                    return;
                }

                const expanded = DIRECTORY_COLLAPSE_STATE[monthKey] !== undefined
                    ? DIRECTORY_COLLAPSE_STATE[monthKey]
                    : monthKey === SELECTED_MONTH;

                const label = formatMonthLabel(monthKey) || MONTH_META[monthKey]?.label || monthKey;
                const total = brands.length;
                const countLabel = hasQuery
                    ? `${filteredBrands.length}/${total} 品牌符合條件`
                    : `${total} 個品牌任務`;

                const group = document.createElement('details');
                group.className = 'brand-directory-group';
                if (expanded) {
                    group.setAttribute('open', '');
                }

                group.addEventListener('toggle', () => {
                    DIRECTORY_COLLAPSE_STATE[monthKey] = group.open;
                });

                const summary = document.createElement('summary');
                summary.className = 'brand-directory-toggle';

                const infoWrapper = document.createElement('div');
                infoWrapper.innerHTML = `
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide">${label}</p>
                    <p class="text-xs text-gray-400 mt-1">${countLabel}</p>
                `;

                const actionsWrapper = document.createElement('div');
                actionsWrapper.className = 'brand-directory-actions';

                const switchButton = document.createElement('button');
                switchButton.type = 'button';
                switchButton.className = 'text-xs font-semibold skoda-link';
                if (monthKey === SELECTED_MONTH) {
                    switchButton.textContent = '目前查看中';
                    switchButton.classList.add('opacity-60', 'cursor-default');
                    switchButton.disabled = true;
                } else {
                    switchButton.textContent = '切換至此月份';
                    switchButton.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        selectMonth(monthKey);
                    });
                }
                actionsWrapper.appendChild(switchButton);

                const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                icon.setAttribute('viewBox', '0 0 20 20');
                icon.setAttribute('fill', 'currentColor');
                icon.setAttribute('aria-hidden', 'true');
                icon.classList.add('w-4', 'h-4', 'text-gray-400', 'collapse-icon');
                const iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                iconPath.setAttribute('fill-rule', 'evenodd');
                iconPath.setAttribute('d', 'M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.24 4.5a.75.75 0 01-1.08 0l-4.24-4.5a.75.75 0 01.02-1.06z');
                iconPath.setAttribute('clip-rule', 'evenodd');
                icon.appendChild(iconPath);
                actionsWrapper.appendChild(icon);

                summary.appendChild(infoWrapper);
                summary.appendChild(actionsWrapper);
                group.appendChild(summary);

                if (filteredBrands.length) {
                    const list = document.createElement('div');
                    list.className = 'brand-directory-list';

                    filteredBrands.forEach(brand => {
                        totalMatches += 1;
                        const item = document.createElement('div');
                        item.className = 'brand-directory-item';
                        if (SELECTED_BRAND === brand.name && monthKey === SELECTED_MONTH) {
                            item.dataset.active = 'true';
                        }
                        item.setAttribute('role', 'button');
                        item.setAttribute('tabindex', '0');

                        const info = document.createElement('div');
                        const nameEl = document.createElement('p');
                        nameEl.className = 'text-sm font-semibold text-gray-900';
                        nameEl.textContent = brand.name;
                        const originEl = document.createElement('p');
                        originEl.className = 'text-xs text-gray-500';
                        originEl.textContent = brand.origin;
                        info.appendChild(nameEl);
                        info.appendChild(originEl);

                        const actionBtn = document.createElement('button');
                        actionBtn.type = 'button';
                        actionBtn.className = 'text-xs font-semibold';
                        actionBtn.textContent = '查看';
                        actionBtn.addEventListener('click', (event) => {
                            event.preventDefault();
                            event.stopPropagation();
                            openBrandDashboard(brand.name, { month: monthKey });
                        });

                        const activate = () => {
                            openBrandDashboard(brand.name, { month: monthKey });
                        };

                        item.addEventListener('click', activate);
                        item.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter' || event.key === ' ') {
                                event.preventDefault();
                                activate();
                            }
                        });

                        item.appendChild(info);
                        item.appendChild(actionBtn);
                        list.appendChild(item);
                    });

                    group.appendChild(list);
                } else if (!hasQuery) {
                    const emptyHint = document.createElement('p');
                    emptyHint.className = 'text-xs text-gray-400 mt-3';
                    emptyHint.textContent = '此月份暫無品牌安排。';
                    group.appendChild(emptyHint);
                }

                brandDirectoryContainer.appendChild(group);
            });

            if (brandDirectoryEmpty) {
                if (totalMatches === 0) {
                    brandDirectoryEmpty.classList.remove('hidden');
                } else {
                    brandDirectoryEmpty.classList.add('hidden');
                }
            }
        }



        function clearBrandSelection() {
            if (!CURRENT_USER.email) {
                showPage('login');
                return;
            }

            SELECTED_BRAND = null;
            SELECTED_PROJECT = null;
            renderMonthSelectors();
            renderMonthlyBrandList();
            renderBrandSessions();
            renderBrandDirectory();
            renderBrandDashboard();
        }



        function openBrandDashboard(brandName, options = {}) {
            if (!CURRENT_USER.email) {
                showPage('login');
                return;
            }

            const brandMonths = BRAND_MONTH_LOOKUP[brandName] || [];
            let targetMonth = options.month && MONTH_META[options.month] ? options.month : SELECTED_MONTH;
            if (brandMonths.length) {
                if (!targetMonth || !brandMonths.includes(targetMonth)) {
                    targetMonth = brandMonths[0];
                }
            }

            SELECTED_PROJECT = null;

            if (targetMonth) {
                selectMonth(targetMonth, { preserveBrand: true, brandName: brandName });
            } else {
                SELECTED_BRAND = brandName;
                renderMonthlyBrandList();
                renderBrandSessions();
                renderBrandDirectory();
                renderBrandDashboard(brandName);
            }
        }



        function renderBrandDashboard(brandName = null) {
            if (!brandDashboardContainer) return;

            const brandInfo = brandName ? BRAND_DATA.find(brand => brand.name === brandName) : null;

            if (!brandInfo) {
                brandDashboardBreadcrumb.textContent = '品牌首頁';
                brandDashboardTitle.textContent = '尚未選擇品牌';
                brandDashboardDescription.textContent = '請先從中央的月份清單選擇品牌，這裡會顯示品牌任務重點與建議行程。';
                brandDashboardMeta.textContent = '選擇品牌後即可快速檢視任務摘要與建議預約。';
                brandDashboardProjects.innerHTML = '<p class="text-sm text-gray-500">尚未載入品牌任務，請先挑選品牌。</p>';
                brandDashboardContainer.style.borderTop = '';
                brandDashboardTitle.style.color = '';
                brandDashboardBreadcrumb.style.color = '';
                if (brandDashboardResetButton) {
                    brandDashboardResetButton.classList.add('hidden');
                }
                return;
            }

            const projects = BRAND_PROJECTS[brandName] || [];
            const upcomingSlot = getNextSlotForBrand(brandName);
            const accent = brandInfo.accent || '#0E3B33';

            brandDashboardBreadcrumb.textContent = `品牌首頁 / ${brandName}`;
            brandDashboardTitle.textContent = `${brandName} 任務儀表板`;
            brandDashboardDescription.textContent = brandInfo.description || '暫無品牌描述。';

            const metaParts = [];
            if (projects.length === 0) {
                metaParts.push('目前沒有可預約的任務，請稍後再試。');
            } else if (upcomingSlot) {
                metaParts.push(`目前開放 ${projects.length} 個任務，最近可預約時段：${upcomingSlot}`);
            } else {
                metaParts.push(`目前開放 ${projects.length} 個任務，尚未釋出可預約時段。`);
            }

            const brandMonths = (BRAND_MONTH_LOOKUP[brandName] || [])
                .map(monthKey => formatMonthLabel(monthKey))
                .filter(Boolean)
                .join(' / ');
            if (brandMonths) {
                metaParts.push(`近期月份：${brandMonths}`);
            }

            const seasonSummary = getMonthlyAvailabilitySummary();
            if (seasonSummary) {
                metaParts.push(`本季配置：${seasonSummary}`);
            }

            brandDashboardMeta.textContent = metaParts.join(' ｜ ');

            brandDashboardProjects.innerHTML = '';
            brandDashboardContainer.style.borderTop = `4px solid ${accent}`;
            brandDashboardTitle.style.color = accent;
            brandDashboardBreadcrumb.style.color = `${accent}cc`;

            if (brandDashboardResetButton) {
                brandDashboardResetButton.classList.remove('hidden');
            }

            if (projects.length === 0) {
                brandDashboardProjects.innerHTML = '<p class="text-gray-600">目前沒有可預約的任務，請稍後再試。</p>';
                return;
            }

            const primaryProjects = projects.slice(0, 1);

            primaryProjects.forEach(project => {
                const fragment = projectCardTemplate.content.cloneNode(true);
                const cardRoot = fragment.querySelector('.project-card');
                const actionButton = fragment.querySelector('button');
                fragment.querySelector('.project-category').textContent = project.category;
                fragment.querySelector('.project-title').textContent = project.title;
                fragment.querySelector('.project-summary').textContent = project.summary;
                fragment.querySelector('.project-goal').textContent = project.goal;

                cardRoot.style.borderTopColor = accent;
                actionButton.style.backgroundColor = accent;
                actionButton.style.boxShadow = `0 12px 24px -16px ${accent}80`;

                actionButton.addEventListener('click', () => openProjectSchedule(brandName, project.id));
                brandDashboardProjects.appendChild(fragment);
            });

            if (projects.length > primaryProjects.length) {
                const quickLinks = document.createElement('div');
                quickLinks.className = 'bg-gray-50 border border-dashed border-gray-200 rounded-xl p-4 flex flex-col gap-2';

                const quickLinksLabel = document.createElement('p');
                quickLinksLabel.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wide';
                quickLinksLabel.textContent = '更多任務';
                quickLinks.appendChild(quickLinksLabel);

                projects.slice(primaryProjects.length).forEach(project => {
                    const quickButton = document.createElement('button');
                    quickButton.type = 'button';
                    quickButton.className = 'text-sm skoda-link text-left';
                    quickButton.textContent = project.title;
                    quickButton.addEventListener('click', () => openProjectSchedule(brandName, project.id));
                    quickLinks.appendChild(quickButton);
                });

                brandDashboardProjects.appendChild(quickLinks);
            }
        }



        function getNextSlotForBrand(brandName, monthKey = null) {
            if (!brandName || !MOCK_SLOTS_DATA.slots) {
                return null;
            }

            let brandSlots = MOCK_SLOTS_DATA.slots.filter(slot => slot.brand === brandName);
            if (monthKey) {
                brandSlots = brandSlots.filter(slot => slot.month === monthKey);
            }

            brandSlots.sort((a, b) => {
                const monthCompare = (a.month || '').localeCompare(b.month || '');
                if (monthCompare !== 0) {
                    return monthCompare;
                }
                return (a.dealer || '').localeCompare(b.dealer || '');
            });

            if (!brandSlots.length) {
                return null;
            }

            const nextSlot = brandSlots[0];
            const monthLabel = nextSlot.monthLabel || formatMonthLabel(nextSlot.month);
            if (!monthLabel) {
                return null;
            }

            return nextSlot.dealer ? `${monthLabel} · ${nextSlot.dealer}` : monthLabel;
        }


        function openProjectSchedule(brandName, projectId) {
            const projectInfo = PROJECT_MAP[projectId];
            if (!projectInfo) {
                showMessage('error', '找不到專案資訊，請重新選擇品牌。');
                return;
            }

            SELECTED_BRAND = brandName;
            SELECTED_PROJECT = projectInfo;
            updateBookingHeader();
            fetchSlotsForProject(brandName, projectId);
        }

        function updateBookingHeader() {
            if (!SELECTED_PROJECT) {
                bookingBreadcrumb.textContent = '';
                bookingTitle.textContent = '可預約的時段';
                bookingIntro.textContent = '';
                bookingIntro.classList.add('hidden');
                bookingTitle.style.color = '';
                bookingContext.classList.add('hidden');
                bookingBrandChip.textContent = '';
                bookingBrandChip.style.backgroundColor = '';
                bookingBrandChip.style.boxShadow = '';
                bookingMonthSummary.textContent = '';
                bookingGoal.classList.add('hidden');
                bookingGoalText.textContent = '';
                bookingGoal.style.borderLeft = '';
                bookingGoal.style.boxShadow = '';
                return;
            }

            bookingBreadcrumb.textContent = `品牌首頁 / ${SELECTED_PROJECT.brandName} / ${SELECTED_PROJECT.title}`;
            bookingTitle.textContent = SELECTED_PROJECT.title;
            bookingIntro.textContent = SELECTED_PROJECT.summary;
            if (SELECTED_PROJECT.summary) {
                bookingIntro.classList.remove('hidden');
            } else {
                bookingIntro.classList.add('hidden');
            }

            const accent = SELECTED_PROJECT.brandAccent || '#0E3B33';
            bookingTitle.style.color = accent;

            const monthlySummary = getMonthlyAvailabilitySummary();
            if (monthlySummary) {
                bookingMonthSummary.textContent = `本季配置：${monthlySummary}`;
            } else {
                bookingMonthSummary.textContent = '本季配置：待公布';
            }

            bookingContext.classList.remove('hidden');
            bookingBrandChip.textContent = SELECTED_PROJECT.brandName || '';
            bookingBrandChip.style.backgroundColor = accent;
            bookingBrandChip.style.boxShadow = `0 12px 24px -16px ${accent}80`;

            if (SELECTED_PROJECT.goal) {
                bookingGoal.classList.remove('hidden');
                bookingGoalText.textContent = SELECTED_PROJECT.goal;
                bookingGoal.style.borderLeft = `4px solid ${accent}`;
                bookingGoal.style.boxShadow = `0 12px 24px -18px ${accent}66`;
            } else {
                bookingGoal.classList.add('hidden');
                bookingGoalText.textContent = '';
                bookingGoal.style.borderLeft = '';
                bookingGoal.style.boxShadow = '';
            }
        }

        // 4. (流程 1) 依品牌與專案載入可預約時段 - [模擬模式]
        async function fetchSlotsForProject(brandName, projectId) {
            showPage('booking');
            showLoading(true);
            showLoadError(null);

            setTimeout(() => {
                try {
                    const filteredSlots = MOCK_SLOTS_DATA.slots.filter(slot => slot.brand === brandName && slot.projectId === projectId);
                    renderSlots(filteredSlots);
                    showLoading(false);
                } catch (error) {
                    console.error('渲染模擬資料失敗:', error);
                    showLoadError(error.message);
                    showLoading(false);
                }
            }, 800);
        }

        // 5. 渲染時段卡片
        function renderSlots(slots) {
            slotsContainer.innerHTML = '';
            if (slots.length === 0) {
                slotsContainer.innerHTML = `<p class="text-gray-600 text-center col-span-full">太棒了！所有時段皆已預約完畢。</p>`;
                slotsContainer.classList.remove('hidden');
                return;
            }

            slots.forEach(slot => {
                const card = slotCardTemplate.content.cloneNode(true);
                const projectInfo = PROJECT_MAP[slot.projectId] || {};
                const cardRoot = card.querySelector('.slot-card');
                const projectTitleEl = card.querySelector('.data-project');
                const monthBadge = card.querySelector('.data-month');
                const dealerEl = card.querySelector('.data-dealer');
                const locationEl = card.querySelector('.data-location');
                const detailsEl = card.querySelector('.data-details');
                const bookButton = card.querySelector('.book-button');
                const accentColor = projectInfo.brandAccent || '#0E3B33';

                cardRoot.style.border = `1px solid ${accentColor}22`;
                cardRoot.style.borderTop = `4px solid ${accentColor}`;

                projectTitleEl.textContent = projectInfo.title || slot.projectId || 'N/A';
                projectTitleEl.style.color = accentColor;

                const monthLabel = slot.monthLabel || formatMonthLabel(slot.month) || '執行月份待公布';
                if (monthBadge) {
                    monthBadge.textContent = monthLabel;
                    monthBadge.style.backgroundColor = accentColor;
                    monthBadge.style.boxShadow = `0 10px 20px -14px ${accentColor}99`;
                    monthBadge.style.color = '#ffffff';
                }

                dealerEl.textContent = slot.dealer || '經銷商資訊待公布';
                locationEl.textContent = slot.location || '';
                detailsEl.textContent = slot.details || projectInfo.summary || '';

                bookButton.style.backgroundColor = accentColor;
                bookButton.style.boxShadow = `0 12px 24px -16px ${accentColor}80`;
                bookButton.style.color = '#ffffff';
                bookButton.addEventListener('click', () => {
                    openModal(slot);
                });

                slotsContainer.appendChild(card);
            });

            slotsContainer.classList.remove('hidden');
        }

        // 6. (流程 2) 提交預約 - [模擬模式]
        async function handleBookingSubmit(event) {
            event.preventDefault(); 
            const shopperEmail = document.getElementById('shopper-email').value;
            const slotID = document.getElementById('modal-slotID').value;
            
            // [安全檢查] 確保提交的 Email 是當前登入的 Email
            if (!shopperEmail || shopperEmail !== CURRENT_USER.email) {
                showMessage('error', '驗證失敗，請重新登入。');
                return;
            }

            showSubmitLoading(true);

            setTimeout(() => {
                showSubmitLoading(false);
                closeModal();
                showMessage('success', '模擬預約成功！');

                MOCK_SLOTS_DATA.slots = MOCK_SLOTS_DATA.slots.filter(
                    slot => slot.slotID !== slotID
                );

                if (SELECTED_BRAND && SELECTED_PROJECT) {
                    const remainingSlots = MOCK_SLOTS_DATA.slots.filter(slot => slot.brand === SELECTED_BRAND && slot.projectId === SELECTED_PROJECT.id);
                    renderSlots(remainingSlots);
                }

            }, 1500);
        }
        
        // 7. 提交註冊表單 - [模擬模式]
        async function handleRegistrationSubmit(event) {
            event.preventDefault();

            const name = regNameInput.value.trim();
            const email = regEmailInput.value.trim();
            const password = regPasswordInput.value;
            const passwordConfirm = regPasswordConfirmInput.value;

            if (!name || !email || !password || !passwordConfirm) {
                showMessage('error', '請完整填寫所有必填欄位。');
                return;
            }

            if (password.length < 6) {
                showMessage('error', '密碼需至少 6 碼，請重新設定。');
                return;
            }

            if (password !== passwordConfirm) {
                showMessage('error', '兩次輸入的密碼不一致，請再確認。');
                return;
            }

            showRegisterLoading(true);

            setTimeout(() => {
                showRegisterLoading(false);
                showMessage('success', '模擬註冊成功！請等待管理員審核與啟用雙重驗證。');
                registrationForm.reset();

                // [關鍵] 註冊成功後，跳回「登入頁面」
                showPage('login');

            }, 1500);
        }

        // =============================================
        // UI 輔助函式
        // =============================================
        

        function setupBrandFilters() {
            if (brandSearchInput) {
                brandSearchInput.addEventListener('input', (event) => {
                    BRAND_SEARCH_QUERY = event.target.value.trim();
                    renderMonthSelectors();
                    renderMonthlyBrandList();
                    renderBrandSessions();
                    renderBrandDirectory();
                    renderBrandDashboard(SELECTED_BRAND);
                    updateSearchResetButton();
                });
            }

            if (resetSearchButton) {
                resetSearchButton.addEventListener('click', () => {
                    BRAND_SEARCH_QUERY = '';
                    if (brandSearchInput) {
                        brandSearchInput.value = '';
                        brandSearchInput.focus();
                    }
                    updateSearchResetButton();
                    renderMonthSelectors();
                    renderMonthlyBrandList();
                    renderBrandSessions();
                    renderBrandDirectory();
                    renderBrandDashboard(SELECTED_BRAND);
                });
            }
        }


        // 設定頁面切換
        function setupNavigation() {
            navLinkLoginPage.addEventListener('click', () => showPage('login'));
            navLinkRegisterPage.addEventListener('click', () => showPage('register'));
            navLinkBrandHome.addEventListener('click', () => showBrandHome());
            logoutButton.addEventListener('click', handleLogout);
            loginBackButton.addEventListener('click', () => resetLoginForm({ preserveInputs: true }));
        }

        // [新] 顯示指定頁面
        function showPage(pageName) {
            if ((pageName === 'brand-home' || pageName === 'booking') && !CURRENT_USER.email) {
                pageName = 'login';
            }

            if (pageName === 'booking' && CURRENT_USER.email && !SELECTED_PROJECT) {
                pageName = 'brand-home';
            }

            // 先隱藏所有頁面
            pageLogin.classList.add('hidden');
            pageBrandHome.classList.add('hidden');
            pageBooking.classList.add('hidden');
            pageRegister.classList.add('hidden');

            // 移除所有導航連結的 active 狀態
            navLinkLoginPage.classList.remove('active');
            navLinkRegisterPage.classList.remove('active');
            navLinkBrandHome.classList.remove('active');

            // 顯示指定頁面
            if (pageName === 'login') {
                resetLoginForm();
                pageLogin.classList.remove('hidden');
                navLinkLoginPage.classList.add('active');
            } else if (pageName === 'register') {
                pageRegister.classList.remove('hidden');
                navLinkRegisterPage.classList.add('active');
            } else if (pageName === 'brand-home') {
                pageBrandHome.classList.remove('hidden');
                navLinkBrandHome.classList.add('active');
            } else if (pageName === 'booking') {
                pageBooking.classList.remove('hidden');
                navLinkBrandHome.classList.add('active');
            }
        }
        
        // [新] 更新導航欄 UI (登入/登出時)
        function updateNavUI(isLoggedIn) {
            if (isLoggedIn) {
                navLoggedOut.classList.add('hidden');
                navLoggedIn.classList.remove('hidden');
                navLoggedIn.classList.add('flex');
                const roleLabel = CURRENT_USER.role === 'admin' ? '（管理員）' : '';
                welcomeMessage.textContent = `歡迎, ${CURRENT_USER.name}${roleLabel}`;
            } else {
                navLoggedOut.classList.remove('hidden');
                navLoggedIn.classList.add('hidden');
                navLoggedIn.classList.remove('flex');
                welcomeMessage.textContent = '';
            }
        }

        function resetLoginForm(options = {}) {
            const { preserveInputs = false } = options;
            pendingUser = null;
            loginErrorContainer.classList.add('hidden');

            if (!preserveInputs) {
                loginForm.reset();
            } else {
                loginOtpInput.value = '';
            }

            setLoginStep(1);
            showLoginLoading(false);
        }

        function setLoginStep(step) {
            loginStep = step;

            if (loginStep === 1) {
                loginStepOneContainer.classList.remove('hidden');
                loginStepTwoContainer.classList.add('hidden');
                loginEmailInput.removeAttribute('disabled');
                loginPasswordInput.removeAttribute('disabled');
                loginBackButton.classList.add('hidden');
                loginBackButton.classList.remove('block');
                loginOtpInput.value = '';
                loginOtpInput.setAttribute('disabled', 'true');
                twoFactorHint.textContent = '';
                loginStepTwoMessage.textContent = '';
            } else {
                loginStepOneContainer.classList.add('hidden');
                loginStepTwoContainer.classList.remove('hidden');
                loginEmailInput.setAttribute('disabled', 'true');
                loginPasswordInput.setAttribute('disabled', 'true');
                loginBackButton.classList.remove('hidden');
                loginBackButton.classList.add('block');
                loginOtpInput.removeAttribute('disabled');
                loginOtpInput.focus();
            }

            loginSubmitText.textContent = loginStep === 1 ? '下一步' : '確認登入';
        }

        // 顯示/隱藏 全頁載入中
        function showLoading(isLoading) {
            if (isLoading) {
                loadingContainer.classList.remove('hidden');
                loadingContainer.classList.add('flex');
                slotsContainer.classList.add('hidden');
            } else {
                loadingContainer.classList.add('hidden');
                loadingContainer.classList.remove('flex');
            }
        }
        
        // 顯示載入錯誤
        function showLoadError(message) {
            if (message) {
                errorMessage.textContent = message;
                errorContainer.classList.remove('hidden');
            } else {
                errorContainer.classList.add('hidden');
            }
        }

        // 開啟 Modal
        function openModal(slot) {
            const projectInfo = PROJECT_MAP[slot.projectId] || {};
            document.getElementById('modal-project').textContent = projectInfo.title || slot.projectId || '';
            document.getElementById('modal-dealer').textContent = slot.dealer || '經銷商資訊待公布';
            document.getElementById('modal-location').textContent = slot.location || '';
            document.getElementById('modal-month').textContent = slot.monthLabel || formatMonthLabel(slot.month) || '';
            document.getElementById('modal-details').textContent = slot.details || projectInfo.summary || '';
            document.getElementById('modal-slotID').value = slot.slotID;

            // [關鍵] 自動帶入已登入的 Email
            document.getElementById('shopper-email').value = CURRENT_USER.email;

            const accent = projectInfo.brandAccent || '#0E3B33';
            modalCard.style.borderTop = `4px solid ${accent}`;
            if (modalTitle) {
                modalTitle.style.color = accent;
            }
            submitButton.style.backgroundColor = accent;
            submitButton.style.boxShadow = `0 12px 24px -16px ${accent}80`;
            submitButton.style.color = '#ffffff';

            // bookingForm.reset() 會清掉 email，所以我們手動重設

            bookingModal.classList.remove('hidden');
            setTimeout(() => {
                modalCard.classList.remove('scale-95');
            }, 10);
        }

        // 關閉 Modal
        function closeModal() {
            modalCard.classList.add('scale-95');
            setTimeout(() => {
                bookingModal.classList.add('hidden');
            }, 200);
        }

        // 顯示/隱藏 登入按鈕的載入動畫
        function showLoginLoading(isLoading) {
            if (isLoading) {
                loginSubmitButton.disabled = true;
                loginSubmitLoader.classList.remove('hidden');
                loginSubmitText.textContent = "驗證中...";
            } else {
                loginSubmitButton.disabled = false;
                loginSubmitLoader.classList.add('hidden');
                loginSubmitText.textContent = loginStep === 1 ? "下一步" : "確認登入";
            }
        }
        
        // 顯示/隱藏 預約按鈕的載入動畫
        function showSubmitLoading(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                submitLoader.classList.remove('hidden');
                submitText.textContent = "處理中...";
            } else {
                submitButton.disabled = false;
                submitLoader.classList.add('hidden');
                submitText.textContent = "確認送出預約";
            }
        }
        
        // 顯示/隱藏 註冊按鈕的載入動畫
        function showRegisterLoading(isLoading) {
            if (isLoading) {
                regSubmitButton.disabled = true;
                regSubmitLoader.classList.remove('hidden');
                regSubmitText.textContent = "傳送中...";
            } else {
                regSubmitButton.disabled = false;
                regSubmitLoader.classList.add('hidden');
                regSubmitText.textContent = "送出註冊申請";
            }
        }

        // 顯示右上角訊息提示
        function showMessage(type, message) {
            if (messageTimer) clearTimeout(messageTimer);
            messageText.textContent = message;
            
            if (type === 'success') {
                messageContent.classList.remove('bg-red-500');
                messageContent.classList.add('bg-green-500');
                iconSuccess.classList.remove('hidden');
                iconError.classList.add('hidden');
            } else {
                messageContent.classList.remove('bg-green-500');
                messageContent.classList.add('bg-red-500');
                iconSuccess.classList.add('hidden');
                iconError.classList.remove('hidden');
            }
            
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.remove('opacity-0'); 
            }, 10);

            messageTimer = setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 4000); 
        }
        
        // 點擊 Modal 外部區域也可關閉
        bookingModal.addEventListener('click', (event) => {
            if (event.target === bookingModal) {
                closeModal();
            }
        });

    </script>
</body>
</html>

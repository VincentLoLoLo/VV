<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神秘客預約系統</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* 自訂 Škoda 品牌顏色 */
        :root {
            --skoda-green: #4F9D3C;
            --skoda-dark-green: #0E3B33;
            --skoda-text: #2E2E2E;
            --skoda-light-gray: #F5F5F5;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--skoda-light-gray);
            color: var(--skoda-text);
        }
        
        .skoda-button {
            background-color: var(--skoda-green);
            color: white;
            transition: background-color 0.3s ease;
        }
        .skoda-button:hover {
            background-color: #3e8e2c;
        }
        
        .skoda-button-outline {
            border: 1px solid #D1D5DB; /* gray-300 */
            color: var(--skoda-text);
            transition: background-color 0.3s ease;
        }
        .skoda-button-outline:hover {
            background-color: #F9FAFB; /* gray-50 */
        }
        
        .skoda-link {
            color: var(--skoda-green);
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .skoda-link:hover {
            color: var(--skoda-dark-green);
        }

        /* 隱藏滾動條但仍可滾動 */
        .modal-body::-webkit-scrollbar,
        .page-scroll::-webkit-scrollbar {
            display: none;
        }
        .modal-body,
        .page-scroll {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* 簡易載入動畫 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--skoda-green);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        /* 頁面切換導航樣式 */
        .nav-link {
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s ease, color 0.3s ease;
            padding-bottom: 4px;
        }
        .nav-link.active {
            border-bottom-color: var(--skoda-green);
            color: var(--skoda-green);
        }
        .nav-link:hover:not(.active) {
            color: #000;
        }

        .brand-card {
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }

        .brand-card.active {
            border-color: var(--skoda-green) !important;
            background-color: #ecfdf5;
            color: var(--skoda-dark-green);
        }

        .brand-card .brand-remaining {
            font-variant-numeric: tabular-nums;
        }

        .admin-brand-row {
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .admin-brand-row:hover {
            background-color: #f9fafb;
        }

        .admin-brand-row.active {
            background-color: #ecfdf5;
        }

        .accent-button {
            color: #ffffff;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }

        .accent-button:hover {
            transform: translateY(-1px);
        }

        .accent-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .accent-badge {
            color: #ffffff;
            transition: transform 0.2s ease;
        }
    </style>
</head>
<body class="antialiased">

    <!-- 頂部導航欄 -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <nav class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex-shrink-0 flex items-center">
                    <span class="text-2xl font-bold" style="color: var(--skoda-dark-green);">Mystery Shopper</span>
                    <span class="ml-2 text-xl font-semibold text-gray-700">預約系統</span>
                </div>
                
                <!-- 導航連結 (登入前) -->
                <div id="nav-logged-out" class="flex items-center space-x-6">
                    <a id="nav-link-login-page" class="nav-link active font-medium text-gray-700">
                        登入
                    </a>
                    <a id="nav-link-register-page" class="nav-link font-medium text-gray-700">
                        新成員註冊
                    </a>
                </div>
                
                <!-- 導航連結 (登入後) -->
                <div id="nav-logged-in" class="hidden items-center space-x-6">
                    <span id="welcome-message" class="text-gray-700"></span>
                    <a id="nav-link-admin-dashboard" href="#" class="nav-link font-medium text-gray-700 hidden">
                        管理儀表板
                    </a>
                    <a id="nav-link-brand-home" href="#" class="nav-link font-medium text-gray-700">
                        品牌首頁
                    </a>
                    <a id="logout-button" class="skoda-link">
                        登出
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- =================================================== -->
    <!-- 頁面 1: 登入 (預設顯示) -->
    <!-- =================================================== -->
    <main id="page-login" class="max-w-md mx-auto p-4 sm:p-6 lg:p-8 mt-10">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900 mb-6 text-center">神秘客登入</h1>
        <p class="text-gray-600 mb-8 text-center">請使用您註冊並通過審核的 Email 及密碼登入，並完成雙重驗證。</p>

        <form id="login-form" onsubmit="handleLoginSubmit(event)" class="bg-white p-8 rounded-2xl shadow-lg space-y-6">

            <!-- 登入錯誤訊息 -->
            <div id="login-error-container" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <p id="login-error-message"></p>
            </div>

            <!-- 步驟一：帳號密碼驗證 -->
            <div id="login-step-one" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="login-email" name="login-email" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="example@email.com">
                </div>

                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">密碼</label>
                    <input type="password" id="login-password" name="login-password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="請輸入密碼">
                </div>

                <p class="text-xs text-gray-500">若忘記密碼，請聯繫管理員協助重設。</p>
            </div>

            <!-- 步驟二：雙重驗證碼 -->
            <div id="login-step-two" class="hidden space-y-4">
                <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
                    <p id="login-step-two-message" class="text-sm"></p>
                </div>
                <div>
                    <label for="login-otp" class="block text-sm font-medium text-gray-700 mb-2">驗證碼</label>
                    <input type="text" id="login-otp" name="login-otp" inputmode="numeric" pattern="[0-9]*" maxlength="6" minlength="6" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="請輸入 6 位數驗證碼">
                    <p id="two-factor-hint" class="text-xs text-gray-500 mt-2"></p>
                </div>
            </div>

            <!-- 提交按鈕 -->
            <div class="pt-4 space-y-3">
                <button type="submit" id="login-submit-button" class="w-full skoda-button font-bold py-3 px-5 rounded-lg flex items-center justify-center text-lg">
                    <svg id="login-submit-loader" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="login-submit-text">下一步</span>
                </button>

                <button type="button" id="login-back-button" class="hidden w-full skoda-button-outline font-medium py-3 px-5 rounded-lg">
                    返回重新輸入帳號密碼
                </button>
            </div>

            <p class="text-sm text-center text-gray-600">
                還沒有帳號？
                <a onclick="showPage('register')" class="skoda-link">
                    點此立即註冊
                </a>
            </p>
        </form>
    </main>

    <!-- =================================================== -->
    <!-- 頁面 2: 品牌首頁 (登入後預設顯示) -->
    <!-- =================================================== -->
    <main id="page-brand-home" class="hidden max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
        <section class="bg-white rounded-3xl shadow-lg border border-gray-100 p-6 sm:p-10">
            <div class="space-y-4">
                <p class="text-sm font-semibold text-emerald-600 uppercase tracking-wide">神秘客入口</p>
                <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-gray-900">選擇品牌並安排任務</h1>
                <p class="text-gray-600 text-sm sm:text-base leading-relaxed">
                    從左側清單挑選品牌，立即檢視剩餘名額並預約合適的任務場次。
                </p>
            </div>
        </section>

        <section class="grid gap-6 lg:grid-cols-[minmax(220px,260px)_1fr] items-start">
            <aside class="bg-white rounded-3xl shadow-lg border border-gray-100 p-6 sm:p-8">
                <div class="mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">品牌清單</h2>
                    <p class="text-sm text-gray-500">依剩餘名額排序顯示。</p>
                </div>
                <div id="brand-grid" class="space-y-2"></div>
                <p id="brand-list-empty" class="hidden text-sm text-gray-500 text-center">目前沒有開放預約的品牌。</p>
            </aside>

            <div class="space-y-6">
                <div id="brand-selection-empty" class="bg-white rounded-3xl border border-dashed border-gray-200 p-10 text-gray-500">
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <h2 class="text-2xl font-semibold text-gray-900">依地區查看剩餘名額</h2>
                            <p class="text-sm text-gray-500">先挑選想前往的區域，了解各品牌目前還有哪些空檔。</p>
                        </div>
                        <div class="overflow-x-auto">
                            <div class="inline-block min-w-full overflow-hidden rounded-3xl border border-gray-100 shadow-xl ring-1 ring-black/5">
                                <table class="min-w-full text-sm">
                                    <thead class="bg-white/90">
                                        <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                                            <th class="px-6 py-4 w-52">地區概況</th>
                                            <th class="px-6 py-4">可預約品牌與剩餘名額</th>
                                        </tr>
                                    </thead>
                                    <tbody id="region-overview-body" class="bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                        <p id="region-overview-empty" class="hidden text-sm text-gray-500 text-center">目前所有地區皆無剩餘名額，請稍後再查看。</p>
                    </div>
                </div>

                <div id="brand-selection-panel" class="hidden">
                    <div class="bg-white rounded-3xl shadow-lg border border-gray-100 p-6 sm:p-8 space-y-6">
                        <nav id="brand-selection-breadcrumb" class="flex flex-wrap items-center gap-2 text-sm text-gray-500"></nav>
                        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                            <div class="space-y-2">
                                <h3 id="brand-selection-title" class="text-2xl font-semibold text-gray-900"></h3>
                                <p id="brand-selection-subtitle" class="text-sm text-gray-500"></p>
                            </div>
                            <span id="brand-selection-remaining" class="hidden inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-emerald-100 text-emerald-700"></span>
                        </div>
                        <div id="brand-availability-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        <p id="brand-availability-empty" class="hidden text-sm text-gray-500 text-center">目前沒有開放預約的據點。</p>
                    </div>
                </div>
            </div>
        </section>

        <template id="brand-card-template">
            <button type="button" class="brand-card w-full text-left px-4 py-3 rounded-2xl border border-gray-200 bg-white shadow-sm hover:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <div class="flex flex-col">
                    <span class="text-xs font-medium tracking-wide brand-origin"></span>
                    <span class="text-lg font-semibold brand-name"></span>
                    <span class="text-sm text-gray-500 brand-remaining"></span>
                </div>
            </button>
        </template>
        <template id="experience-card-template">
            <button type="button" class="experience-card w-full text-left px-5 py-4 rounded-2xl border border-gray-200 bg-white shadow-sm transition-all duration-200 hover:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <div class="flex items-start justify-between gap-6">
                    <div class="space-y-1">
                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide experience-region"></p>
                        <h4 class="text-lg font-semibold text-gray-900 experience-project"></h4>
                        <p class="text-sm text-gray-500 experience-dealer"></p>
                    </div>
                    <div class="text-right">
                        <span class="experience-remaining inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold"></span>
                        <p class="experience-next text-xs text-gray-400 mt-2"></p>
                    </div>
                    <span class="remaining-badge inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold"></span>
                </div>
                <div class="mt-4 space-y-2">
                    <p class="text-sm text-gray-600 next-available"></p>
                    <p class="text-xs text-gray-500 total-summary"></p>
                    <div class="project-summary flex flex-wrap gap-2"></div>
                </div>
                <div class="mt-6 flex items-center justify-end">
                    <button type="button" class="dealer-detail-button accent-button font-semibold py-2 px-4 rounded-lg">查看詳細場次</button>
                </div>
            </button>
        </template>
    </main>
    <!-- =================================================== -->
    <!-- 頁面 3: 管理儀表板 (僅管理員可見) -->
    <!-- =================================================== -->
    <main id="page-admin-dashboard" class="hidden max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
        <section class="space-y-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">管理儀表板總覽</h1>
                <p class="text-gray-600 mt-2">集中掌握各品牌任務開案、剩餘時段與月份分佈；第一層呈現關鍵 KPI，第二層可深入查看品牌詳細數據並快速調整資源。</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                <div class="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-emerald-500">
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide">註冊品牌</p>
                    <p id="admin-total-brands" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    <p class="text-sm text-gray-500 mt-2">目前系統可派任務的汽車品牌。</p>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-sky-500">
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide">開放任務</p>
                    <p id="admin-total-projects" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    <p class="text-sm text-gray-500 mt-2">各品牌下仍可受理的任務數量。</p>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-amber-500">
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide">剩餘時段</p>
                    <p id="admin-open-slots" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    <p class="text-sm text-gray-500 mt-2">尚未被預約的任務時段。</p>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-rose-500">
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide">預約完成率</p>
                    <p id="admin-utilization-rate" class="text-3xl font-bold text-gray-900 mt-2">0%</p>
                    <p class="text-sm text-gray-500 mt-2">已預約時段佔所有釋出時段的比例。</p>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-2xl shadow-lg border border-gray-100">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-6 border-b border-gray-100 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">品牌任務概況</h2>
                    <p class="text-sm text-gray-500 mt-1">依品牌檢視任務數量、剩餘名額與最近時段。</p>
                    <p class="text-xs text-gray-400 mt-2">點擊任一品牌列以開啟詳細數據儀表板。</p>
                </div>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">
                    即時更新
                </span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-100">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">品牌</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">任務數量</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">剩餘時段</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">最近時段</th>
                        </tr>
                    </thead>
                    <tbody id="admin-brand-table-body" class="divide-y divide-gray-100 bg-white"></tbody>
                </table>
            </div>
            <div id="admin-brand-table-empty" class="hidden p-6 text-center text-sm text-gray-500 border-t border-gray-100">
                目前尚未建立任何品牌任務。
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-900">即將到來的任務</h3>
                    <span class="text-xs font-medium text-gray-500">最近 6 筆</span>
                </div>
                <ul id="admin-upcoming-list" class="space-y-4"></ul>
                <p id="admin-upcoming-empty" class="hidden text-sm text-gray-500 text-center">目前沒有剩餘時段。</p>
            </div>
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-900">月份開案概況</h3>
                    <span class="text-xs font-medium text-gray-500">依月份統計</span>
                </div>
                <ul id="admin-monthly-summary" class="space-y-3"></ul>
                <p id="admin-monthly-empty" class="hidden text-sm text-gray-500 text-center">尚未建立任何月份的任務。</p>
            </div>
        </section>
        <section id="admin-brand-detail" class="hidden space-y-6">
            <div id="admin-brand-detail-card" class="bg-white rounded-3xl shadow-lg border-t-4">
                <div class="p-6 sm:p-8 flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
                    <div class="space-y-2">
                        <p id="admin-brand-detail-breadcrumb" class="text-sm text-gray-500"></p>
                        <h2 id="admin-brand-detail-title" class="text-3xl font-bold tracking-tight text-gray-900"></h2>
                        <p id="admin-brand-detail-description" class="text-gray-600"></p>
                    </div>
                    <button type="button" class="skoda-button-outline font-medium py-2.5 px-5 rounded-lg self-start" onclick="closeAdminBrandDetail()">返回品牌總覽</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-6 sm:p-8 border-t border-gray-100">
                    <div class="bg-emerald-50 text-emerald-800 rounded-2xl p-4">
                        <p class="text-xs font-semibold uppercase tracking-wide">剩餘時段</p>
                        <p id="admin-brand-detail-remaining" class="text-2xl font-bold mt-2">0</p>
                        <p class="text-xs text-emerald-700 mt-1">尚未被預約的時段。</p>
                    </div>
                    <div class="bg-sky-50 text-sky-800 rounded-2xl p-4">
                        <p class="text-xs font-semibold uppercase tracking-wide">已預約</p>
                        <p id="admin-brand-detail-booked" class="text-2xl font-bold mt-2">0</p>
                        <p class="text-xs text-sky-700 mt-1">已由神秘客預約的時段。</p>
                    </div>
                    <div class="bg-amber-50 text-amber-800 rounded-2xl p-4">
                        <p class="text-xs font-semibold uppercase tracking-wide">預約完成率</p>
                        <p id="admin-brand-detail-utilization" class="text-2xl font-bold mt-2">0%</p>
                        <p class="text-xs text-amber-700 mt-1">已預約時段佔全部釋出時段比例。</p>
                    </div>
                    <div class="bg-rose-50 text-rose-800 rounded-2xl p-4">
                        <p class="text-xs font-semibold uppercase tracking-wide">最近可預約</p>
                        <p id="admin-brand-detail-next" class="text-lg font-semibold mt-2">尚未開放</p>
                        <p class="text-xs text-rose-700 mt-1">距今最近的剩餘時段。</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-lg border border-gray-100 p-6 sm:p-8 space-y-6">
                <div class="flex flex-col gap-2">
                    <h3 class="text-xl font-semibold text-gray-900">專案狀態</h3>
                    <p class="text-sm text-gray-500">追蹤各任務類型的剩餘名額與最近時段。</p>
                </div>
                <div id="admin-brand-detail-projects" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                <p id="admin-brand-detail-projects-empty" class="hidden text-sm text-gray-500 text-center">目前沒有任何任務可供預約。</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-3xl shadow-lg border border-gray-100 p-6 sm:p-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-900">區域剩餘名額</h3>
                        <span class="text-xs font-medium text-gray-500">依縣市統計</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-100">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">縣市</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">剩餘名額</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">占比</th>
                                </tr>
                            </thead>
                            <tbody id="admin-brand-detail-region-body" class="divide-y divide-gray-100 bg-white"></tbody>
                        </table>
                    </div>
                    <p id="admin-brand-detail-region-empty" class="hidden text-sm text-gray-500 text-center mt-4">目前沒有剩餘名額。</p>
                </div>
                <div class="bg-white rounded-3xl shadow-lg border border-gray-100 p-6 sm:p-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-900">據點詳情</h3>
                        <span class="text-xs font-medium text-gray-500">含任務類型</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-100">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">據點</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">縣市</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">剩餘名額</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">最近時段</th>
                                </tr>
                            </thead>
                            <tbody id="admin-brand-detail-dealer-body" class="divide-y divide-gray-100 bg-white"></tbody>
                        </table>
                    </div>
                    <p id="admin-brand-detail-dealer-empty" class="hidden text-sm text-gray-500 text-center mt-4">此品牌沒有剩餘時段。</p>
                </div>
            </div>
        </section>


        <p class="text-xs text-gray-400">以上資料為模擬示意，正式環境請串接後端任務與預約狀態。</p>
    </main>

    <!-- =================================================== -->
    <!-- 頁面 4: 預約時段 (預設隱藏) -->
    <!-- =================================================== -->
    <main id="page-booking" class="hidden max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <nav id="booking-breadcrumb" class="flex flex-wrap items-center gap-2 text-sm text-gray-500"></nav>
            <button type="button" id="booking-back-button" class="hidden skoda-button-outline font-medium py-2 px-4 rounded-lg">
                返回上一頁
            </button>
        </div>

        <section class="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] items-start">
            <article class="bg-white rounded-3xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="relative">
                    <img id="experience-vehicle-image" src="" alt="車款示意圖" class="w-full h-64 object-cover">
                    <div id="experience-vehicle-class" class="absolute top-4 left-4 inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-black bg-opacity-60 text-white"></div>
                </div>
                <div class="p-6 sm:p-8 space-y-6">
                    <header class="space-y-2">
                        <h1 id="experience-title" class="text-3xl font-bold tracking-tight text-gray-900"></h1>
                        <p id="experience-dealer" class="text-base font-semibold text-gray-700"></p>
                        <p id="experience-location" class="text-sm text-gray-500"></p>
                    </header>

                    <section class="grid gap-4 sm:grid-cols-2">
                        <div class="bg-emerald-50 text-emerald-800 rounded-2xl p-5">
                            <p class="text-xs font-semibold uppercase tracking-wide">適合族群</p>
                            <p id="experience-usage" class="text-sm mt-2"></p>
                        </div>
                        <div class="bg-sky-50 text-sky-800 rounded-2xl p-5">
                            <p class="text-xs font-semibold uppercase tracking-wide">車款介紹</p>
                            <p id="experience-vehicle-summary" class="text-sm mt-2"></p>
                        </div>
                    </section>

                    <section class="space-y-3">
                        <h2 class="text-xl font-semibold text-gray-900">任務重點</h2>
                        <p id="experience-mission" class="text-sm text-gray-600"></p>
                        <ul id="experience-highlights" class="space-y-2"></ul>
                    </section>

                    <section class="space-y-3">
                        <h2 class="text-xl font-semibold text-gray-900">注意事項</h2>
                        <ul id="experience-cautions" class="space-y-2"></ul>
                    </section>

                    <section class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-semibold text-gray-900">車型建議與預算</h2>
                            <span id="experience-remaining-badge" class="hidden inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700"></span>
                        </div>
                        <div id="experience-trims" class="grid gap-4 sm:grid-cols-2"></div>
                    </section>
                </div>
            </article>

            <aside class="space-y-4">
                <div class="bg-white rounded-3xl shadow-lg border border-gray-100 p-6 space-y-4">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">可預約場次</h2>
                        <p id="experience-next-slot" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                    <div id="loading-container" class="flex flex-col items-center justify-center py-12">
                        <div class="loader"></div>
                        <p class="mt-4 text-gray-600">正在載入可預約時段...</p>
                    </div>
                    <div id="error-container" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                        <strong class="font-bold">載入失敗！</strong>
                        <span class="block sm:inline" id="error-message">無法從伺服器獲取資料，請稍後再試。</span>
                    </div>
                    <div id="slots-container" class="hidden space-y-3"></div>
                    <p id="slots-empty" class="hidden text-sm text-gray-500">太棒了！所有時段皆已預約完畢。</p>
                </div>
            </aside>
        </section>

        <template id="slot-item-template">
            <div class="slot-item flex items-center justify-between gap-4 border border-gray-200 rounded-xl px-4 py-3 bg-gray-50">
                <div>
                    <p class="slot-month text-sm font-semibold text-gray-800"></p>
                    <p class="slot-detail text-xs text-gray-500"></p>
                </div>
                <button type="button" class="book-button accent-button font-semibold py-2 px-4 rounded-lg">預約</button>
            </div>
        </template>
    </main>

    <!-- =================================================== -->
    <!-- 頁面 3: 新成員註冊 (預設隱藏) -->
    <!-- =================================================== -->
    <main id="page-register" class="hidden max-w-2xl mx-auto p-4 sm:p-6 lg:p-8">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900 mb-6">神秘客新成員註冊</h1>
        <p class="text-gray-600 mb-8">感謝您加入我們的行列。請填寫以下詳細資料，我們將會進行審核，並在通過後與您聯繫。</p>

        <form id="registration-form" onsubmit="handleRegistrationSubmit(event)" class="bg-white p-8 rounded-2xl shadow-lg space-y-6">
            
            <!-- 姓名 -->
            <div>
                <label for="reg-name" class="block text-sm font-medium text-gray-700 mb-2">真實姓名</label>
                <input type="text" id="reg-name" name="reg-name" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="王大明">
                <p class="text-xs text-gray-500 mt-2">請填寫與身分證件相符的姓名，以便核對酬勞發放。</p>
            </div>
            
            <!-- Email -->
            <div>
                <label for="reg-email" class="block text-sm font-medium text-gray-700 mb-2">Email (登入帳號)</label>
                <input type="email" id="reg-email" name="reg-email" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="example@email.com">
            </div>

            <!-- 密碼 -->
            <div>
                <label for="reg-password" class="block text-sm font-medium text-gray-700 mb-2">設定登入密碼</label>
                <input type="password" id="reg-password" name="reg-password" required minlength="6"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="請輸入至少 6 碼密碼">
                <p class="text-xs text-gray-500 mt-2">建議使用英數混合密碼，後續登入需配合雙重驗證。</p>
            </div>

            <!-- 確認密碼 -->
            <div>
                <label for="reg-password-confirm" class="block text-sm font-medium text-gray-700 mb-2">確認密碼</label>
                <input type="password" id="reg-password-confirm" name="reg-password-confirm" required minlength="6"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="請再輸入一次密碼">
            </div>

            <!-- 電話 -->
            <div>
                <label for="reg-phone" class="block text-sm font-medium text-gray-700 mb-2">聯絡電話</label>
                <input type="tel" id="reg-phone" name="reg-phone" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="0912-345-678">
            </div>

            <!-- 銀行帳號 -->
            <div>
                <label for="reg-bank" class="block text-sm font-medium text-gray-700 mb-2">銀行帳號 (酬勞發放)</label>
                <input type="text" id="reg-bank" name="reg-bank" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="銀行代碼 (000) 帳號 (123456789)">
                <p class="text-xs text-gray-500 mt-2">我們承諾將妥善保管您的個資，僅用於酬勞發放。</p>
            </div>

            <!-- 提交按鈕 -->
            <div class="pt-4">
                <button type="submit" id="register-submit-button" class="w-full skoda-button font-bold py-3 px-5 rounded-lg flex items-center justify-center text-lg">
                    <svg id="register-submit-loader" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="register-submit-text">送出註冊申請</span>
                </button>
            </div>
            
            <p class="text-sm text-center text-gray-600">
                已經有帳號了？ 
                <a onclick="showPage('login')" class="skoda-link">
                    返回登入
                </a>
            </p>
        </form>
    </main>


    <!-- 
      預約彈出式表單 (Modal)
      - 預設為隱藏
    -->
    <div id="booking-modal" class="hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center p-4">
        
        <!-- Modal 內容卡片 -->
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-auto transition-all duration-300 transform scale-95" id="modal-card">
            
            <!-- Modal 標題 -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold" style="color: var(--skoda-dark-green);">確認預約</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Modal 表單內容 -->
            <form id="booking-form" onsubmit="handleBookingSubmit(event)">
                <div class="p-6 space-y-5 modal-body max-h-[60vh] overflow-y-auto">
                    
                    <p class="text-gray-600">您即將預約的時段資訊如下，請確認無誤。</p>
                    
                    <!-- 預約資訊 -->
                    <div class="bg-gray-50 p-5 rounded-lg space-y-3">
                        <div>
                            <span class="text-sm font-medium text-gray-500">專案</span>
                            <p id="modal-project" class="text-lg font-semibold text-gray-900"></p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">經銷商</span>
                            <p id="modal-dealer" class="text-base text-gray-700"></p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">據點位置</span>
                            <p id="modal-location" class="text-base text-gray-700"></p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">執行月份</span>
                            <p id="modal-month" class="text-base text-gray-700"></p>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">任務重點</span>
                            <p id="modal-details" class="text-base text-gray-700"></p>
                        </div>
                    </div>

                    <!-- Email (登入後自動帶入) -->
                    <div>
                        <label for="shopper-email" class="block text-sm font-medium text-gray-700 mb-2">預約 Email</label>
                        <input type="email" id="shopper-email" name="shopper-email" required readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none bg-gray-100 text-gray-500"
                               placeholder="example@email.com">
                        <p class="text-xs text-gray-500 mt-2">此為您登入的 Email，將用於寄送確認信。</p>
                    </div>

                    <!-- 隱藏的 slotID 欄位 -->
                    <input type="hidden" id="modal-slotID" name="slotID">
                </div>

                <!-- Modal 底部按鈕 -->
                <div class="p-6 bg-gray-50 rounded-b-2xl flex items-center justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="skoda-button-outline font-medium py-2.5 px-5 rounded-lg">
                        取消
                    </button>
                    <button type="submit" id="submit-button" class="skoda-button font-bold py-2.5 px-5 rounded-lg flex items-center justify-center">
                        <svg id="submit-loader" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="submit-text">確認送出預約</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
      訊息提示框 (Message Box / Toast)
    -->
    <div id="message-box" class="hidden fixed top-20 right-5 z-50 max-w-sm w-full transition-all duration-300 opacity-0">
        <div id="message-content" class="p-4 rounded-lg shadow-lg text-white flex items-center">
            <svg id="message-icon-success" class="hidden w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <svg id="message-icon-error" class="hidden w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span id="message-text"></span>
        </div>
    </div>


    <!-- ============================================= -->
    <!-- JAVASCRIPT 程式碼 -->
    <!-- ============================================= -->
    <script>
        // =============================================
        // 設定
        // =============================================
        
        const GAS_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE_BUT_WE_ARE_NOT_USING_IT_YET";

        function formatMonthLabel(monthKey) {
            if (!monthKey) return '';
            const parts = monthKey.split('-');
            if (parts.length !== 2) return monthKey;
            const month = parts[1].startsWith('0') ? parts[1].slice(1) : parts[1];
            return `${month} 月`;
        }

        function formatFullMonth(monthKey) {
            if (!monthKey) {
                return '月份待確認';
            }
            const parts = monthKey.split('-');
            if (parts.length !== 2) {
                return monthKey;
            }
            const year = parts[0];
            const month = parts[1].startsWith('0') ? parts[1].slice(1) : parts[1];
            return `${year} 年 ${month} 月`;
        }

        function extractCityFromLocation(locationText) {
            if (!locationText) {
                return '未分類';
            }
            const parts = locationText.split('｜');
            const address = (parts[1] || parts[0] || '').trim();
            const cityMatch = address.match(/^[\u4e00-\u9fa5]{2,3}(市|縣)/);
            if (cityMatch) {
                return cityMatch[0];
            }
            const fallback = (parts[0] || '').trim();
            const fallbackMatch = fallback.match(/^[\u4e00-\u9fa5]{2,3}/);
            if (fallbackMatch) {
                const label = fallbackMatch[0];
                if (label.endsWith('市') || label.endsWith('縣')) {
                    return label;
                }
                return `${label}市`;
            }
            return '未分類';
        }

        function detectRegionFromSlot(slot) {
            if (!slot) {
                return '未分類';
            }
            const city = extractCityFromLocation(slot.location || '');
            if (city && city !== '未分類') {
                return city;
            }
            const source = `${slot.dealer || ''} ${slot.location || ''}`;
            const match = source.match(/[\u4e00-\u9fa5]{2,3}(市|縣)/);
            return match ? match[0] : '未分類';
        }

        const CITY_REGION_MAP = {
            '台北市': '北部',
            '新北市': '北部',
            '桃園市': '北部',
            '基隆市': '北部',
            '新竹市': '北部',
            '新竹縣': '北部',
            '宜蘭縣': '東部',
            '花蓮縣': '東部',
            '台東縣': '東部',
            '台中市': '中部',
            '彰化市': '中部',
            '彰化縣': '中部',
            '苗栗縣': '中部',
            '南投縣': '中部',
            '雲林縣': '中部',
            '嘉義市': '南部',
            '嘉義縣': '南部',
            '台南市': '南部',
            '高雄市': '南部',
            '屏東縣': '南部',
            '屏東市': '南部'
        };

        function mapCityToRegion(city) {
            if (!city || city === '未分類') {
                return '未分類';
            }
            const normalized = city.replace(/\s+/g, '');
            return CITY_REGION_MAP[normalized] || '未分類';
        }

        function buildDealerKey(brandName, dealer, location) {
            return `${brandName || ''}||${dealer || ''}||${location || ''}`;
        }

        function buildExperienceKey(brandName, projectId, dealer, location) {
            return `${brandName || ''}||${projectId || ''}||${dealer || ''}||${location || ''}`;
        }

        const BRAND_DATA = [
            { name: 'MAZDA', origin: '日本 / 台灣馬自達', description: '聚焦在以人為本的經典駕馭體驗與客製化賞車流程。', accent: '#BF1E2E' },
            { name: 'Škoda', origin: '捷克 / 歐洲進口', description: '強調 Simply Clever 的驚喜細節與全方位的家庭用車情境。', accent: '#0E3B33' },
            { name: 'Toyota', origin: '日本 / 和泰汽車', description: '檢視高銷量車款的交車節奏與展間待客標準化。', accent: '#EB0A1E' },
            { name: 'Volvo', origin: '瑞典 / 裕隆通用', description: '聚焦北歐豪華氛圍營造與安全科技完整介紹。', accent: '#003057' },
            { name: 'Audi', origin: '德國 / 奧迪台灣', description: '測試 premium 展間的迎賓禮儀、科技座艙演示與試駕流程。', accent: '#000000' },
            { name: 'Honda', origin: '日本 / 台灣本田', description: '確認熱銷車款排隊試乘安排與售後維護諮詢的一致性。', accent: '#DA251D' },
            { name: 'Ford', origin: '美國 / 福特六和', description: '重點檢視 Ford 純油與油電產品的體驗一致性與數位化介紹。', accent: '#003399' },
            { name: 'Volkswagen', origin: '德國 / 台灣福斯', description: '追蹤歐系主流車款的智慧互聯示範與售後承諾。', accent: '#0A3A5A' },
            { name: 'Hyundai', origin: '韓國 / 南陽實業', description: '評估現代汽車新能源與家庭休旅的展間服務節奏。', accent: '#002A5C' }
        ];

        const BRAND_ACCENT_MAP = BRAND_DATA.reduce((acc, brand) => {
            acc[brand.name] = brand.accent || '#0E3B33';
            return acc;
        }, {});

        const BRAND_PROJECTS = {
            'MAZDA': [
                {
                    id: 'mazda-cx5',
                    title: 'CX-5 暖心家庭體驗',
                    category: '家庭賞車',
                    summary: '針對家庭客層進行 CX-5 空間與安全配備說明觀察。',
                    goal: '評估展間人員是否主動協助安裝兒童座椅、介紹 i-ACTIVSENSE 配備與後續保修服務。',
                    vehicle: {
                        image: 'https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=1200&q=80',
                        imageAlt: 'Mazda CX-5 展示車',
                        segment: '智慧家庭休旅',
                        usage: '適合重視安全科技與乘坐舒適度的年輕家庭。',
                        summary: 'CX-5 採用 Skyactiv 車體結構搭配 i-ACTIVSENSE 主動安全科技，兼具操控與實用機能。',
                        trims: [
                            { name: 'Skyactiv-G 尊榮型', price: 'NT$ 1,099,000', highlight: '2.0L 汽油動力 · i-ACTIVSENSE 標配 · 適合都會家庭使用' },
                            { name: 'Signature 旗艦型', price: 'NT$ 1,259,000', highlight: '真皮內裝 · Bose 音響 · 適合假日長途旅行' }
                        ]
                    },
                    details: {
                        briefing: [
                            '觀察銷售是否主動介紹 i-ACTIVSENSE 主動安全功能並提供實際示範。',
                            '詢問兒童座椅安裝與置物空間運用，記錄銷售提供的建議與補充配件。',
                            '確認保修方案、保固期間與回廠維修流程是否講解完整。'
                        ],
                        cautions: [
                            '避免直接詢問折扣金額，維持一般家庭探訪口吻。',
                            '留意銷售是否詢問家庭成員組成並提供客製化建議。'
                        ]
                    }
                }
            ],
            'Škoda': [
                {
                    id: 'skoda-kodiaq',
                    title: 'Kodiaq 旗艦七人座任務',
                    category: '旗艦 SUV',
                    summary: '模擬高階主管考察 Kodiaq 4x4 的全方位接待流程。',
                    goal: '觀察銷售顧問是否提出七人座家庭情境建議並完整示範 Simply Clever 配備。',
                    vehicle: {
                        image: 'https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?auto=format&fit=crop&w=1200&q=80',
                        imageAlt: 'Škoda Kodiaq 展示車',
                        segment: '七人座智慧休旅',
                        usage: '適合需要靈活座椅與大容量置物的家庭或主管通勤。',
                        summary: 'Kodiaq 主打 Simply Clever 收納巧思與 4x4 穩定底盤，兼顧豪華質感與機能。',
                        trims: [
                            { name: 'Style 2.0 TSI', price: 'NT$ 1,399,000', highlight: '七座設定 · 具備 Travel Assist 與全速域 ACC' },
                            { name: 'Sportline 4x4', price: 'NT$ 1,599,000', highlight: '4x4 四輪驅動 · 黑化套件 · 適合戶外移動' }
                        ]
                    },
                    details: {
                        briefing: [
                            '確認銷售是否主動介紹第二、三排滑移與傾倒機構，並示範快速收折。',
                            '評估顧問對 Kodiaq 安全科技如 Side Assist、Front Assist 的解說深度。',
                            '詢問保固、保養與高里程客戶的維護建議，觀察回應是否具體。'
                        ],
                        cautions: [
                            '記錄銷售是否提供實際家庭情境，例如長途旅行或多人通勤安排。',
                            '若安排試駕，注意顧問是否提醒車輛高度與轉彎死角。'
                        ]
                    }
                }
            ],
            'Toyota': [
                {
                    id: 'toyota-corolla-cross',
                    title: 'Corolla Cross 熱銷流程',
                    category: '高銷量 SUV',
                    summary: '體驗熱門車款的排隊賞車及試乘節奏。',
                    goal: '確認現場動線安排、候車動態更新與追加配件溝通是否透明。',
                    vehicle: {
                        image: 'https://images.unsplash.com/photo-1611599532478-3f0c54b8d777?auto=format&fit=crop&w=1200&q=80',
                        imageAlt: 'Toyota Corolla Cross 展示車',
                        segment: '國民跨界休旅',
                        usage: '適合通勤與家庭採買，強調油耗與空間平衡。',
                        summary: 'Corolla Cross 採用 TNGA 底盤與豐富主被動安全，提供汽油與油電雙動力選擇。',
                        trims: [
                            { name: '豪華版', price: 'NT$ 839,000', highlight: 'TSS 2.0 智動駕駛輔助 · 8 吋多媒體 · 適合日常通勤' },
                            { name: 'Hybrid 旗艦版', price: 'NT$ 1,030,000', highlight: '油電複合動力 · HUD 抬頭顯示 · 適合長程節能使用' }
                        ]
                    },
                    details: {
                        briefing: [
                            '確認銷售是否主動告知候車時間與排隊流程，並提供備用方案。',
                            '詢問加價配件與保養方案，觀察是否提供透明的價格表。',
                            '記錄展示車是否提供完整消毒與試乘前安全提醒。'
                        ],
                        cautions: [
                            '維持熱門車款買家視角，避免一次詢問過多車型。',
                            '注意銷售是否主動建立聯絡機制與後續追蹤。'
                        ]
                    }
                }
            ],
            'Volvo': [
                {
                    id: 'volvo-xc40',
                    title: 'XC40 Recharge 都會純電',
                    category: '豪華純電',
                    summary: '針對都會通勤設定評估純電 SUV 的介紹深度。',
                    goal: '檢核安全科技解說、Digital Services 示範與充電資源介紹。',
                    vehicle: {
                        image: 'https://images.unsplash.com/photo-1525609004556-c46c7d6cf023?auto=format&fit=crop&w=1200&q=80',
                        imageAlt: 'Volvo XC40 Recharge 展示車',
                        segment: '北歐純電休旅',
                        usage: '適合都會通勤與週末遠行，強調安全與數位服務整合。',
                        summary: 'XC40 Recharge 採用雙馬達四驅與 Google Built-in 介面，提供先進的安全輔助與互聯功能。',
                        trims: [
                            { name: 'Twin Motor', price: 'NT$ 2,190,000', highlight: '408 匹馬力 · 418 公里續航 · 內建 Google Assistant' },
                            { name: 'Single Motor Extended', price: 'NT$ 1,890,000', highlight: '前驅配置 · 460 公里續航 · 更適合長距離通勤' }
                        ]
                    },
                    details: {
                        briefing: [
                            '觀察銷售是否解釋充電方案、家用安裝流程與公共充電資源。',
                            '確認 Pilot Assist 與 City Safety 的示範內容是否完整。',
                            '詢問 Digital Services 訂閱細節與軟體更新頻率。'
                        ],
                        cautions: [
                            '留意銷售是否主動評估買家日常里程並給予充電建議。',
                            '若安排試駕，注意能否示範單踏板駕馭與動能回收強度。'
                        ]
                    }
                }
            ],
            'Audi': [
                {
                    id: 'audi-q4',
                    title: 'Q4 e-tron 科技體驗',
                    category: '豪華純電',
                    summary: '測試 Audi 智慧座艙的沉浸式導覽。',
                    goal: '確認銷售顧問是否完成 MMI 功能示範與試駕安全提醒。',
                    vehicle: {
                        image: 'https://images.unsplash.com/photo-1605559424843-9e4c5f9c7d1c?auto=format&fit=crop&w=1200&q=80',
                        imageAlt: 'Audi Q4 e-tron 展示車',
                        segment: '豪華純電跨界',
                        usage: '適合重視科技座艙與品牌體驗的都會菁英。',
                        summary: 'Q4 e-tron 採用 MEB 純電平台，結合 AR HUD、MMI Touch 與 quattro 電子四驅科技。',
                        trims: [
                            { name: '35 e-tron advanced', price: 'NT$ 1,859,000', highlight: '後驅 170hp · 52 kWh 電池 · 都會通勤首選' },
                            { name: '50 e-tron quattro', price: 'NT$ 2,359,000', highlight: '四驅 299hp · AR 擴增實境 HUD · 長途旅行更安心' }
                        ]
                    },
                    details: {
                        briefing: [
                            '確認銷售是否示範 MMI 導航、語音助理與智慧手機連線功能。',
                            '詢問充電規劃、預約保養與原廠服務計畫，觀察是否有個人化建議。',
                            '觀察展間是否安排專屬交車區與品牌體驗導覽。'
                        ],
                        cautions: [
                            '留意銷售是否主動介紹 e-tron 專屬售後資源，例如 24H 救援。',
                            '若安排試駕，確認是否提醒動能回收段位與安全注意事項。'
                        ]
                    }
                }
            ],
            'Honda': [
                {
                    id: 'honda-crv',
                    title: 'CR-V 家庭試駕',
                    category: '家庭賞車',
                    summary: '體驗全新世代 CR-V 試駕流程與候車體驗。',
                    goal: '觀察人員對 Honda Sensing、安全配備與保固方案的介紹完整度。',
                    vehicle: {
                        image: 'https://images.unsplash.com/photo-1610465299996-26e4dd98ecff?auto=format&fit=crop&w=1200&q=80',
                        imageAlt: 'Honda CR-V 展示車',
                        segment: '家庭休旅',
                        usage: '適合需要大空間與節能動力的家庭用戶。',
                        summary: '全新 CR-V 導入更大車室、第二排滑移座椅與 Honda Sensing 360，強調安全與便利。',
                        trims: [
                            { name: '1.5 VTi-S', price: 'NT$ 1,048,000', highlight: '渦輪動力 · Honda Sensing 標配 · 適合日常代步' },
                            { name: 'e:HEV Prestige', price: 'NT$ 1,248,000', highlight: '油電系統 · 電子線傳排檔 · 適合長途省油需求' }
                        ]
                    },
                    details: {
                        briefing: [
                            '確認銷售是否講解第二排滑移與後行李空間運用，並提供家庭情境。',
                            '詢問 Honda Sensing 功能差異與維修成本，觀察說明是否具體。',
                            '記錄試駕路線、候車環境與茶點服務是否完善。'
                        ],
                        cautions: [
                            '留意銷售是否主動提醒油電車型保養差異與電池保固。',
                            '保持家庭買家角色，可關心兒童乘坐或寵物配置需求。'
                        ]
                    }
                }
            ],
            'Ford': [
                {
                    id: 'ford-kuga',
                    title: 'Kuga 智能駕馭任務',
                    category: '油電 SUV',
                    summary: '以都會家庭視角評估 Kuga 油電休旅的體驗流程。',
                    goal: '確認顧問是否主動介紹 Co-Pilot360 與 FordPass 互聯服務。',
                    vehicle: {
                        image: 'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?auto=format&fit=crop&w=1200&q=80',
                        imageAlt: 'Ford Kuga 展示車',
                        segment: '智慧油電休旅',
                        usage: '適合重視操控與科技配備的年輕家庭。',
                        summary: 'Kuga 具備 2.5L 油電動力、AWD 選項與 Co-Pilot360 智能駕駛輔助，強調運動化與安全並重。',
                        trims: [
                            { name: 'EcoBoost 180 旗馳型', price: 'NT$ 979,000', highlight: '1.5L 渦輪 · Co-Pilot360 標配 · 適合日常通勤' },
                            { name: 'EcoBoost 250 ST-Line', price: 'NT$ 1,198,000', highlight: 'AWD 四驅 · 運動化外觀套件 · 適合長途旅行' }
                        ]
                    },
                    details: {
                        briefing: [
                            '確認銷售是否示範 FordPass App 與遠端控制功能。',
                            '詢問油電保養與充電（若 PHEV）的注意事項，觀察回覆是否明確。',
                            '試駕時留意銷售是否解說 Co-Pilot360 各項輔助介入條件。'
                        ],
                        cautions: [
                            '保持運動化家庭買家設定，可關心性能與油耗平衡。',
                            '記錄銷售是否提供保險、延長保固等加值服務的資訊。'
                        ]
                    }
                }
            ],
            'Volkswagen': [
                {
                    id: 'vw-tiguan',
                    title: 'Tiguan Life 智慧互聯',
                    category: '德系休旅',
                    summary: '聚焦 Tiguan Life 互聯科技與家庭實用配備的導覽。',
                    goal: '觀察顧問對 IQ.Drive 功能與保固維修方案的溝通完整度。',
                    vehicle: {
                        image: 'https://images.unsplash.com/photo-1603384695633-9d6672f0c092?auto=format&fit=crop&w=1200&q=80',
                        imageAlt: 'Volkswagen Tiguan 展示車',
                        segment: '歐系智慧休旅',
                        usage: '適合重視歐系操控與互聯科技的家庭旅遊族群。',
                        summary: 'Tiguan 搭載 IQ.Drive 智能輔助與 12 吋全數位座艙，提供靈活座椅與豐富安全配備。',
                        trims: [
                            { name: '280 TSI Life', price: 'NT$ 1,168,000', highlight: 'IQ.Drive 輔助 · Discover Pro 9.2 吋主機' },
                            { name: '330 TSI Elegance', price: 'NT$ 1,288,000', highlight: '4Motion 四驅 · 鋁合金套件 · 適合長程自駕' }
                        ]
                    },
                    details: {
                        briefing: [
                            '確認銷售是否示範 IQ.Drive 操作並說明 ACC、車道維持限制。',
                            '詢問 5+2 年保固與定保方案，觀察資訊是否清楚。',
                            '檢視後座與行李廂變化示範是否完整，包含滑移與分離傾倒。'
                        ],
                        cautions: [
                            '留意銷售是否主動介紹車聯網 We Connect 功能與年費。',
                            '保持歐系家庭買家角度，可關心海外旅行載物與安全配備。'
                        ]
                    }
                }
            ],
            'Hyundai': [
                {
                    id: 'hyundai-ioniq5',
                    title: 'IONIQ 5 科技生活體驗',
                    category: '純電跨界',
                    summary: '以科技家庭為設定，檢視 IONIQ 5 的展示與交付流程。',
                    goal: '評估顧問如何說明 V2L、充電資源與智慧安全科技。',
                    vehicle: {
                        image: 'https://images.unsplash.com/photo-1620891549027-019d98aa4301?auto=format&fit=crop&w=1200&q=80',
                        imageAlt: 'Hyundai IONIQ 5 展示車',
                        segment: '純電跨界休旅',
                        usage: '適合科技家庭與露營族，強調車內供電與快充能力。',
                        summary: 'IONIQ 5 採 E-GMP 平台、800V 高壓快充與 V2L 供電功能，營造未來感座艙。',
                        trims: [
                            { name: 'Elite', price: 'NT$ 1,599,000', highlight: '後驅 58 kWh · 400V 快充 · 適合都會往返' },
                            { name: 'Performance AWD', price: 'NT$ 1,889,000', highlight: '雙馬達四驅 · 77.4 kWh · 支援 800V 超高速充電' }
                        ]
                    },
                    details: {
                        briefing: [
                            '確認銷售是否解說充電等級、家用充電安裝時程與合作廠商。',
                            '請對方示範 V2L 對外供電操作與安全注意事項。',
                            '觀察交付說明是否包含 OTA 更新、保固與道路救援。'
                        ],
                        cautions: [
                            '留意銷售是否提供實際耗電量與冬季里程資訊。',
                            '保持科技生活族視角，可詢問與智慧家庭設備的整合。'
                        ]
                    }
                }
            ]
        };

        const PROJECT_MAP = BRAND_DATA.reduce((acc, brand) => {
            const projects = BRAND_PROJECTS[brand.name] || [];
            projects.forEach(project => {
                acc[project.id] = { ...project, brandName: brand.name, brandAccent: brand.accent };
            });
            return acc;
        }, {});

        const SEASONAL_LOCATIONS = {
            '2025-11': ['台北內湖', '新竹東區', '台中公益', '台南永康', '高雄鳳山', '花蓮吉安'],
            '2025-12': ['台北士林', '台北敦化', '桃園藝文', '新莊輔大', '板橋文化', '台中中清', '彰化中山', '嘉義民族', '台南安平', '高雄博愛', '屏東建國', '宜蘭羅東', '新北林口']
        };

        const LOCATION_DIRECTORY = {
            '台北內湖': '台北市內湖區瑞光路 168 號',
            '新竹東區': '新竹市東區光復路二段 386 號',
            '台中公益': '台中市南屯區公益路二段 600 號',
            '台南永康': '台南市永康區中正路 599 號',
            '高雄鳳山': '高雄市鳳山區青年路二段 238 號',
            '花蓮吉安': '花蓮縣吉安鄉中山路三段 88 號',
            '台北士林': '台北市士林區承德路四段 200 號',
            '台北敦化': '台北市大安區敦化南路一段 166 號',
            '桃園藝文': '桃園市桃園區藝文一街 88 號',
            '新莊輔大': '新北市新莊區中正路 510 號',
            '板橋文化': '新北市板橋區文化路一段 280 號',
            '台中中清': '台中市北屯區中清路二段 888 號',
            '彰化中山': '彰化市中山路一段 390 號',
            '嘉義民族': '嘉義市民族路 455 號',
            '台南安平': '台南市安平區府前路二段 300 號',
            '高雄博愛': '高雄市左營區博愛二路 366 號',
            '屏東建國': '屏東市建國路 120 號',
            '宜蘭羅東': '宜蘭縣羅東鎮中山路三段 250 號',
            '新北林口': '新北市林口區文化三路一段 356 號'
        };

        const PROJECT_AVAILABILITY = {
            'mazda-cx5': {
                brand: 'MAZDA',
                dealerPrefix: 'MAZDA',
                dealerSuffix: ' 展示中心',
                details: '體驗 CX-5 的人因工學座椅調整、i-ACTIVSENSE 示範與售後保修諮詢。'
            },
            'skoda-kodiaq': {
                brand: 'Škoda',
                dealerPrefix: 'Škoda 太古',
                dealerSuffix: ' 體驗中心',
                details: '確認七人座彈性座椅展示、Simply Clever 配件操作與交車保固說明。'
            },
            'toyota-corolla-cross': {
                brand: 'Toyota',
                dealerPrefix: 'Toyota 和泰',
                dealerSuffix: ' 展示據點',
                details: '觀察熱門車款排隊流程、配件解說與候車通知是否到位。'
            },
            'volvo-xc40': {
                brand: 'Volvo',
                dealerPrefix: 'Volvo 北歐',
                dealerSuffix: ' 品牌中心',
                details: '檢視 XC40 Recharge 的安全科技、Google 互聯功能與充電規劃建議。'
            },
            'audi-q4': {
                brand: 'Audi',
                dealerPrefix: 'Audi Premium',
                dealerSuffix: ' 體驗館',
                details: '體驗 Audi 智慧座艙、MMI 導覽與 e-tron 專屬交車說明。'
            },
            'honda-crv': {
                brand: 'Honda',
                dealerPrefix: 'Honda 直營',
                dealerSuffix: ' 展示中心',
                details: '確認 CR-V 家庭配備介紹、Honda Sensing 示範與保固維修安排。'
            },
            'ford-kuga': {
                brand: 'Ford',
                dealerPrefix: 'Ford 六和',
                dealerSuffix: ' 體驗中心',
                details: '檢查 Kuga Co-Pilot360 說明、FordPass App 示範與油電差異溝通。'
            },
            'vw-tiguan': {
                brand: 'Volkswagen',
                dealerPrefix: 'VW 授權',
                dealerSuffix: ' 展示空間',
                details: '了解 Tiguan Life IQ.Drive 功能、車聯網操作與保修方案。'
            },
            'hyundai-ioniq5': {
                brand: 'Hyundai',
                dealerPrefix: 'Hyundai 現代',
                dealerSuffix: ' 體驗館',
                details: '體驗 IONIQ 5 V2L 應用、Bluelink 連線與充電資源導覽。'
            }
        };

        function buildSlotsFromAvailability(availability) {
            const slots = [];
            Object.entries(availability).forEach(([projectId, config]) => {
                Object.entries(SEASONAL_LOCATIONS).forEach(([monthKey, placeList]) => {
                    placeList.forEach((place, index) => {
                        const dealerName = `${config.dealerPrefix || config.brand} ${place}${config.dealerSuffix || ''}`
                            .replace(/\s{2,}/g, ' ')
                            .trim();
                        const address = LOCATION_DIRECTORY[place] || `${place}展示中心`;
                        slots.push({
                            slotID: `${projectId}-${monthKey.replace('-', '')}-${String(index + 1).padStart(2, '0')}`,
                            brand: config.brand,
                            projectId,
                            month: monthKey,
                            monthLabel: formatMonthLabel(monthKey),
                            dealer: dealerName,
                            location: `${place}展示中心｜${address}`,
                            details: config.details
                        });
                    });
                });
            });
            return slots;
        }

        // [開發者註記] 模擬資料庫
        const INITIAL_SLOTS = buildSlotsFromAvailability(PROJECT_AVAILABILITY);
        const TOTAL_INITIAL_SLOTS = INITIAL_SLOTS.length;
        const INITIAL_SLOTS_BY_BRAND = INITIAL_SLOTS.reduce((acc, slot) => {
            acc[slot.brand] = (acc[slot.brand] || 0) + 1;
            return acc;
        }, {});
        const INITIAL_SLOTS_BY_PROJECT = INITIAL_SLOTS.reduce((acc, slot) => {
            acc[slot.projectId] = (acc[slot.projectId] || 0) + 1;
            return acc;
        }, {});
        const INITIAL_SLOTS_BY_DEALER = INITIAL_SLOTS.reduce((acc, slot) => {
            const key = `${slot.brand}||${slot.dealer}`;
            acc[key] = (acc[key] || 0) + 1;
            return acc;
        }, {});
        const INITIAL_SLOTS_BY_EXPERIENCE = INITIAL_SLOTS.reduce((acc, slot) => {
            const key = buildExperienceKey(slot.brand, slot.projectId, slot.dealer, slot.location);
            acc[key] = (acc[key] || 0) + 1;
            return acc;
        }, {});
        let MOCK_SLOTS_DATA = {
            "slots": [...INITIAL_SLOTS]
        };
        
        // [開發者註記] 模擬使用者登入狀態
        let CURRENT_USER = {
            email: null,
            name: null,
            role: null
        };

        let SELECTED_BRAND = null;
        let SELECTED_EXPERIENCE = null;
        let ADMIN_SELECTED_BRAND = null;

        // [開發者註記] 模擬已核准的使用者（含雙重驗證碼）
        const MOCK_APPROVED_USERS = [ 
            {
                email: "tust@gmail.com",
                name: "管理者測試帳號",
                password: "123456",
                twoFactorCode: "123456",
                role: "admin"
            },
            {
                email: "tust2@gmail.com",
                name: "神秘客測試帳號",
                password: "123456",
                twoFactorCode: "123456",
                role: "member"
            }
        ];


        // =============================================
        // DOM 元素選取
        // =============================================
        // 頁面
        const pageLogin = document.getElementById('page-login');
        const pageBrandHome = document.getElementById('page-brand-home');
        const pageBooking = document.getElementById('page-booking');
        const pageAdminDashboard = document.getElementById('page-admin-dashboard');
        const pageRegister = document.getElementById('page-register');
        
        // 導航
        const navLoggedIn = document.getElementById('nav-logged-in');
        const navLoggedOut = document.getElementById('nav-logged-out');
        const navLinkLoginPage = document.getElementById('nav-link-login-page');
        const navLinkRegisterPage = document.getElementById('nav-link-register-page');
        const navLinkBrandHome = document.getElementById('nav-link-brand-home');
        const navLinkAdminDashboard = document.getElementById('nav-link-admin-dashboard');
        const logoutButton = document.getElementById('logout-button');
        const welcomeMessage = document.getElementById('welcome-message');

        // 品牌首頁
        const brandGrid = document.getElementById('brand-grid');
        const brandCardTemplate = document.getElementById('brand-card-template');
        const brandListEmpty = document.getElementById('brand-list-empty');
        const brandSelectionEmpty = document.getElementById('brand-selection-empty');
        const brandSelectionPanel = document.getElementById('brand-selection-panel');
        const brandSelectionBreadcrumb = document.getElementById('brand-selection-breadcrumb');
        const brandSelectionTitle = document.getElementById('brand-selection-title');
        const brandSelectionSubtitle = document.getElementById('brand-selection-subtitle');
        const brandSelectionRemaining = document.getElementById('brand-selection-remaining');
        const regionOverviewBody = document.getElementById('region-overview-body');
        const regionOverviewEmpty = document.getElementById('region-overview-empty');
        const brandAvailabilityList = document.getElementById('brand-availability-list');
        const brandAvailabilityEmpty = document.getElementById('brand-availability-empty');
        const experienceCardTemplate = document.getElementById('experience-card-template');

        // 預約頁面標頭與詳情
        const bookingBreadcrumb = document.getElementById('booking-breadcrumb');
        const bookingBackButton = document.getElementById('booking-back-button');
        const experienceVehicleImage = document.getElementById('experience-vehicle-image');
        const experienceVehicleClass = document.getElementById('experience-vehicle-class');
        const experienceTitle = document.getElementById('experience-title');
        const experienceDealer = document.getElementById('experience-dealer');
        const experienceLocation = document.getElementById('experience-location');
        const experienceUsage = document.getElementById('experience-usage');
        const experienceVehicleSummary = document.getElementById('experience-vehicle-summary');
        const experienceMission = document.getElementById('experience-mission');
        const experienceHighlights = document.getElementById('experience-highlights');
        const experienceCautions = document.getElementById('experience-cautions');
        const experienceTrims = document.getElementById('experience-trims');
        const experienceRemainingBadge = document.getElementById('experience-remaining-badge');
        const experienceNextSlot = document.getElementById('experience-next-slot');

        // 管理儀表板元素
        const adminTotalBrands = document.getElementById('admin-total-brands');
        const adminTotalProjects = document.getElementById('admin-total-projects');
        const adminOpenSlots = document.getElementById('admin-open-slots');
        const adminUtilizationRate = document.getElementById('admin-utilization-rate');
        const adminBrandTableBody = document.getElementById('admin-brand-table-body');
        const adminBrandTableEmpty = document.getElementById('admin-brand-table-empty');
        const adminUpcomingList = document.getElementById('admin-upcoming-list');
        const adminUpcomingEmpty = document.getElementById('admin-upcoming-empty');
        const adminMonthlySummary = document.getElementById('admin-monthly-summary');
        const adminMonthlyEmpty = document.getElementById('admin-monthly-empty');
        const adminBrandDetailSection = document.getElementById('admin-brand-detail');
        const adminBrandDetailCard = document.getElementById('admin-brand-detail-card');
        const adminBrandDetailBreadcrumb = document.getElementById('admin-brand-detail-breadcrumb');
        const adminBrandDetailTitle = document.getElementById('admin-brand-detail-title');
        const adminBrandDetailDescription = document.getElementById('admin-brand-detail-description');
        const adminBrandDetailRemaining = document.getElementById('admin-brand-detail-remaining');
        const adminBrandDetailBooked = document.getElementById('admin-brand-detail-booked');
        const adminBrandDetailUtilization = document.getElementById('admin-brand-detail-utilization');
        const adminBrandDetailNext = document.getElementById('admin-brand-detail-next');
        const adminBrandDetailProjects = document.getElementById('admin-brand-detail-projects');
        const adminBrandDetailProjectsEmpty = document.getElementById('admin-brand-detail-projects-empty');
        const adminBrandDetailRegionBody = document.getElementById('admin-brand-detail-region-body');
        const adminBrandDetailRegionEmpty = document.getElementById('admin-brand-detail-region-empty');
        const adminBrandDetailDealerBody = document.getElementById('admin-brand-detail-dealer-body');
        const adminBrandDetailDealerEmpty = document.getElementById('admin-brand-detail-dealer-empty');

        // 登入頁面
        const loginForm = document.getElementById('login-form');
        const loginErrorContainer = document.getElementById('login-error-container');
        const loginErrorMessage = document.getElementById('login-error-message');
        const loginSubmitButton = document.getElementById('login-submit-button');
        const loginSubmitLoader = document.getElementById('login-submit-loader');
        const loginSubmitText = document.getElementById('login-submit-text');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginOtpInput = document.getElementById('login-otp');
        const loginStepOneContainer = document.getElementById('login-step-one');
        const loginStepTwoContainer = document.getElementById('login-step-two');
        const loginStepTwoMessage = document.getElementById('login-step-two-message');
        const twoFactorHint = document.getElementById('two-factor-hint');
        const loginBackButton = document.getElementById('login-back-button');

        // 預約頁面
        const loadingContainer = document.getElementById('loading-container');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const slotsContainer = document.getElementById('slots-container');
        const slotsEmptyState = document.getElementById('slots-empty');
        const slotItemTemplate = document.getElementById('slot-item-template');
        
        // Modal
        const bookingModal = document.getElementById('booking-modal');
        const modalCard = document.getElementById('modal-card');
        const bookingForm = document.getElementById('booking-form');
        const submitButton = document.getElementById('submit-button');
        const submitLoader = document.getElementById('submit-loader');
        const submitText = document.getElementById('submit-text');
        
        // 註冊頁面
        const registrationForm = document.getElementById('registration-form');
        const regSubmitButton = document.getElementById('register-submit-button');
        const regSubmitLoader = document.getElementById('register-submit-loader');
        const regSubmitText = document.getElementById('register-submit-text');
        const regNameInput = document.getElementById('reg-name');
        const regEmailInput = document.getElementById('reg-email');
        const regPasswordInput = document.getElementById('reg-password');
        const regPasswordConfirmInput = document.getElementById('reg-password-confirm');

        // 訊息提示框
        const messageBox = document.getElementById('message-box');
        const messageContent = document.getElementById('message-content');
        const messageText = document.getElementById('message-text');
        const iconSuccess = document.getElementById('message-icon-success');
        const iconError = document.getElementById('message-icon-error');

        let messageTimer;
        let loginStep = 1;
        let pendingUser = null;

        // =============================================
        // 核心流程
        // =============================================

        // 1. 頁面載入時執行
        document.addEventListener('DOMContentLoaded', () => {
            // [開發者註記] 預設顯示登入頁面
            renderBrandCards();
            if (brandRegionFilter) {
                brandRegionFilter.addEventListener('change', handleBrandFiltersChanged);
            }
            if (brandMonthFilter) {
                brandMonthFilter.addEventListener('change', handleBrandFiltersChanged);
            }
            if (brandSearchInput) {
                brandSearchInput.addEventListener('input', () => {
                    activeBrandFilters.search = brandSearchInput.value || '';
                    renderBrandAvailabilityList();
                });
            }
            showPage('login');
            setupNavigation();
            setLoginStep(1);
        });

        // 2. [新] 處理登入 - [模擬模式]
        async function handleLoginSubmit(event) {
            event.preventDefault();

            loginErrorContainer.classList.add('hidden');

            if (loginStep === 1) {
                const email = loginEmailInput.value.trim().toLowerCase();
                const password = loginPasswordInput.value;

                if (!email || !password) {
                    loginErrorMessage.textContent = "請輸入完整的 Email 與密碼。";
                    loginErrorContainer.classList.remove('hidden');
                    return;
                }

                showLoginLoading(true);

                setTimeout(() => {
                    const matchedUser = MOCK_APPROVED_USERS.find(user => user.email.toLowerCase() === email);

                    if (!matchedUser || matchedUser.password !== password) {
                        showLoginLoading(false);
                        loginErrorMessage.textContent = "帳號或密碼錯誤，或尚未通過審核。";
                        loginErrorContainer.classList.remove('hidden');
                        pendingUser = null;
                        return;
                    }

                    pendingUser = matchedUser;
                    setLoginStep(2);
                    loginStepTwoMessage.textContent = `驗證碼已傳送至 ${pendingUser.email}，請於 5 分鐘內輸入 6 位數代碼完成登入。`;
                    twoFactorHint.textContent = `（測試用驗證碼：${pendingUser.twoFactorCode}）`;
                    loginOtpInput.value = '';
                    showLoginLoading(false);
                    showMessage('success', '帳號密碼驗證成功，請輸入驗證碼完成登入。');
                }, 1000);
            } else if (loginStep === 2) {
                const otp = loginOtpInput.value.trim();

                if (!otp || otp.length !== 6) {
                    loginErrorMessage.textContent = "請輸入 6 位數驗證碼。";
                    loginErrorContainer.classList.remove('hidden');
                    return;
                }

                showLoginLoading(true);

                setTimeout(() => {
                    if (pendingUser && otp === pendingUser.twoFactorCode) {
                        CURRENT_USER.email = pendingUser.email;
                        CURRENT_USER.name = pendingUser.name;
                        CURRENT_USER.role = pendingUser.role;

                        SELECTED_BRAND = null;
                        SELECTED_EXPERIENCE = null;
                        hideBrandSelection();
                        renderBrandCards();
                        renderRegionOverview();

                        showLoginLoading(false);
                        resetLoginForm();
                        updateNavUI(true);
                        if (CURRENT_USER.role === 'admin') {
                            showAdminDashboard();
                        } else {
                            showBrandHome();
                        }
                        showMessage('success', '登入成功！');
                    } else {
                        showLoginLoading(false);
                        loginErrorMessage.textContent = "驗證碼錯誤，請再試一次。";
                        loginErrorContainer.classList.remove('hidden');
                    }
                }, 1000);
            }
        }
        
        // 3. [新] 處理登出
        function handleLogout() {
            CURRENT_USER.email = null;
            CURRENT_USER.name = null;
            CURRENT_USER.role = null;
            SELECTED_BRAND = null;
            SELECTED_EXPERIENCE = null;
            ADMIN_SELECTED_BRAND = null;
            hideBrandSelection();
            renderBrandCards();
            updateExperienceHeader();
            updateNavUI(false);
            resetLoginForm();
            showPage('login');
            if (slotsContainer) {
                slotsContainer.innerHTML = '';
            }
            if (slotsEmptyState) {
                slotsEmptyState.classList.add('hidden');
            }
            renderRegionOverview();
            refreshAdminDashboardIfVisible();
        }

        function showBrandHome(targetBrand = null) {
            if (!CURRENT_USER.email) {
                showPage('login');
                return;
            }
            if (CURRENT_USER.role === 'admin') {
                showAdminDashboard();
                return;
            }

            SELECTED_PROJECT = null;
            SELECTED_DEALER = null;

            if (typeof targetBrand === 'string') {
                SELECTED_BRAND = targetBrand;
            }

            SELECTED_EXPERIENCE = null;
            updateExperienceHeader();

            showPage('brand-home');

            renderBrandCards();

            if (SELECTED_BRAND) {
                openBrandForBooking(SELECTED_BRAND);
            } else {
                hideBrandSelection();
            }
        }

        function showAdminDashboard() {
            if (!CURRENT_USER.email || CURRENT_USER.role !== 'admin') {
                showBrandHome();
                return;
            }

            renderAdminDashboard();
            showPage('admin');
        }

        function renderBrandCards() {
            if (!brandCardTemplate || !brandGrid) {
                return;
            }

            brandGrid.innerHTML = '';

            const sortedBrands = [...BRAND_DATA].sort((a, b) => {
                const aSlots = getBrandSlots(a.name).length;
                const bSlots = getBrandSlots(b.name).length;
                if (bSlots !== aSlots) {
                    return bSlots - aSlots;
                }
                return a.name.localeCompare(b.name, 'zh-Hant');
            });

            sortedBrands.forEach(brand => {
                const fragment = brandCardTemplate.content.cloneNode(true);
                const button = fragment.querySelector('.brand-card');
                const nameEl = fragment.querySelector('.brand-name');
                const originEl = fragment.querySelector('.brand-origin');
                const remainingEl = fragment.querySelector('.brand-remaining');

                const brandSlots = getBrandSlots(brand.name);

                if (nameEl) {
                    nameEl.textContent = brand.name;
                }
                if (originEl) {
                    originEl.textContent = brand.origin || '';
                    originEl.style.color = brand.accent || '#0E3B33';
                }
                if (remainingEl) {
                    remainingEl.textContent = `剩餘 ${brandSlots.length}`;
                }

                const accent = brand.accent || '#0E3B33';
                button.dataset.brand = brand.name;
                if (SELECTED_BRAND === brand.name) {
                    button.classList.add('active');
                    button.style.borderColor = accent;
                } else {
                    button.classList.remove('active');
                    button.style.borderColor = '#e5e7eb';
                }

                button.addEventListener('click', () => openBrandForBooking(brand.name));

                brandGrid.appendChild(fragment);
            });

            if (brandListEmpty) {
                if (!sortedBrands.length) {
                    brandListEmpty.classList.remove('hidden');
                } else {
                    brandListEmpty.classList.add('hidden');
                }
            }
        }

        function renderRegionOverview() {
            if (!regionOverviewBody) {
                return;
            }

            const summaryMap = new Map();
            const slots = MOCK_SLOTS_DATA.slots || [];

            slots.forEach(slot => {
                const city = detectRegionFromSlot(slot);
                const region = mapCityToRegion(city);
                if (!summaryMap.has(region)) {
                    summaryMap.set(region, new Map());
                }
                const brandMap = summaryMap.get(region);
                const brandName = slot.brand || '其他';
                brandMap.set(brandName, (brandMap.get(brandName) || 0) + 1);
            });

            const regionsOrder = ['北部', '中部', '南部', '東部', '未分類'];
            const regionSummaries = regionsOrder.map(region => {
                const brandMap = summaryMap.get(region) || new Map();
                const entries = Array.from(brandMap.entries()).sort((a, b) => {
                    if (b[1] !== a[1]) {
                        return b[1] - a[1];
                    }
                    return a[0].localeCompare(b[0], 'zh-Hant');
                });
                const total = entries.reduce((sum, [, count]) => sum + count, 0);
                return { region, entries, total };
            });

            const hasAnySlot = regionSummaries.some(entry => entry.total > 0);
            regionOverviewBody.innerHTML = '';

            if (!hasAnySlot) {
                if (regionOverviewEmpty) {
                    regionOverviewEmpty.classList.remove('hidden');
                }
                return;
            }

            if (regionOverviewEmpty) {
                regionOverviewEmpty.classList.add('hidden');
            }

            const maxTotal = regionSummaries.reduce((max, entry) => Math.max(max, entry.total), 0);

            regionSummaries.forEach(({ region, entries, total }) => {
                const row = document.createElement('tr');
                row.className = 'group border-b border-gray-100 last:border-b-0';

                const regionCell = document.createElement('td');
                regionCell.className = 'px-6 py-5 align-top bg-white transition-colors group-hover:bg-emerald-50/40';
                const brandCountLabel = entries.length ? `${entries.length} 個品牌可預約` : '暫無可預約品牌';
                const progressPercent = maxTotal ? Math.round((total / maxTotal) * 100) : 0;
                const progressWidth = total === 0 ? 0 : Math.min(100, Math.max(18, progressPercent));
                regionCell.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <p class="text-base font-semibold text-gray-900">${region}</p>
                                <p class="mt-1 text-xs text-gray-400">${brandCountLabel}</p>
                            </div>
                            <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-xs font-semibold text-emerald-700">剩餘 ${total} 場</span>
                        </div>
                        <div class="h-1.5 rounded-full bg-emerald-100/70 overflow-hidden">
                            <div class="h-full rounded-full bg-emerald-500 transition-all duration-500" style="width: ${progressWidth}%;"></div>
                        </div>
                    </div>
                `;

                const brandCell = document.createElement('td');
                brandCell.className = 'px-6 py-5 align-top bg-white transition-colors group-hover:bg-emerald-50/40';

                if (entries.length) {
                    const wrap = document.createElement('div');
                    wrap.className = 'flex flex-wrap gap-2';
                    entries.forEach(([brandName, count], index) => {
                        const accent = BRAND_ACCENT_MAP[brandName] || '#047857';
                        const chip = document.createElement('button');
                        chip.type = 'button';
                        chip.className = 'inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold text-white shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-emerald-500';
                        chip.style.backgroundColor = accent;
                        chip.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
                        const highlightShadow = `0 10px 22px -14px ${accent}cc`;
                        if (index === 0) {
                            chip.style.boxShadow = highlightShadow;
                        }
                        chip.innerHTML = `
                            <span class="text-sm font-semibold tracking-tight">${brandName}</span>
                            <span class="inline-flex items-center rounded-full bg-white/25 px-2 py-0.5 text-[11px] font-medium">剩 ${count}</span>
                        `;
                        chip.addEventListener('mouseenter', () => {
                            chip.style.transform = 'translateY(-1px)';
                            chip.style.boxShadow = highlightShadow;
                        });
                        chip.addEventListener('mouseleave', () => {
                            chip.style.transform = 'translateY(0)';
                            chip.style.boxShadow = index === 0 ? highlightShadow : 'none';
                        });
                        chip.addEventListener('click', () => {
                            SELECTED_BRAND = brandName;
                            SELECTED_EXPERIENCE = null;
                            showBrandHome(brandName);
                        });
                        wrap.appendChild(chip);
                    });
                    brandCell.appendChild(wrap);

                    const [topBrandName, topCount] = entries[0] || [];
                    if (topBrandName) {
                        const accent = BRAND_ACCENT_MAP[topBrandName] || '#047857';
                        const highlight = document.createElement('div');
                        highlight.className = 'mt-4 flex flex-wrap items-center gap-3 rounded-2xl px-4 py-3 text-xs';
                        highlight.innerHTML = `
                            <span class="top-brand-name text-sm font-semibold">${topBrandName}</span>
                            <span class="top-brand-copy text-xs sm:text-sm">熱門任務剩餘 ${topCount} 場，點擊查看完整場次。</span>
                            <button type="button" class="top-brand-action inline-flex items-center gap-1 text-xs font-semibold focus:outline-none focus:underline">
                                查看全場次
                                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        `;
                        highlight.style.border = `1px dashed ${accent}66`;
                        highlight.style.backgroundColor = `${accent}12`;
                        highlight.style.boxShadow = `0 12px 24px -16px ${accent}4d`;
                        highlight.style.color = accent;

                        const highlightName = highlight.querySelector('.top-brand-name');
                        const highlightCopy = highlight.querySelector('.top-brand-copy');
                        const highlightButton = highlight.querySelector('.top-brand-action');

                        if (highlightName) {
                            highlightName.style.color = accent;
                        }
                        if (highlightCopy) {
                            highlightCopy.style.color = `${accent}cc`;
                        }
                        if (highlightButton) {
                            highlightButton.style.color = accent;
                            highlightButton.addEventListener('mouseenter', () => {
                                highlightButton.style.opacity = '0.8';
                            });
                            highlightButton.addEventListener('mouseleave', () => {
                                highlightButton.style.opacity = '1';
                            });
                            highlightButton.addEventListener('click', () => {
                                SELECTED_BRAND = topBrandName;
                                SELECTED_EXPERIENCE = null;
                                showBrandHome(topBrandName);
                            });
                        }

                        brandCell.appendChild(highlight);
                    }
                } else {
                    brandCell.innerHTML = `
                        <div class="rounded-2xl border border-dashed border-gray-300 bg-gray-50 px-4 py-6 text-center text-sm text-gray-400">
                            目前沒有可預約的品牌，請稍後再查看。
                        </div>
                    `;
                }

                row.appendChild(regionCell);
                row.appendChild(brandCell);
                regionOverviewBody.appendChild(row);
            });

            if (regionOverviewEmpty) {
                if (hasData) {
                    regionOverviewEmpty.classList.add('hidden');
                } else {
                    regionOverviewEmpty.classList.remove('hidden');
                }
            }
        }

        function hideBrandSelection() {
            if (brandSelectionPanel) {
                brandSelectionPanel.classList.add('hidden');
            }
            if (brandSelectionBreadcrumb) {
                renderBreadcrumb(brandSelectionBreadcrumb, []);
            }
            if (brandSelectionTitle) {
                brandSelectionTitle.textContent = '';
            }
            if (brandSelectionSubtitle) {
                brandSelectionSubtitle.textContent = '';
            }
            if (brandSelectionRemaining) {
                brandSelectionRemaining.classList.add('hidden');
                brandSelectionRemaining.textContent = '';
            }
            if (brandAvailabilityList) {
                brandAvailabilityList.innerHTML = '';
            }
            if (brandAvailabilityEmpty) {
                brandAvailabilityEmpty.classList.add('hidden');
            }
            if (brandSelectionEmpty) {
                brandSelectionEmpty.classList.remove('hidden');
            }
            renderRegionOverview();
        }

        function openBrandForBooking(brandName) {
            if (!CURRENT_USER.email) {
                showPage('login');
                return;
            }

            const brandInfo = BRAND_DATA.find(brand => brand.name === brandName);
            if (!brandInfo) {
                showMessage('error', '找不到品牌資訊，請重新整理頁面。');
                return;
            }

            const brandInfo = BRAND_DATA.find(brand => brand.name === brandName);
            if (!brandInfo) {
                showMessage('error', '找不到品牌資訊，請重新整理頁面。');
                return;
            }

            SELECTED_BRAND = brandName;
            SELECTED_EXPERIENCE = null;

            const brandSlots = getBrandSlots(brandName);
            renderBrandCards();
            renderBrandSummary(brandInfo, brandSlots);
            renderBrandAvailabilityList();
        }

        function renderBrandSummary(brandInfo, brandSlots) {
            if (!brandSelectionPanel) {
                return;
            }

            if (brandSelectionEmpty) {
                brandSelectionEmpty.classList.add('hidden');
            }
            brandSelectionPanel.classList.remove('hidden');

            if (brandSelectionBreadcrumb) {
                renderBreadcrumb(brandSelectionBreadcrumb, [
                    {
                        label: '品牌首頁',
                        action: () => {
                            SELECTED_BRAND = null;
                            SELECTED_EXPERIENCE = null;
                            showBrandHome();
                        }
                    },
                    {
                        label: brandInfo.name,
                        action: () => showBrandHome(brandInfo.name),
                        isCurrent: true
                    }
                ]);
            }

            const accent = brandInfo.accent || '#0E3B33';
            const nextSlotLabel = getNextSlotForBrand(brandInfo.name) || '尚未開放';
            const citySet = new Set(
                brandSlots
                    .map(slot => detectRegionFromSlot(slot))
                    .filter(city => city && city !== '未分類')
            );

            if (brandSelectionTitle) {
                brandSelectionTitle.textContent = `${brandInfo.name} 任務預約`;
                brandSelectionTitle.style.color = accent;
            }
            if (brandSelectionSubtitle) {
                brandSelectionSubtitle.textContent = '選擇下方據點卡片查看任務詳情與可預約時段。';
            }
            if (brandSelectionRemaining) {
                brandSelectionRemaining.textContent = `剩餘 ${brandSlots.length} 場 · ${citySet.size} 個城市 · 最近 ${nextSlotLabel}`;
                if (brandSlots.length > 0) {
                    brandSelectionRemaining.classList.remove('hidden');
                } else {
                    brandSelectionRemaining.classList.add('hidden');
                }
            }
        }

        function renderBrandAvailabilityList() {
            if (!brandAvailabilityList) {
                return;
            }

            brandAvailabilityList.innerHTML = '';

            if (!SELECTED_BRAND) {
                if (brandAvailabilityEmpty) {
                    brandAvailabilityEmpty.classList.add('hidden');
                }
                return;
            }

            const brandInfo = BRAND_DATA.find(brand => brand.name === SELECTED_BRAND);
            if (!brandInfo) {
                if (brandAvailabilityEmpty) {
                    brandAvailabilityEmpty.classList.remove('hidden');
                }
                return;
            }
            const accent = brandInfo.accent || '#0E3B33';
            const brandSlots = getBrandSlots(SELECTED_BRAND);

            const experienceMap = new Map();

            brandSlots.forEach(slot => {
                const experienceKey = buildExperienceKey(SELECTED_BRAND, slot.projectId, slot.dealer, slot.location);
                if (!experienceMap.has(experienceKey)) {
                    const city = detectRegionFromSlot(slot);
                    experienceMap.set(experienceKey, {
                        key: experienceKey,
                        projectId: slot.projectId,
                        dealer: slot.dealer || '經銷據點待確認',
                        location: slot.location || '',
                        city,
                        macroRegion: mapCityToRegion(city),
                        slots: []
                    });
                }

                const entry = experienceMap.get(experienceKey);
                entry.slots.push(slot);
            });

            const experiences = Array.from(experienceMap.values()).sort((a, b) => {
                if (b.slots.length !== a.slots.length) {
                    return b.slots.length - a.slots.length;
                }
                const projectA = PROJECT_MAP[a.projectId] || {};
                const projectB = PROJECT_MAP[b.projectId] || {};
                return (projectA.title || '').localeCompare(projectB.title || '', 'zh-Hant');
            });

            if (!experiences.length) {
                if (brandAvailabilityEmpty) {
                    brandAvailabilityEmpty.classList.remove('hidden');
                }
                return;
            }

            if (brandAvailabilityEmpty) {
                brandAvailabilityEmpty.classList.add('hidden');
            }

            experiences.forEach(entry => {
                if (!experienceCardTemplate) {
                    return;
                }
                const fragment = experienceCardTemplate.content.cloneNode(true);
                const cardRoot = fragment.querySelector('.experience-card');
                const projectEl = fragment.querySelector('.experience-project');
                const dealerEl = fragment.querySelector('.experience-dealer');
                const regionEl = fragment.querySelector('.experience-region');
                const remainingEl = fragment.querySelector('.experience-remaining');
                const nextEl = fragment.querySelector('.experience-next');

                const projectInfo = PROJECT_MAP[entry.projectId] || {};
                const regionLabelParts = [];
                if (entry.macroRegion && entry.macroRegion !== '未分類') {
                    regionLabelParts.push(entry.macroRegion);
                }
                if (entry.city && entry.city !== '未分類') {
                    regionLabelParts.push(entry.city);
                }

                if (projectEl) {
                    projectEl.textContent = projectInfo.title || '任務體驗';
                }
                if (dealerEl) {
                    dealerEl.textContent = entry.dealer;
                }
                if (regionEl) {
                    regionEl.textContent = regionLabelParts.length ? regionLabelParts.join(' · ') : '地區待確認';
                }

                const initialCount = INITIAL_SLOTS_BY_EXPERIENCE[entry.key] || entry.slots.length;
                const remainingCount = entry.slots.length;
                if (remainingEl) {
                    remainingEl.textContent = `剩餘 ${remainingCount}`;
                    remainingEl.style.backgroundColor = accent;
                    remainingEl.style.color = '#ffffff';
                    if (remainingCount <= 1) {
                        remainingEl.style.backgroundColor = '#f87171';
                        remainingEl.style.color = '#7f1d1d';
                    } else if (remainingCount <= 3) {
                        remainingEl.style.backgroundColor = '#fbbf24';
                        remainingEl.style.color = '#92400e';
                    }
                }

                const sortedSlots = [...entry.slots].sort((a, b) => (a.month || '').localeCompare(b.month || ''));
                const nextSlot = sortedSlots[0];
                if (nextEl) {
                    if (nextSlot) {
                        nextEl.textContent = `最近：${formatFullMonth(nextSlot.month)}｜初始 ${initialCount}`;
                    } else {
                        nextEl.textContent = '最近：尚未開放';
                    }
                }

                if (cardRoot) {
                    cardRoot.style.borderColor = '#e5e7eb';
                    if (SELECTED_EXPERIENCE && SELECTED_EXPERIENCE.key === entry.key) {
                        cardRoot.classList.add('ring-2', 'ring-emerald-400');
                        cardRoot.style.borderColor = accent;
                    }
                    cardRoot.addEventListener('mouseenter', () => {
                        cardRoot.style.borderColor = accent;
                    });
                    cardRoot.addEventListener('mouseleave', () => {
                        const isActive = SELECTED_EXPERIENCE && SELECTED_EXPERIENCE.key === entry.key;
                        cardRoot.style.borderColor = isActive ? accent : '#e5e7eb';
                    });
                    cardRoot.addEventListener('click', () => {
                        if (SELECTED_EXPERIENCE && SELECTED_EXPERIENCE.key === entry.key) {
                            return;
                        }
                        openExperienceDetail(SELECTED_BRAND, entry);
                    });
                }

                brandAvailabilityList.appendChild(fragment);
            });
        }

        function getBrandSlots(brandName) {
            return (MOCK_SLOTS_DATA.slots || []).filter(slot => slot.brand === brandName);
        }
        function getNextSlotForBrand(brandName) {
            if (!brandName) {
                return null;
            }

            const brandSlots = getBrandSlots(brandName).slice().sort((a, b) => {
                const monthCompare = (a.month || '').localeCompare(b.month || '');
                if (monthCompare !== 0) {
                    return monthCompare;
                }
                return (a.dealer || '').localeCompare(b.dealer || '');
            });

            if (!brandSlots.length) {
                return null;
            }

            const nextSlot = brandSlots[0];
            const monthLabel = nextSlot.monthLabel || formatMonthLabel(nextSlot.month);
            if (!monthLabel) {
                return null;
            }

            return nextSlot.dealer ? `${monthLabel} · ${nextSlot.dealer}` : monthLabel;
        }

        function updateExperienceHeader() {
            const crumbs = [];

            const goHome = () => {
                SELECTED_BRAND = null;
                SELECTED_EXPERIENCE = null;
                showBrandHome();
            };

            crumbs.push({
                label: '品牌首頁',
                action: goHome
            });

            let backHandler = null;
            let backLabel = '返回品牌首頁';

            if (SELECTED_EXPERIENCE) {
                const brandName = SELECTED_EXPERIENCE.brandName;
                const projectTitle = SELECTED_EXPERIENCE.projectTitle || '任務體驗';

                if (brandName) {
                    crumbs.push({
                        label: brandName,
                        action: () => {
                            SELECTED_BRAND = brandName;
                            SELECTED_EXPERIENCE = null;
                            showBrandHome(brandName);
                        }
                    });
                }

                crumbs.push({
                    label: projectTitle,
                    isCurrent: true
                });

                backHandler = () => {
                    if (brandName) {
                        showBrandHome(brandName);
                    } else {
                        goHome();
                    }
                };
                backLabel = '返回品牌任務列表';
            }

            renderBreadcrumb(bookingBreadcrumb, crumbs);

            if (bookingBackButton) {
                if (backHandler) {
                    bookingBackButton.classList.remove('hidden');
                    bookingBackButton.textContent = backLabel;
                    bookingBackButton.onclick = backHandler;
                } else {
                    bookingBackButton.classList.add('hidden');
                    bookingBackButton.onclick = null;
                }
            }
        }

        function openExperienceDetail(brandName, experienceMeta) {
            if (!CURRENT_USER.email) {
                showPage('login');
                return;
            }

            const brandInfo = BRAND_DATA.find(brand => brand.name === brandName);
            if (!brandInfo) {
                showMessage('error', '找不到品牌資訊，請重新選擇。');
                return;
            }

            const experienceKey = experienceMeta.key
                || buildExperienceKey(brandName, experienceMeta.projectId, experienceMeta.dealer, experienceMeta.location);
            const brandSlots = getBrandSlots(brandName);
            const matchingSlots = brandSlots.filter(slot => buildExperienceKey(brandName, slot.projectId, slot.dealer, slot.location) === experienceKey);

            const primarySlot = matchingSlots[0] || null;
            const projectInfo = PROJECT_MAP[experienceMeta.projectId] || {};

            const derivedCity = primarySlot ? detectRegionFromSlot(primarySlot) : (experienceMeta.city || '未分類');
            const derivedMacro = experienceMeta.macroRegion || mapCityToRegion(derivedCity);
            const dealerName = primarySlot?.dealer || experienceMeta.dealer || '經銷據點待確認';
            const location = primarySlot?.location || experienceMeta.location || '';

            SELECTED_BRAND = brandName;
            SELECTED_EXPERIENCE = {
                key: experienceKey,
                brandName,
                projectId: experienceMeta.projectId,
                projectTitle: projectInfo.title || '任務體驗',
                dealerName,
                location,
                city: derivedCity,
                macroRegion: derivedMacro,
                accent: brandInfo.accent || '#0E3B33'
            };

            renderBrandAvailabilityList();
            updateExperienceHeader();

            showPage('booking');
            showLoading(true);
            showLoadError(null);

            setTimeout(() => {
                try {
                    const sorted = matchingSlots.slice().sort((a, b) => (a.month || '').localeCompare(b.month || ''));
                    renderExperienceDetail(SELECTED_EXPERIENCE, sorted);
                    renderExperienceSlots(sorted);
                    showLoading(false);
                } catch (error) {
                    console.error('渲染體驗資料失敗:', error);
                    showLoadError(error.message);
                    showLoading(false);
                }
            }, 400);
        }

        function renderExperienceDetail(experience, slots) {
            if (!experience) {
                return;
            }

            const projectInfo = PROJECT_MAP[experience.projectId] || {};
            const vehicle = projectInfo.vehicle || {};
            const details = projectInfo.details || {};
            const accent = experience.accent || projectInfo.brandAccent || '#0E3B33';

            if (experienceVehicleImage) {
                experienceVehicleImage.src = vehicle.image || 'https://images.unsplash.com/photo-1549921296-3b4a4f9452c6?auto=format&fit=crop&w=1200&q=80';
                experienceVehicleImage.alt = vehicle.imageAlt || `${projectInfo.title || '任務體驗'} 示意圖`;
            }
            if (experienceVehicleClass) {
                experienceVehicleClass.textContent = vehicle.segment || '車型資訊';
            }
            if (experienceTitle) {
                experienceTitle.textContent = projectInfo.title || '任務體驗';
            }
            if (experienceDealer) {
                const regionParts = [];
                if (experience.macroRegion && experience.macroRegion !== '未分類') {
                    regionParts.push(experience.macroRegion);
                }
                if (experience.city && experience.city !== '未分類') {
                    regionParts.push(experience.city);
                }
                const regionLabel = regionParts.length ? `${experience.dealerName}｜${regionParts.join(' · ')}` : experience.dealerName;
                experienceDealer.textContent = regionLabel || '';
                experienceDealer.style.color = accent;
            }
            if (experienceLocation) {
                const locationLabel = (experience.location || '').split('｜').join(' ｜ ');
                experienceLocation.textContent = locationLabel;
            }
            if (experienceUsage) {
                experienceUsage.textContent = vehicle.usage || '適合正在規劃賞車的神秘客。';
            }
            if (experienceVehicleSummary) {
                experienceVehicleSummary.textContent = vehicle.summary || projectInfo.summary || '';
            }
            if (experienceMission) {
                experienceMission.textContent = projectInfo.goal || details.focus || '請依照任務簡報完成必要的觀察與紀錄。';
            }

            if (experienceHighlights) {
                experienceHighlights.innerHTML = '';
                const highlights = Array.isArray(details.briefing) ? details.briefing : [];
                highlights.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start gap-2 text-sm text-gray-600';
                    li.innerHTML = `<span class="mt-1 h-2 w-2 rounded-full bg-emerald-500"></span><span>${item}</span>`;
                    experienceHighlights.appendChild(li);
                });
                if (!highlights.length) {
                    const li = document.createElement('li');
                    li.className = 'text-sm text-gray-500';
                    li.textContent = projectInfo.summary || '請依照任務指引完成流程。';
                    experienceHighlights.appendChild(li);
                }
            }

            if (experienceCautions) {
                experienceCautions.innerHTML = '';
                const cautions = Array.isArray(details.cautions) ? details.cautions : [];
                cautions.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start gap-2 text-sm text-gray-600';
                    li.innerHTML = `<span class="mt-1 h-2 w-2 rounded-full bg-amber-500"></span><span>${item}</span>`;
                    experienceCautions.appendChild(li);
                });
                if (!cautions.length) {
                    const li = document.createElement('li');
                    li.className = 'text-sm text-gray-500';
                    li.textContent = '請務必保持匿名身分並遵守展間禮節。';
                    experienceCautions.appendChild(li);
                }
            }

            if (experienceTrims) {
                experienceTrims.innerHTML = '';
                const trims = Array.isArray(vehicle.trims) ? vehicle.trims : [];
                trims.forEach(trim => {
                    const card = document.createElement('div');
                    card.className = 'rounded-2xl border border-gray-200 p-4 shadow-sm';
                    card.innerHTML = `
                        <p class="text-sm font-semibold text-gray-700">${trim.name || '車型'}</p>
                        <p class="text-base font-bold text-gray-900 mt-2">${trim.price || '價格待公布'}</p>
                        <p class="text-xs text-gray-500 mt-2">${trim.highlight || ''}</p>
                    `;
                    experienceTrims.appendChild(card);
                });
                if (!trims.length) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'rounded-2xl border border-dashed border-gray-300 p-4 text-sm text-gray-500';
                    placeholder.textContent = '此車型暫無建議等級資訊。';
                    experienceTrims.appendChild(placeholder);
                }
            }

            if (experienceRemainingBadge) {
                const remaining = slots.length;
                experienceRemainingBadge.textContent = `剩餘 ${remaining} 場`;
                experienceRemainingBadge.style.backgroundColor = `${accent}1a`;
                experienceRemainingBadge.style.color = accent;
                if (remaining > 0) {
                    experienceRemainingBadge.classList.remove('hidden');
                } else {
                    experienceRemainingBadge.classList.add('hidden');
                }
            }

            if (experienceNextSlot) {
                const nextSlot = slots[0];
                experienceNextSlot.textContent = nextSlot
                    ? `最近可預約：${formatFullMonth(nextSlot.month)}`
                    : '最近可預約：尚未開放';
            }

            if (experienceVehicleClass) {
                experienceVehicleClass.style.backgroundColor = `${accent}cc`;
                experienceVehicleClass.style.color = '#ffffff';
            }
        }

        function renderExperienceSlots(slots) {
            if (!slotsContainer) {
                return;
            }

            slotsContainer.innerHTML = '';

            if (!slots.length) {
                slotsContainer.classList.add('hidden');
                if (slotsEmptyState) {
                    slotsEmptyState.classList.remove('hidden');
                }
                return;
            }

            if (slotsEmptyState) {
                slotsEmptyState.classList.add('hidden');
            }

            slots.forEach(slot => {
                if (!slotItemTemplate) {
                    return;
                }
                const fragment = slotItemTemplate.content.cloneNode(true);
                const monthEl = fragment.querySelector('.slot-month');
                const detailEl = fragment.querySelector('.slot-detail');
                const bookButton = fragment.querySelector('.book-button');
                const projectInfo = PROJECT_MAP[slot.projectId] || {};
                const accent = (SELECTED_EXPERIENCE && SELECTED_EXPERIENCE.accent) || projectInfo.brandAccent || '#0E3B33';

                const monthLabel = slot.monthLabel || formatFullMonth(slot.month) || '執行月份待公布';
                if (monthEl) {
                    monthEl.textContent = monthLabel;
                }
                if (detailEl) {
                    detailEl.textContent = slot.details || projectInfo.summary || '詳情請參考任務說明。';
                }
                if (bookButton) {
                    bookButton.style.backgroundColor = accent;
                    bookButton.style.boxShadow = `0 10px 20px -12px ${accent}80`;
                    bookButton.addEventListener('click', () => openModal(slot));
                }

                slotsContainer.appendChild(fragment);
            });

            slotsContainer.classList.remove('hidden');
        }

        // 6. (流程 2) 提交預約 - [模擬模式]
        async function handleBookingSubmit(event) {
            event.preventDefault();
            const shopperEmail = document.getElementById('shopper-email').value;
            const slotID = document.getElementById('modal-slotID').value;
            
            // [安全檢查] 確保提交的 Email 是當前登入的 Email
            if (!shopperEmail || shopperEmail !== CURRENT_USER.email) {
                showMessage('error', '驗證失敗，請重新登入。');
                return;
            }

            showSubmitLoading(true);

            setTimeout(() => {
                showSubmitLoading(false);
                closeModal();
                showMessage('success', '模擬預約成功！');

                MOCK_SLOTS_DATA.slots = MOCK_SLOTS_DATA.slots.filter(
                    slot => slot.slotID !== slotID
                );

                if (SELECTED_EXPERIENCE && SELECTED_BRAND) {
                    const experienceKey = SELECTED_EXPERIENCE.key;
                    const brandName = SELECTED_EXPERIENCE.brandName || SELECTED_BRAND;
                    const projectId = SELECTED_EXPERIENCE.projectId;
                    const remainingSlots = MOCK_SLOTS_DATA.slots.filter(slot => buildExperienceKey(brandName, projectId, slot.dealer, slot.location) === experienceKey);

                    renderExperienceDetail(SELECTED_EXPERIENCE, remainingSlots);
                    renderExperienceSlots(remainingSlots);
                    updateExperienceHeader();

                    const brandInfo = BRAND_DATA.find(brand => brand.name === brandName);
                    if (brandInfo) {
                        const brandSlots = getBrandSlots(brandName);
                        renderBrandCards();
                        if (SELECTED_BRAND === brandName) {
                            renderBrandSummary(brandInfo, brandSlots);
                            renderBrandAvailabilityList();
                        }
                    } else {
                        renderBrandCards();
                    }
                } else if (SELECTED_BRAND) {
                    renderBrandCards();
                    renderBrandAvailabilityList();
                } else {
                    renderBrandCards();
                }

                renderRegionOverview();
                refreshAdminDashboardIfVisible();

            }, 1500);
        }
        
        // 7. 提交註冊表單 - [模擬模式]
        async function handleRegistrationSubmit(event) {
            event.preventDefault();

            const name = regNameInput.value.trim();
            const email = regEmailInput.value.trim();
            const password = regPasswordInput.value;
            const passwordConfirm = regPasswordConfirmInput.value;

            if (!name || !email || !password || !passwordConfirm) {
                showMessage('error', '請完整填寫所有必填欄位。');
                return;
            }

            if (password.length < 6) {
                showMessage('error', '密碼需至少 6 碼，請重新設定。');
                return;
            }

            if (password !== passwordConfirm) {
                showMessage('error', '兩次輸入的密碼不一致，請再確認。');
                return;
            }

            showRegisterLoading(true);

            setTimeout(() => {
                showRegisterLoading(false);
                showMessage('success', '模擬註冊成功！請等待管理員審核與啟用雙重驗證。');
                registrationForm.reset();

                // [關鍵] 註冊成功後，跳回「登入頁面」
                showPage('login');

            }, 1500);
        }

        // =============================================
        // UI 輔助函式
        // =============================================
        
        // 設定頁面切換
        function setupNavigation() {
            navLinkLoginPage.addEventListener('click', () => showPage('login'));
            navLinkRegisterPage.addEventListener('click', () => showPage('register'));
            navLinkBrandHome.addEventListener('click', event => {
                event.preventDefault();
                SELECTED_BRAND = null;
                SELECTED_EXPERIENCE = null;
                showBrandHome();
            });
            if (navLinkAdminDashboard) {
                navLinkAdminDashboard.addEventListener('click', event => {
                    event.preventDefault();
                    showAdminDashboard();
                });
            }
            logoutButton.addEventListener('click', handleLogout);
            loginBackButton.addEventListener('click', () => resetLoginForm({ preserveInputs: true }));
            if (brandBackButton) {
                brandBackButton.addEventListener('click', () => clearBrandSelection());
            }
        }

        function renderBreadcrumb(container, crumbs = []) {
            if (!container) {
                return;
            }

            container.innerHTML = '';

            if (!Array.isArray(crumbs) || crumbs.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');

            crumbs.forEach((crumb, index) => {
                if (index > 0) {
                    const separator = document.createElement('span');
                    separator.className = 'text-gray-300';
                    separator.textContent = '/';
                    container.appendChild(separator);
                }

                const hasAction = typeof crumb.action === 'function';
                let element;

                if (hasAction) {
                    element = document.createElement('button');
                    element.type = 'button';
                    let className = 'transition-colors text-emerald-600 hover:text-emerald-700';
                    className += crumb.isCurrent ? ' font-semibold' : ' font-medium';
                    element.className = className;
                    element.addEventListener('click', crumb.action);
                } else {
                    element = document.createElement('span');
                    element.className = crumb.isCurrent ? 'text-gray-700 font-semibold' : 'text-gray-500';
                }

                element.textContent = crumb.label || '';

                if (crumb.isCurrent) {
                    element.setAttribute('aria-current', 'page');
                }

                container.appendChild(element);
            });
        }

        function renderBreadcrumb(container, crumbs = []) {
            if (!container) {
                return;
            }

            container.innerHTML = '';

            if (!Array.isArray(crumbs) || crumbs.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');

            crumbs.forEach((crumb, index) => {
                if (index > 0) {
                    const separator = document.createElement('span');
                    separator.className = 'text-gray-300';
                    separator.textContent = '/';
                    container.appendChild(separator);
                }

                const hasAction = typeof crumb.action === 'function';
                let element;

                if (hasAction) {
                    element = document.createElement('button');
                    element.type = 'button';
                    let className = 'transition-colors text-emerald-600 hover:text-emerald-700';
                    className += crumb.isCurrent ? ' font-semibold' : ' font-medium';
                    element.className = className;
                    element.addEventListener('click', crumb.action);
                } else {
                    element = document.createElement('span');
                    element.className = crumb.isCurrent ? 'text-gray-700 font-semibold' : 'text-gray-500';
                }

                element.textContent = crumb.label || '';

                if (crumb.isCurrent) {
                    element.setAttribute('aria-current', 'page');
                }

                container.appendChild(element);
            });
        }

        // [新] 顯示指定頁面
        function showPage(pageName) {
            if (pageName === 'admin' && (!CURRENT_USER.email || CURRENT_USER.role !== 'admin')) {
                pageName = CURRENT_USER.email ? 'brand-home' : 'login';
            }
            if ((pageName === 'brand-home' || pageName === 'booking') && !CURRENT_USER.email) {
                pageName = 'login';
            }

            if (pageName === 'booking' && CURRENT_USER.email && !SELECTED_EXPERIENCE) {
                pageName = 'brand-home';
            }

            // 先隱藏所有頁面
            pageLogin.classList.add('hidden');
            pageBrandHome.classList.add('hidden');
            pageBooking.classList.add('hidden');
            pageRegister.classList.add('hidden');
            if (pageAdminDashboard) {
                pageAdminDashboard.classList.add('hidden');
            }

            // 移除所有導航連結的 active 狀態
            navLinkLoginPage.classList.remove('active');
            navLinkRegisterPage.classList.remove('active');
            navLinkBrandHome.classList.remove('active');
            if (navLinkAdminDashboard) {
                navLinkAdminDashboard.classList.remove('active');
            }

            // 顯示指定頁面
            if (pageName === 'login') {
                resetLoginForm();
                pageLogin.classList.remove('hidden');
                navLinkLoginPage.classList.add('active');
            } else if (pageName === 'register') {
                pageRegister.classList.remove('hidden');
                navLinkRegisterPage.classList.add('active');
            } else if (pageName === 'admin' && pageAdminDashboard) {
                pageAdminDashboard.classList.remove('hidden');
                if (navLinkAdminDashboard) {
                    navLinkAdminDashboard.classList.add('active');
                }
            } else if (pageName === 'brand-home') {
                pageBrandHome.classList.remove('hidden');
                navLinkBrandHome.classList.add('active');
            } else if (pageName === 'booking') {
                pageBooking.classList.remove('hidden');
                navLinkBrandHome.classList.add('active');
            }
        }
        
        // [新] 更新導航欄 UI (登入/登出時)
        function updateNavUI(isLoggedIn) {
            if (isLoggedIn) {
                navLoggedOut.classList.add('hidden');
                navLoggedIn.classList.remove('hidden');
                navLoggedIn.classList.add('flex');
                const roleLabel = CURRENT_USER.role === 'admin' ? '（管理員）' : '';
                welcomeMessage.textContent = `歡迎, ${CURRENT_USER.name}${roleLabel}`;
                if (navLinkAdminDashboard) {
                    if (CURRENT_USER.role === 'admin') {
                        navLinkAdminDashboard.classList.remove('hidden');
                    } else {
                        navLinkAdminDashboard.classList.add('hidden');
                    }
                }
                if (navLinkBrandHome) {
                    navLinkBrandHome.classList.remove('hidden');
                }
            } else {
                navLoggedOut.classList.remove('hidden');
                navLoggedIn.classList.add('hidden');
                navLoggedIn.classList.remove('flex');
                welcomeMessage.textContent = '';
                if (navLinkAdminDashboard) {
                    navLinkAdminDashboard.classList.add('hidden');
                }
                if (navLinkBrandHome) {
                    navLinkBrandHome.classList.remove('hidden');
                }
            }
        }

        function resetLoginForm(options = {}) {
            const { preserveInputs = false } = options;
            pendingUser = null;
            loginErrorContainer.classList.add('hidden');

            if (!preserveInputs) {
                loginForm.reset();
            } else {
                loginOtpInput.value = '';
            }

            setLoginStep(1);
            showLoginLoading(false);
        }

        function setLoginStep(step) {
            loginStep = step;

            if (loginStep === 1) {
                loginStepOneContainer.classList.remove('hidden');
                loginStepTwoContainer.classList.add('hidden');
                loginEmailInput.removeAttribute('disabled');
                loginPasswordInput.removeAttribute('disabled');
                loginBackButton.classList.add('hidden');
                loginBackButton.classList.remove('block');
                loginOtpInput.value = '';
                loginOtpInput.setAttribute('disabled', 'true');
                twoFactorHint.textContent = '';
                loginStepTwoMessage.textContent = '';
            } else {
                loginStepOneContainer.classList.add('hidden');
                loginStepTwoContainer.classList.remove('hidden');
                loginEmailInput.setAttribute('disabled', 'true');
                loginPasswordInput.setAttribute('disabled', 'true');
                loginBackButton.classList.remove('hidden');
                loginBackButton.classList.add('block');
                loginOtpInput.removeAttribute('disabled');
                loginOtpInput.focus();
            }

            loginSubmitText.textContent = loginStep === 1 ? '下一步' : '確認登入';
        }

        // 顯示/隱藏 全頁載入中
        function showLoading(isLoading) {
            if (isLoading) {
                loadingContainer.classList.remove('hidden');
                loadingContainer.classList.add('flex');
                slotsContainer.classList.add('hidden');
                if (slotsEmptyState) {
                    slotsEmptyState.classList.add('hidden');
                }
            } else {
                loadingContainer.classList.add('hidden');
                loadingContainer.classList.remove('flex');
            }
        }
        
        // 顯示載入錯誤
        function showLoadError(message) {
            if (message) {
                errorMessage.textContent = message;
                errorContainer.classList.remove('hidden');
            } else {
                errorContainer.classList.add('hidden');
            }
        }

        // 開啟 Modal
        function openModal(slot) {
            const projectInfo = PROJECT_MAP[slot.projectId] || {};
            document.getElementById('modal-project').textContent = projectInfo.title || slot.projectId || '';
            document.getElementById('modal-dealer').textContent = slot.dealer || '經銷商資訊待公布';
            document.getElementById('modal-location').textContent = slot.location || '';
            document.getElementById('modal-month').textContent = slot.monthLabel || formatMonthLabel(slot.month) || '';
            document.getElementById('modal-details').textContent = slot.details || projectInfo.summary || '';
            document.getElementById('modal-slotID').value = slot.slotID;
            
            // [關鍵] 自動帶入已登入的 Email
            document.getElementById('shopper-email').value = CURRENT_USER.email;
            
            // bookingForm.reset() 會清掉 email，所以我們手動重設
            
            bookingModal.classList.remove('hidden');
            setTimeout(() => {
                modalCard.classList.remove('scale-95');
            }, 10);
        }

        // 關閉 Modal
        function closeModal() {
            modalCard.classList.add('scale-95');
            setTimeout(() => {
                bookingModal.classList.add('hidden');
            }, 200);
        }

        // 顯示/隱藏 登入按鈕的載入動畫
        function showLoginLoading(isLoading) {
            if (isLoading) {
                loginSubmitButton.disabled = true;
                loginSubmitLoader.classList.remove('hidden');
                loginSubmitText.textContent = "驗證中...";
            } else {
                loginSubmitButton.disabled = false;
                loginSubmitLoader.classList.add('hidden');
                loginSubmitText.textContent = loginStep === 1 ? "下一步" : "確認登入";
            }
        }
        
        // 顯示/隱藏 預約按鈕的載入動畫
        function showSubmitLoading(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                submitLoader.classList.remove('hidden');
                submitText.textContent = "處理中...";
            } else {
                submitButton.disabled = false;
                submitLoader.classList.add('hidden');
                submitText.textContent = "確認送出預約";
            }
        }
        
        // 顯示/隱藏 註冊按鈕的載入動畫
        function showRegisterLoading(isLoading) {
            if (isLoading) {
                regSubmitButton.disabled = true;
                regSubmitLoader.classList.remove('hidden');
                regSubmitText.textContent = "傳送中...";
            } else {
                regSubmitButton.disabled = false;
                regSubmitLoader.classList.add('hidden');
                regSubmitText.textContent = "送出註冊申請";
            }
        }

        // 顯示右上角訊息提示
        function showMessage(type, message) {
            if (messageTimer) clearTimeout(messageTimer);
            messageText.textContent = message;
            
            if (type === 'success') {
                messageContent.classList.remove('bg-red-500');
                messageContent.classList.add('bg-green-500');
                iconSuccess.classList.remove('hidden');
                iconError.classList.add('hidden');
            } else {
                messageContent.classList.remove('bg-green-500');
                messageContent.classList.add('bg-red-500');
                iconSuccess.classList.add('hidden');
                iconError.classList.remove('hidden');
            }
            
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.remove('opacity-0'); 
            }, 10);

            messageTimer = setTimeout(() => {
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 4000); 
        }
        
        // 點擊 Modal 外部區域也可關閉
        bookingModal.addEventListener('click', (event) => {
            if (event.target === bookingModal) {
                closeModal();
            }
        });

        function renderAdminDashboard() {
            if (!pageAdminDashboard || CURRENT_USER.role !== 'admin') {
                return;
            }

            const totalBrands = BRAND_DATA.length;
            const totalProjects = BRAND_DATA.reduce((count, brand) => count + ((BRAND_PROJECTS[brand.name] || []).length), 0);
            const openSlotsCount = (MOCK_SLOTS_DATA.slots || []).length;
            const bookedCount = Math.max(TOTAL_INITIAL_SLOTS - openSlotsCount, 0);
            const utilizationRate = TOTAL_INITIAL_SLOTS > 0 ? Math.round((bookedCount / TOTAL_INITIAL_SLOTS) * 100) : 0;

            if (adminTotalBrands) {
                adminTotalBrands.textContent = totalBrands;
            }
            if (adminTotalProjects) {
                adminTotalProjects.textContent = totalProjects;
            }
            if (adminOpenSlots) {
                adminOpenSlots.textContent = openSlotsCount;
            }
            if (adminUtilizationRate) {
                adminUtilizationRate.textContent = `${utilizationRate}%`;
            }

            renderAdminBrandTable();
            renderAdminUpcomingSlots();
            renderAdminMonthlySummary();
            renderAdminBrandDetail();
        }

        function renderAdminBrandTable() {
            if (!adminBrandTableBody) {
                return;
            }

            adminBrandTableBody.innerHTML = '';

            let hasData = false;
            BRAND_DATA.forEach(brand => {
                const projects = BRAND_PROJECTS[brand.name] || [];
                const remainingSlots = getBrandSlots(brand.name);
                const nextSlot = getNextSlotForBrand(brand.name);

                const row = document.createElement('tr');
                row.className = 'admin-brand-row border-b border-gray-100 last:border-0';
                row.innerHTML = `
                    <td class="py-3 px-4 font-semibold text-gray-700">${brand.name}</td>
                    <td class="py-3 px-4 text-gray-600">${projects.length}</td>
                    <td class="py-3 px-4 text-gray-600">${remainingSlots.length}</td>
                    <td class="py-3 px-4 text-gray-600">${nextSlot || '尚未開放'}</td>
                `;
                row.tabIndex = 0;
                row.addEventListener('click', () => openAdminBrandDetail(brand.name));
                row.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        openAdminBrandDetail(brand.name);
                    }
                });
                if (ADMIN_SELECTED_BRAND === brand.name) {
                    row.classList.add('active');
                }
                adminBrandTableBody.appendChild(row);
                hasData = true;
            });

            if (adminBrandTableEmpty) {
                if (hasData) {
                    adminBrandTableEmpty.classList.add('hidden');
                } else {
                    adminBrandTableEmpty.classList.remove('hidden');
                }
            }
        }

        function renderAdminUpcomingSlots() {
            if (!adminUpcomingList) {
                return;
            }

            adminUpcomingList.innerHTML = '';
            const slots = [...(MOCK_SLOTS_DATA.slots || [])];
            slots.sort((a, b) => {
                const monthCompare = (a.month || '').localeCompare(b.month || '');
                if (monthCompare !== 0) {
                    return monthCompare;
                }
                return (a.dealer || '').localeCompare(b.dealer || '');
            });

            const upcoming = slots.slice(0, 6);

            if (upcoming.length === 0) {
                if (adminUpcomingEmpty) {
                    adminUpcomingEmpty.classList.remove('hidden');
                }
                return;
            }

            if (adminUpcomingEmpty) {
                adminUpcomingEmpty.classList.add('hidden');
            }

            upcoming.forEach(slot => {
                const projectInfo = PROJECT_MAP[slot.projectId] || {};
                const listItem = document.createElement('li');
                listItem.className = 'border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow';
                listItem.innerHTML = `
                    <p class="text-sm font-semibold text-gray-700">${slot.brand}｜${projectInfo.title || slot.projectId}</p>
                    <p class="text-xs text-gray-500 mt-1">${slot.dealer || '經銷據點待確認'}</p>
                    <div class="flex items-center justify-between mt-3 text-xs text-gray-500">
                        <span>${formatFullMonth(slot.month)}</span>
                        <span>${slot.location || ''}</span>
                    </div>
                `;
                adminUpcomingList.appendChild(listItem);
            });
        }

        function renderAdminMonthlySummary() {
            if (!adminMonthlySummary) {
                return;
            }

            adminMonthlySummary.innerHTML = '';
            const monthlyCounts = {};
            (MOCK_SLOTS_DATA.slots || []).forEach(slot => {
                const key = slot.month || '未設定';
                monthlyCounts[key] = (monthlyCounts[key] || 0) + 1;
            });

            const entries = Object.entries(monthlyCounts).sort((a, b) => a[0].localeCompare(b[0]));

            if (entries.length === 0) {
                if (adminMonthlyEmpty) {
                    adminMonthlyEmpty.classList.remove('hidden');
                }
                return;
            }

            if (adminMonthlyEmpty) {
                adminMonthlyEmpty.classList.add('hidden');
            }

            entries.forEach(([monthKey, count]) => {
                const item = document.createElement('li');
                item.className = 'flex items-center justify-between px-3 py-2 bg-gray-50 rounded-xl';
                const label = monthKey === '未設定' ? '月份待確認' : formatFullMonth(monthKey);
                item.innerHTML = `
                    <span class="text-sm text-gray-600">${label}</span>
                    <span class="text-sm font-semibold text-gray-800">${count} 件</span>
                `;
                adminMonthlySummary.appendChild(item);
            });
        }


        function buildAdminBrandDetail(brandName) {
            const brandInfo = BRAND_DATA.find(brand => brand.name === brandName);
            if (!brandInfo) {
                return null;
            }

            const initialSlots = INITIAL_SLOTS.filter(slot => slot.brand === brandName);
            const remainingSlots = getBrandSlots(brandName);
            const initialCount = initialSlots.length;
            const remainingCount = remainingSlots.length;
            const bookedCount = Math.max(initialCount - remainingCount, 0);
            const utilization = initialCount > 0 ? Math.round((bookedCount / initialCount) * 100) : 0;
            const nextSlot = getNextSlotForBrand(brandName);

            const regionTotals = {};
            remainingSlots.forEach(slot => {
                const region = detectRegionFromSlot(slot);
                regionTotals[region] = (regionTotals[region] || 0) + 1;
            });
            const regionStats = Object.entries(regionTotals)
                .sort((a, b) => b[1] - a[1])
                .map(([region, count]) => ({
                    region: region === '未分類' ? '地區待確認' : region,
                    remaining: count,
                    share: remainingCount > 0 ? Math.round((count / remainingCount) * 100) : 0
                }));

            const dealerMap = new Map();
            remainingSlots.forEach(slot => {
                const key = slot.dealer || slot.location || slot.slotID;
                if (!dealerMap.has(key)) {
                    dealerMap.set(key, {
                        dealer: slot.dealer || '經銷據點待確認',
                        location: slot.location || '',
                        region: detectRegionFromSlot(slot),
                        slots: []
                    });
                }
                dealerMap.get(key).slots.push(slot);
            });
            const dealerStats = Array.from(dealerMap.values())
                .sort((a, b) => b.slots.length - a.slots.length)
                .map(entry => {
                    const initialKey = `${brandName}||${entry.dealer}`;
                    const initial = INITIAL_SLOTS_BY_DEALER[initialKey] || entry.slots.length;
                    const sorted = [...entry.slots].sort((a, b) => (a.month || '').localeCompare(b.month || ''));
                    const next = sorted[0] ? formatFullMonth(sorted[0].month) : '尚未開放';
                    return {
                        dealer: entry.dealer,
                        region: entry.region === '未分類' ? '地區待確認' : entry.region,
                        remaining: entry.slots.length,
                        initial,
                        next
                    };
                });

            const projects = (BRAND_PROJECTS[brandName] || []).map(project => {
                const initial = INITIAL_SLOTS_BY_PROJECT[project.id] || 0;
                const projectSlots = remainingSlots.filter(slot => slot.projectId === project.id);
                const remaining = projectSlots.length;
                const booked = Math.max(initial - remaining, 0);
                const nextProjectSlot = [...projectSlots].sort((a, b) => (a.month || '').localeCompare(b.month || ''))[0];
                return {
                    id: project.id,
                    title: project.title,
                    category: project.category,
                    remaining,
                    initial,
                    booked,
                    next: nextProjectSlot ? formatFullMonth(nextProjectSlot.month) : '尚未開放',
                    accent: project.brandAccent || brandInfo.accent || '#0E3B33'
                };
            });

            return {
                brandName,
                description: brandInfo.description,
                accent: brandInfo.accent || '#0E3B33',
                remainingCount,
                initialCount,
                bookedCount,
                utilization,
                nextSlot,
                regionStats,
                dealerStats,
                projects
            };
        }

        function openAdminBrandDetail(brandName) {
            ADMIN_SELECTED_BRAND = brandName;
            renderAdminBrandDetail();
            renderAdminBrandTable();
            if (adminBrandDetailSection) {
                adminBrandDetailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function closeAdminBrandDetail() {
            ADMIN_SELECTED_BRAND = null;
            renderAdminBrandDetail();
            renderAdminBrandTable();
        }

        function renderAdminBrandDetail() {
            if (!adminBrandDetailSection) {
                return;
            }

            if (!ADMIN_SELECTED_BRAND) {
                adminBrandDetailSection.classList.add('hidden');
                return;
            }

            const detail = buildAdminBrandDetail(ADMIN_SELECTED_BRAND);
            if (!detail) {
                adminBrandDetailSection.classList.add('hidden');
                return;
            }

            adminBrandDetailSection.classList.remove('hidden');
            if (adminBrandDetailCard) {
                adminBrandDetailCard.style.borderTopColor = detail.accent;
            }
            if (adminBrandDetailBreadcrumb) {
                adminBrandDetailBreadcrumb.textContent = `管理儀表板 / ${detail.brandName}`;
            }
            if (adminBrandDetailTitle) {
                adminBrandDetailTitle.textContent = `${detail.brandName} 品牌詳情`;
            }
            if (adminBrandDetailDescription) {
                adminBrandDetailDescription.textContent = detail.description || '目前尚無品牌描述。';
            }
            if (adminBrandDetailRemaining) {
                adminBrandDetailRemaining.textContent = detail.remainingCount;
            }
            if (adminBrandDetailBooked) {
                adminBrandDetailBooked.textContent = detail.bookedCount;
            }
            if (adminBrandDetailUtilization) {
                adminBrandDetailUtilization.textContent = `${detail.utilization}%`;
            }
            if (adminBrandDetailNext) {
                adminBrandDetailNext.textContent = detail.nextSlot || '尚未開放';
            }

            if (adminBrandDetailProjects) {
                adminBrandDetailProjects.innerHTML = '';
                if (!detail.projects.length) {
                    adminBrandDetailProjectsEmpty && adminBrandDetailProjectsEmpty.classList.remove('hidden');
                } else {
                    adminBrandDetailProjectsEmpty && adminBrandDetailProjectsEmpty.classList.add('hidden');
                    detail.projects.forEach(project => {
                        const card = document.createElement('div');
                        card.className = 'border border-gray-100 rounded-2xl p-4 shadow-sm';
                        card.style.borderTop = `4px solid ${project.accent}`;
                        card.innerHTML = `
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">${project.category}</p>
                            <h4 class="text-lg font-bold text-gray-900 mt-1">${project.title}</h4>
                            <p class="text-sm text-gray-600 mt-2">剩餘 ${project.remaining} / 初始 ${project.initial}</p>
                            <p class="text-xs text-gray-500 mt-1">已預約 ${project.booked} 件｜最近可預約：${project.next}</p>
                        `;
                        adminBrandDetailProjects.appendChild(card);
                    });
                }
            }

            if (adminBrandDetailRegionBody) {
                adminBrandDetailRegionBody.innerHTML = '';
                if (!detail.regionStats.length) {
                    adminBrandDetailRegionEmpty && adminBrandDetailRegionEmpty.classList.remove('hidden');
                } else {
                    adminBrandDetailRegionEmpty && adminBrandDetailRegionEmpty.classList.add('hidden');
                    detail.regionStats.forEach(stat => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="py-2 px-4 text-sm text-gray-700">${stat.region}</td>
                            <td class="py-2 px-4 text-sm text-gray-600">${stat.remaining}</td>
                            <td class="py-2 px-4 text-sm text-gray-600">${stat.share}%</td>
                        `;
                        adminBrandDetailRegionBody.appendChild(row);
                    });
                }
            }

            if (adminBrandDetailDealerBody) {
                adminBrandDetailDealerBody.innerHTML = '';
                if (!detail.dealerStats.length) {
                    adminBrandDetailDealerEmpty && adminBrandDetailDealerEmpty.classList.remove('hidden');
                } else {
                    adminBrandDetailDealerEmpty && adminBrandDetailDealerEmpty.classList.add('hidden');
                    detail.dealerStats.forEach(dealer => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="py-2 px-4 text-sm text-gray-700">${dealer.dealer}</td>
                            <td class="py-2 px-4 text-sm text-gray-600">${dealer.region}</td>
                            <td class="py-2 px-4 text-sm text-gray-600">${dealer.remaining} / ${dealer.initial}</td>
                            <td class="py-2 px-4 text-sm text-gray-600">${dealer.next}</td>
                        `;
                        adminBrandDetailDealerBody.appendChild(row);
                    });
                }
            }
        }
        function refreshAdminDashboardIfVisible() {
            if (pageAdminDashboard && !pageAdminDashboard.classList.contains('hidden')) {
                renderAdminDashboard();
                renderAdminBrandDetail();
            }
        }

    </script>
</body>
</html>
